name: CI - Proyecto Reeva

on:
  push:
    branches:
      - "**"

jobs:

  aws-cognito-ci:
    name: CI - aws-cognito-jwt-login
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: aws-cognito-jwt-login
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: aws-cognito-jwt-login/package-lock.json

      - name: Instalar dependencias
        run: npm install

      - name: Auditoría de seguridad (no rompe CI)
        run: npm audit --production || echo "audit OK (warnings ignorados)"

      - name: Validar JSON
        run: |
          echo "Validando JSON..."
          find . -name "*.json" -not -path "*/node_modules/*" -exec jq empty {} \; || true

      - name: Lint básico (no rompe CI)
        run: |
          echo "Revisando sintaxis JS..."
          npx eslint . || echo "eslint OK (warnings ignorados)"

      - name: Cognito CI completado
        run: echo "CI Cognito finalizado correctamente"


  dynamo-ci:
    name: CI - serverless-dynamo
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Reeva_node/serverless-dynamo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: Reeva_node/serverless-dynamo/package-lock.json

      - name: Instalar dependencias
        run: npm install

      - name: Auditoría de seguridad (sin romper CI)
        run: npm audit --production || echo "audit OK (warnings ignorados)"

      - name: Validar estructura
        run: |
          echo "Estructura del proyecto:"
          ls -R .

      - name: Dynamo CI completado
        run: echo "CI Dynamo finalizado correctamente"


  reeva-ci:
    name: CI - Reeva_node (Express)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Reeva_node

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: Reeva_node/package-lock.json

      - name: Instalar dependencias
        run: npm install

      - name: Validar JSON
        run: |
          echo "Validando JSON..."
          find . -name "*.json" -not -path "*/node_modules/*" -exec jq empty {} \; || true

      - name: Auditoría de seguridad (sin romper CI)
        run: npm audit --production || echo "audit OK (warnings ignorados)"

      - name: Revisar sintaxis JS (no rompe CI)
        run: |
          echo "Revisando sintaxis JS..."
          find . -name "*.js" -not -path "*/node_modules/*" -exec node -c {} \; || true

      - name: Express CI completado
        run: echo "CI Express finalizado correctamente"
