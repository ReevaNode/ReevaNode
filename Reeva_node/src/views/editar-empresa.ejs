<!DOCTYPE html>
<html lang="<%= userLang || 'es' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/theme-flash-prevent.css" />
  <title>Editar <%= empresa.nombre %> </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/editar-empresa.css">
</head>
<body class="font-sans min-h-screen flex flex-col">
  <%- include('header') %>
  
  <div class="editar-container">
    <!-- Header -->
    <div class="header-editar">
      <div>
        <h1><%= empresa.nombre %></h1>
        <p style="color: #999; margin: 0.5rem 0 0; font-size: 0.95rem;">
          <%= empresa.nombreNivel1 %> • <%= empresa.nombreNivel2 %> • <%= empresa.nombreNivel3 %><% if (empresa.nombreNivel4) { %> • <%= empresa.nombreNivel4 %><% } %>
        </p>
      </div>
      <a href="javascript:history.back()" class="btn-volver">
        <i class="ri-arrow-left-line"></i>
        <%= __("editCompany.back") %>
      </a>
    </div>

    <!-- Tabs/Pestañas -->
    <div class="tabs-container">
      <button class="tab-button active" onclick="cambiarTab('salas')">
        <i class="ri-layout-grid-line"></i>
        <%= __("editCompany.structure") %>
      </button>
      <button class="tab-button" onclick="cambiarTab('ocupantes')">
        <i class="ri-user-line"></i>
        <%= __("editCompany.occupants") %>
      </button>
      <% if (empresa.nombreNivel4) { %>
      <button class="tab-button" onclick="cambiarTab('elementos')">
        <i class="ri-checkbox-multiple-line"></i>
        <%= __("editCompany.elements") %>
      </button>
      <% } %>
    </div>

    <!-- CONTENIDO TABS -->

    <!-- TAB: ESPACIOS Y MESAS -->
    <div id="tab-salas" class="tab-content active">
      <div class="seccion-editar">
        <div id="espacios-lista-editar"></div>

        <button class="btn-agregar-espacio" onclick="agregarEspacio()">
          <i class="ri-add-line"></i>
          <%= __("editCompany.addStructure").replace("{nivel1}", empresa.nombreNivel1.toLowerCase()) %>
        </button>
      </div>
    </div>

    <!-- TAB: OCUPANTES -->
    <div id="tab-ocupantes" class="tab-content">
      <div class="seccion-editar">
        <div class="ocupantes-input-wrapper">
          <input 
            type="text" 
            id="nuevo-ocupante-editar"
            placeholder="<%= __("editCompany.addPlaceholder") %>"
          >
          <button type="button" class="btn-agregar-ocupante-editar" onclick="agregarOcupanteEditar()">
            <i class="ri-add-line"></i>
          </button>
        </div>

        <div id="ocupantes-lista-editar"></div>
      </div>
    </div>

    <!-- TAB: ELEMENTOS/ITEMS -->
    <% if (empresa.nombreNivel4) { %>
    <div id="tab-elementos" class="tab-content">
      <div class="seccion-editar">
        <div class="elementos-input-wrapper">
          <input 
            type="text" 
            id="nuevo-elemento-editar"
            placeholder="<%= __("editCompany.elementPlaceholder") %>"
          >
          <button type="button" class="btn-agregar-elemento-editar" onclick="agregarElementoEditar()">
            <i class="ri-add-line"></i>
          </button>
        </div>

        <div id="elementos-lista-editar"></div>
      </div>
    </div>
    <% } %>

  </div>

  <script>
    const empresaId = '<%= empresa.empresaId %>';
    const empresa = <%- JSON.stringify(empresa) %>;
    const idToken = '<%= idToken %>';

    // Asegurar que ocupantes es un array
    if (!empresa.ocupantes) {
      empresa.ocupantes = [];
    }
    if (!empresa.items) {
      empresa.items = [];
    }
    if (!empresa.espacios) {
      empresa.espacios = [];
    }

    const espaciosUnicos = {};
    for (const espacio of empresa.espacios) {
      if (!espaciosUnicos[espacio.espacioId]) {
        espaciosUnicos[espacio.espacioId] = espacio;
      }
    }
    empresa.espacios = Object.values(espaciosUnicos);
    // Normalizar capacidad en mesas
    empresa.espacios.forEach(esp => {
      if (Array.isArray(esp.mesas)) {
        esp.mesas = esp.mesas.map(m => ({ ...m, capacidad: Number(m.capacidad) > 0 ? Number(m.capacidad) : 1 }));
      } else {
        esp.mesas = [];
      }
    });

    const ocupantesUnicos = {};
    for (const ocupante of empresa.ocupantes) {
      if (!ocupantesUnicos[ocupante.ocupanteId]) {
        ocupantesUnicos[ocupante.ocupanteId] = ocupante;
      }
    }
    empresa.ocupantes = Object.values(ocupantesUnicos);

    const itemsUnicos = {};
    for (const item of empresa.items) {
      if (!itemsUnicos[item.itemId]) {
        itemsUnicos[item.itemId] = item;
      }
    }
    empresa.items = Object.values(itemsUnicos);

    console.log('Datos iniciales cargados:', {
      empresaId: empresa.empresaId,
      nombre: empresa.nombre,
      espacios: empresa.espacios ? empresa.espacios.length : 0,
      ocupantes: empresa.ocupantes ? empresa.ocupantes.length : 0,
      items: empresa.items ? empresa.items.length : 0
    });
    console.log('Espacios completos:', empresa.espacios);
    console.log('Ocupantes completos:', empresa.ocupantes);
    console.log('Items completos:', empresa.items);

    // Textos i18n para usar en funciones
    const i18nTexts = {
      delete: '<%- __("editCompany.delete") %>',
      clickToAdd: '<%- __("editCompany.clickToAdd") %>',
      noOccupants: '<%- __("editCompany.noOccupants") %>',
      clickToPlusOccupant: '<%- __("editCompany.clickToPlusOccupant") %>',
      noElements: '<%- __("editCompany.noElements") %>',
      clickToPlusElement: '<%- __("editCompany.clickToPlusElement") %>',
      deleteOccupant: '<%- __("editCompany.deleteOccupant") %>',
      requireName: '<%- __("editCompany.requireName") %>',
      requireNameLevel1: '<%- __("editCompany.requireNameLevel1") %>'
    };

    // ===== INICIALIZAR =====
    document.addEventListener('DOMContentLoaded', () => {
      renderizarEspacios();
      renderizarOcupantes();
      <% if (empresa.nombreNivel4) { %>
      renderizarElementos();
      <% } %>
    });

    // ===== FUNCIÓN PARA CAMBIAR TABS =====
    function cambiarTab(tabName) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.remove('active'));

      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));

      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.closest('.tab-button').classList.add('active');
    }

    // ===== RENDERIZAR ESPACIOS DINÁMICAMENTE =====
    function renderizarEspacios() {
      const container = document.getElementById('espacios-lista-editar');
      const nombreNivel1 = empresa.nombreNivel1 || 'Nivel 1';
      const nombreNivel2 = empresa.nombreNivel2 || 'Box';

      if (!empresa.espacios || empresa.espacios.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="ri-inbox-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
            <p style="font-size: 15px; font-weight: 600;">No hay ${nombreNivel1} configurados</p>
                <p style="font-size: 13px; margin-top: 8px;">${i18nTexts.clickToAdd}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = empresa.espacios.map((espacio, espacioIdx) => `
        <div class="espacio-card">
          <div class="espacio-header">
            <div class="espacio-titulo-editable">
              <div class="espacio-numero">${espacioIdx + 1}</div>
              <input 
                type="text" 
                class="espacio-nombre-input"
                placeholder="Nombre del ${nombreNivel1}..." 
                value="${espacio.pasilloNombre}"
                onchange="actualizarNombreEspacio('${espacio.espacioId}', this.value)"
              >
              <button class="btn-editar-nombre" title="Editar nombre">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </div>
            <button 
              class=\"btn-eliminar-espacio\" 
              onclick=\"eliminarEspacio('${espacio.espacioId}')\"
            >
              <i class=\"fas fa-trash\"></i>
              ${i18nTexts.delete}
            </button>
          </div>

          <div class="mesas-section">
            ${espacio.mesas && espacio.mesas.length > 0 ? `
              <div class="mesas-grid">
                ${espacio.mesas.map((mesa, mesaIdx) => `
                  <div class="mesa-card">
                    <button 
                      class="btn-eliminar-mesa" 
                      onclick="eliminarMesa('${espacio.espacioId}', '${mesa.id}')"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                    <div class="mesa-numero-badge">${mesaIdx + 1}</div>
                    <input 
                      type="text" 
                      placeholder="${nombreNivel2}..." 
                      value="${mesa.nombre}"
                      onblur="if(this.value.trim()) actualizarNombreMesa('${espacio.espacioId}', '${mesa.id}', this.value)"
                    >
                    <div class="mesa-capacidad-input">
                      <i class="ri-user-line"></i>
                      <input 
                        type="number" 
                        min="1" 
                        value="${mesa.capacidad || 1}"
                        onblur="actualizarCapacidadMesa('${espacio.espacioId}', '${mesa.id}', this.value)"
                        aria-label="Capacidad máxima"
                      >
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <button 
              class="btn-agregar-mesa" 
              onclick="agregarMesa('${espacio.espacioId}')"
            >
              <i class="fas fa-plus"></i>
              <%= __("editCompany.addLevel2").replace("{nivel2}", empresa.nombreNivel2) %>
            </button>
          </div>
        </div>
      `).join('');
    }

    function mostrarFormularioEspacioVacio() {
      const container = document.getElementById('espacios-lista-editar');
      const nombreNivel1 = empresa.nombreNivel1 || 'Nivel 1';
      const nombreNivel2 = empresa.nombreNivel2 || 'Box';
      
      // Determinar si es femenino
      const esFemenino = nombreNivel1.toLowerCase().endsWith('a');
      const articulo = esFemenino ? 'Nueva' : 'Nuevo';

      // Crear un div temporal para el nuevo espacio
      const nuevoEspacioDiv = document.createElement('div');
      nuevoEspacioDiv.className = 'espacio-form-wrapper';
      nuevoEspacioDiv.innerHTML = `
        <div class="espacio-form">
          <h4>${articulo} ${nombreNivel1}</h4>
          <div class="espacio-form-input">
            <input 
              type="text" 
              id="nuevo-espacio-nombre"
              placeholder="Nombre ${nombreNivel1}..."
              autofocus
            >
            <button class="btn-confirmar-espacio" onclick="confirmarNuevoEspacio()">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn-cancelar-espacio" onclick="cancelarNuevoEspacio()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;

      // Si hay espacios, agregarlo al final del contenedor
      if (empresa.espacios && empresa.espacios.length > 0) {
        container.appendChild(nuevoEspacioDiv);
      } else {
        // Si no hay espacios, limpiar y mostrar solo el formulario
        container.innerHTML = nuevoEspacioDiv.innerHTML;
      }

      // Enfocar el input automáticamente
      setTimeout(() => {
        const input = document.getElementById('nuevo-espacio-nombre');
        if (input) input.focus();
      }, 100);
    }

    function confirmarNuevoEspacio() {
      const input = document.getElementById('nuevo-espacio-nombre');
      const nombre = input?.value.trim();

      if (!nombre) {
        const msg = i18nTexts.requireNameLevel1.replace('{nivel1}', empresa.nombreNivel1.toLowerCase());
        alert(msg);
        return;
      }

      // Guardar en BD
      fetch(`/api/empresas/${empresaId}/espacios`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pasilloNombre: nombre,
          mesas: []
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.espacioId) {
          const nuevoEspacio = {
            espacioId: data.espacioId,
            pasilloNombre: nombre,
            mesas: []
          };
          empresa.espacios.push(nuevoEspacio);
          renderizarEspacios();
          console.log('Espacio agregado:', data.espacioId);
        } else {
          alert('Error al agregar ' + empresa.nombreNivel1.toLowerCase());
          console.error('Error respuesta:', data);
        }
      })
      .catch(err => {
        console.error('Error al agregar espacio:', err);
        alert('Error al agregar ' + empresa.nombreNivel1.toLowerCase());
      });
    }

    function cancelarNuevoEspacio() {
      renderizarEspacios();
    }

    // ===== ESPACIOS =====
    function agregarEspacio() {
      // Mostrar formulario vacío para que el usuario escriba el nombre
      mostrarFormularioEspacioVacio();
    }

    function eliminarEspacio(espacioId) {
      const confirmMsg = '<%= __("editCompany.confirmDeleteLevel1") %>'.replace('{nivel1}', empresa.nombreNivel1.toLowerCase());
      const errorMsg = '<%= __("editCompany.errorDeleteLevel1") %>'.replace('{nivel1}', empresa.nombreNivel1.toLowerCase());
      
      if (confirm(confirmMsg)) {
        fetch(`/api/empresas/${empresaId}/espacios/${espacioId}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            empresa.espacios = empresa.espacios.filter(e => e.espacioId !== espacioId);
            renderizarEspacios();
            console.log('Espacio eliminado:', espacioId);
          } else {
            alert(errorMsg);
            console.error('Error respuesta:', data);
          }
        })
        .catch(err => {
          console.error('Error al eliminar espacio:', err);
          alert(errorMsg);
        });
      }
    }

    function actualizarNombreEspacio(espacioId, nuevoNombre) {
      if (!nuevoNombre || !nuevoNombre.trim()) {
        alert(`El ${empresa.nombreNivel1.toLowerCase()} debe tener un nombre`);
        return;
      }

      const espacio = empresa.espacios.find(e => e.espacioId === espacioId);
      if (!espacio) return;

      // Validar que todas las mesas tengan nombre
      if (espacio.mesas && espacio.mesas.length > 0) {
        const mesasSinNombre = espacio.mesas.filter(m => !m.nombre || !m.nombre.trim());
        if (mesasSinNombre.length > 0) {
          alert(`Todas las ${empresa.nombreNivel2.toLowerCase()} deben tener un nombre antes de guardar`);
          return;
        }
      }

      const payload = {
        espacioId: espacioId,
        pasilloNombre: nuevoNombre.trim(),
        mesas: espacio.mesas
      };

      fetch(`/api/empresas/${empresaId}/espacios`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          espacio.pasilloNombre = nuevoNombre.trim();
          renderizarEspacios();
          console.log('Espacio actualizado:', espacioId);
        } else {
          alert('Error al actualizar ' + empresa.nombreNivel1.toLowerCase());
          console.error('Error respuesta:', data);
        }
      })
      .catch(err => {
        console.error('Error al actualizar espacio:', err);
        alert('Error al actualizar ' + empresa.nombreNivel1.toLowerCase());
      });
    }

    // ===== MESAS (Nivel2)=====
    function agregarMesa(espacioId) {
      const espacio = empresa.espacios.find(e => e.espacioId === espacioId);
      if (!espacio) return;

      const nuevaMesa = {
        id: `mesa-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        nombre: '', // Vacía, el usuario escribirá el nombre
        capacidad: 1
      };

      espacio.mesas.push(nuevaMesa);
      renderizarEspacios();

      // Enfocar el input de la nueva mesa para que el usuario escriba de inmediato
      setTimeout(() => {
        const inputs = document.querySelectorAll('.mesa-card input');
        if (inputs.length > 0) {
          inputs[inputs.length - 1].focus();
        }
      }, 100);
    }

    function eliminarMesa(espacioId, mesaId) {
      const confirmMsg = '<%= __("editCompany.confirmDeleteLevel2") %>'.replace('{nivel2}', empresa.nombreNivel2.toLowerCase());
      const errorMsg = '<%= __("editCompany.errorDeleteLevel2") %>'.replace('{nivel2}', empresa.nombreNivel2.toLowerCase());
      
      if (confirm(confirmMsg)) {
        const espacio = empresa.espacios.find(e => e.espacioId === espacioId);
        if (!espacio) return;

        espacio.mesas = espacio.mesas.filter(m => m.id !== mesaId);
        
        const payload = {
          espacioId: espacioId,
          pasilloNombre: espacio.pasilloNombre,
          mesas: espacio.mesas
        };

        fetch(`/api/empresas/${empresaId}/espacios`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            renderizarEspacios();
            console.log('Mesa eliminada del espacio:', espacioId);
          } else {
            alert(errorMsg);
            console.error('Error respuesta:', data);
            renderizarEspacios();
          }
        })
        .catch(err => {
          console.error('Error al eliminar mesa:', err);
          alert('Error al eliminar ' + empresa.nombreNivel2.toLowerCase());
          renderizarEspacios();
        });
      }
    }

    function actualizarNombreMesa(espacioId, mesaId, nuevoNombre) {
      const espacio = empresa.espacios.find(e => e.espacioId === espacioId);
      if (!espacio) return;

      const mesa = espacio.mesas.find(m => m.id === mesaId);
      if (!mesa) return;

      if (!nuevoNombre || !nuevoNombre.trim()) {
        const ahora = Date.now();
        const idTimestamp = parseInt(mesa.id.split('-')[1]);
        const esNueva = (ahora - idTimestamp) < 5000;

        if (esNueva) {
          espacio.mesas = espacio.mesas.filter(m => m.id !== mesaId);
          renderizarEspacios();
          console.log('Mesa nueva vacía descartada (no guardada)');
          return;
        } else {
          // Es una mesa guardada: no permitir dejar sin nombre
          alert(`El ${empresa.nombreNivel2.toLowerCase()} debe tener un nombre. No puede quedar vacío.`);
          renderizarEspacios(); // Recargar para mostrar el nombre anterior
          return;
        }
      }

      // Nombre válido: guardar en backend
      const payload = {
        espacioId: espacioId,
        pasilloNombre: espacio.pasilloNombre,
        mesas: espacio.mesas.map(m => 
          m.id === mesaId ? { ...m, nombre: nuevoNombre.trim() } : m
        )
      };

      fetch(`/api/empresas/${empresaId}/espacios`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          mesa.nombre = nuevoNombre.trim();
          console.log('Mesa actualizada en espacio:', espacioId);
        } else {
          alert('Error al actualizar ' + empresa.nombreNivel2.toLowerCase());
          console.error('Error respuesta:', data);
          renderizarEspacios();
        }
      })
      .catch(err => {
        console.error('Error al actualizar mesa:', err);
        alert('Error al actualizar ' + empresa.nombreNivel2.toLowerCase());
        renderizarEspacios();
      });
    }

    function actualizarCapacidadMesa(espacioId, mesaId, valor) {
      const espacio = empresa.espacios.find(e => e.espacioId === espacioId);
      if (!espacio) return;
      const mesa = espacio.mesas.find(m => m.id === mesaId);
      if (!mesa) return;

      const capacidad = Math.max(1, parseInt(valor, 10) || 1);
      mesa.capacidad = capacidad;

      const payload = {
        espacioId: espacioId,
        pasilloNombre: espacio.pasilloNombre,
        mesas: espacio.mesas.map(m => 
          m.id === mesaId ? { ...m, capacidad } : m
        )
      };

      fetch(`/api/empresas/${empresaId}/espacios`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log('Capacidad actualizada para mesa:', mesaId);
        } else {
          alert('Error al actualizar capacidad');
          console.error('Error respuesta:', data);
          renderizarEspacios();
        }
      })
      .catch(err => {
        console.error('Error al actualizar capacidad:', err);
        alert('Error al actualizar capacidad');
        renderizarEspacios();
      });
    }

    // ===== OCUPANTES =====
    function agregarOcupanteEditar() {
      const input = document.getElementById('nuevo-ocupante-editar');
      const nombre = input?.value.trim();

      if (!nombre) {
        alert(i18nTexts.requireName);
        return;
      }

      const payload = { nombre };

      fetch(`/api/empresas/${empresaId}/ocupantes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const nuevoOcupante = {
            ocupanteId: data.ocupanteId,
            nombre: nombre
          };
          empresa.ocupantes.push(nuevoOcupante);
          input.value = '';
          renderizarOcupantes();
          console.log('Ocupante agregado:', data.ocupanteId);
        } else {
          alert('Error al agregar ocupante: ' + (data.message || data.error));
          console.error('Error respuesta:', data);
        }
      })
      .catch(err => {
        console.error('Error al agregar ocupante:', err);
        alert('Error al agregar ocupante');
      });
    }

    function renderizarOcupantes() {
      const container = document.getElementById('ocupantes-lista-editar');
      
      if (!empresa.ocupantes || empresa.ocupantes.length === 0) {
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.minHeight = '300px';
        container.innerHTML = `
          <div style="text-align: center;">
            <i class="ri-user-add-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
            <p style="font-size: 15px; font-weight: 600; color: #666; margin: 0;">${i18nTexts.noOccupants}</p>
            <p style="font-size: 13px; margin-top: 8px; color: #999;">${i18nTexts.clickToPlusOccupant}</p>
          </div>
        `;
        return;
      }
      
      container.style.display = '';
      container.style.minHeight = '';

      container.innerHTML = empresa.ocupantes.map(ocupante => `
        <div class="ocupante-item-editar" data-id="${ocupante.ocupanteId}">
          <span style="font-weight: 500; color: #1a1a1a;">${ocupante.nombre}</span>
          <button type="button" class="btn-icon btn-icon-delete" onclick="eliminarOcupanteEditar('${ocupante.ocupanteId}')" title="${i18nTexts.deleteOccupant}">
            <i class="ri-delete-bin-line"></i>
          </button>
        </div>
      `).join('');
    }

    function eliminarOcupanteEditar(ocupanteId) {
      const confirmMsg = '<%- __("editCompany.confirmDeleteOccupant") %>';
      const errorMsg = '<%- __("editCompany.errorDeleteOccupant") %>';
      
      if (confirm(confirmMsg)) {
        fetch(`/api/empresas/${empresaId}/ocupantes/${ocupanteId}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            empresa.ocupantes = empresa.ocupantes.filter(o => o.ocupanteId !== ocupanteId);
            renderizarOcupantes();
            console.log('Ocupante eliminado:', ocupanteId);
          } else {
            alert(errorMsg);
            console.error('Error respuesta:', data);
          }
        })
        .catch(err => {
          console.error('Error al eliminar ocupante:', err);
          alert(errorMsg);
        });
      }
    }

    // ===== FUNCIONES PARA ELEMENTOS/ITEMS =====
    function agregarElementoEditar() {
      const inputNuevoElemento = document.getElementById('nuevo-elemento-editar');
      const nombre = inputNuevoElemento?.value.trim();

      if (!nombre) {
        alert(i18nTexts.requireName);
        return;
      }

      fetch(`/api/empresas/${empresaId}/items`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          empresa.items.push(data.item);
          inputNuevoElemento.value = '';
          renderizarElementos();
          console.log('Elemento agregado:', data.item);
        } else {
          alert('Error al agregar elemento');
          console.error('Error respuesta:', data);
        }
      })
      .catch(err => {
        console.error('Error al agregar elemento:', err);
        alert('Error al agregar elemento');
      });
    }

    function renderizarElementos() {
      const container = document.getElementById('elementos-lista-editar');
      const nivel4Name = empresa.nombreNivel4 || 'Elementos';
      
      if (!empresa.items || empresa.items.length === 0) {
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.minHeight = '300px';
        const noElementsMsg = '<%= __("editCompany.noElements") %>'.replace('{elementos}', nivel4Name.toLowerCase());
        container.innerHTML = `
          <div style="text-align: center;">
            <i class="ri-box-3-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
            <p style="font-size: 15px; font-weight: 600; color: #666; margin: 0;">${noElementsMsg}</p>
            <p style="font-size: 13px; margin-top: 8px; color: #999;">${i18nTexts.clickToPlusElement}</p>
          </div>
        `;
        return;
      }
      
      container.style.display = '';
      container.style.minHeight = '';


      container.innerHTML = empresa.items.map(item => `
        <div class="elemento-item-editar" data-id="${item.itemId}">
          <span style="font-weight: 500; color: #1a1a1a;">${item.nombre}</span>
          <button type="button" class="btn-icon btn-icon-delete" onclick="eliminarElementoEditar('${item.itemId}')" title="${i18nTexts.deleteOccupant}">
            <i class="ri-delete-bin-line"></i>
          </button>
        </div>
      `).join('');
    }

    function eliminarElementoEditar(itemId) {
      const nivel4Name = empresa.nombreNivel4 ? empresa.nombreNivel4.toLowerCase() : 'elemento';
      const confirmMsg = '<%= __("editCompany.confirmDeleteElement") %>'.replace('{elemento}', nivel4Name);
      const errorMsg = '<%= __("editCompany.errorDeleteElement") %>'.replace('{elemento}', nivel4Name);
      
      if (confirm(confirmMsg)) {
        fetch(`/api/empresas/${empresaId}/items/${itemId}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            empresa.items = empresa.items.filter(i => i.itemId !== itemId);
            renderizarElementos();
            console.log('Item eliminado:', itemId);
          } else {
            alert(errorMsg);
            console.error('Error respuesta:', data);
          }
        })
        .catch(err => {
          console.error('Error al eliminar item:', err);
          alert(errorMsg);
        });
      }
    }
  </script>
  <%- include('footer') %>
</body>
</html>
