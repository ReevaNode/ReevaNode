<!DOCTYPE html>
<html lang="<%= userLang || 'es' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="infoBox.title">Reeva - <%= __("infoBox.title") %> <%= box.numero %></title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#9c4d9e',
            secondary: '#57b5e7'
          },
          borderRadius: {
            'button': '8px'
          },
          fontFamily: {
            'sans': ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">

  <!-- ECharts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <link rel="stylesheet" href="/css/header.css" />
  <!-- Agenda CSS -->
  <link rel="stylesheet" href="/css/agenda.css" />

  <style>
    body { background-color:#f5f5f5; }
    
    /* Modal animations */
    #itemsModal { transition: opacity .22s ease; }
    #itemsModal.hidden { opacity:0; }
    #itemsModal.fade-in { opacity:1; }
    #itemsModal .items-panel { 
      transition: transform .22s ease, opacity .22s ease; 
      transform:translateY(12px) scale(.97); 
      opacity:0; 
    }
    #itemsModal.fade-in .items-panel { 
      transform:translateY(0) scale(1); 
      opacity:1; 
    }
  </style>
</head>
<body class="font-sans">

<!-- Header -->
<%- include('header') %>

<!-- Main -->
<main class="container mx-auto px-4 md:px-6 py-4 md:py-6 max-w-7xl">

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">

      <!-- Left Column -->
      <div class="space-y-6">

          <!-- Box Card -->
          <div class="bg-white rounded shadow-[0_2px_10px_rgba(0,0,0,0.05)] overflow-hidden">
            <img src="/images/doctor.jpg.webp"
            alt="Especialidad" 
            class="w-full h-48 object-cover object-top">
              <div class="p-4">
                  <div class="text-4xl font-bold"><%= box.numero %></div>
                  <div class="text-sm font-semibold text-gray-700 mt-1">
                      <span data-i18n="infoBox.boxNumber"><%= __("infoBox.boxNumber") %></span>
                      <% if (box.especialidadTranslationKey) { %>
                        <span data-i18n="specialties.<%= box.especialidadTranslationKey %>">
                          <%= __('specialties.' + box.especialidadTranslationKey).toUpperCase() %>
                        </span>
                      <% } else { %>
                        <%= box.especialidad.toUpperCase() %>
                      <% } %>
                  </div>
              </div>
          </div>
          <!-- Estado Box -->
          <div class="bg-white rounded shadow-[0_2px_10px_rgba(0,0,0,0.05)] p-4">
              <div class="text-center mb-2 font-medium" data-i18n="infoBox.dayOccupancy"><%= __("infoBox.dayOccupancy") %></div>
              <div class="w-full h-48" id="estadoChart"></div>
          </div>

      </div>

      <!-- Middle Column (span=2) -->
      <div class="space-y-6 md:col-span-2">

            <!-- Pacientes atendidos Card -->
            <div class="bg-white rounded shadow-[0_2px_10px_rgba(0,0,0,0.05)] p-6">
              <h2 class="text-lg font-medium text-gray-800 mb-4" data-i18n="infoBox.patientsAttended"><%= __("infoBox.patientsAttended") %></h2>
              <div class="grid grid-cols-2 gap-4">

                <!-- Diario -->
                <div class="flex items-center">
                  <i class="ri-calendar-line ri-2x text-gray-700"></i>
                  <div class="ml-4">
                    <div class="text-3xl font-bold">
                      <%= total_diario %>
                    </div>
                    <div class="text-sm text-gray-600" data-i18n="infoBox.daily"><%= __("infoBox.daily") %></div>
                  </div>
                </div>

                <!-- Mensual -->
                <div class="flex items-center">
                  <i class="ri-calendar-line ri-2x text-gray-700"></i>
                  <div class="ml-4">
                    <div class="text-3xl font-bold">
                      <%= mensual %>
                    </div>
                    <div class="text-sm text-gray-600" data-i18n="infoBox.monthly"><%= __("infoBox.monthly") %></div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Items del Box -->
            <div class="bg-white rounded shadow-[0_2px_10px_rgba(0,0,0,0.05)] p-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-medium text-gray-800" data-i18n="infoBox.boxElements2"><%= __("infoBox.boxElements2") %></h2>
                  <button id="editarItemsBtn" type="button" class="text-sm px-3 py-1.5 rounded-button bg-primary text-white hover:opacity-90" data-i18n="infoBox.editBtn"><%= __("infoBox.editBtn") %></button>
                </div>
                <div id="listaItemsBox" class="space-y-2">
                    <% if (elementos && elementos.length > 0) { %>
                      <% elementos.forEach(item => { %>
                        <div class="flex items-center justify-between text-sm border border-gray-100 rounded px-3 py-2">
                          <% if (item.translationKey) { %>
                            <span class="font-medium" data-i18n="infoBox.boxElements.<%= item.translationKey %>">
                              <%= __('infoBox.boxElements.' + item.translationKey) %>
                            </span>
                          <% } else { %>
                            <span class="font-medium"><%= item.nombre %></span>
                          <% } %>
                          <span class="text-gray-700">x <%= item.cantidad %></span>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <p class="text-sm text-gray-500" data-i18n="infoBox.noRecords"><%= __("infoBox.noRecords") %></p>
                    <% } %>
                </div>
            </div>

      </div>
  </div>

  <!-- Estadísticas rapidas -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
      <div class="bg-white rounded shadow-sm p-4 text-center">
          <div class="text-2xl font-bold"><%= horas_tot %></div>
          <div class="text-sm text-gray-600" data-i18n="infoBox.totalHours"><%= __("infoBox.totalHours") %></div>
      </div>
      <div class="bg-white rounded shadow-sm p-4 text-center">
          <div class="text-2xl font-bold"><%= ingresos %></div>
          <div class="text-sm text-gray-600" data-i18n="infoBox.admissions"><%= __("infoBox.admissions") %></div>
      </div>
      <div class="bg-white rounded shadow-sm p-4 text-center">
          <div class="text-2xl font-bold"><%= controles %></div>
          <div class="text-sm text-gray-600" data-i18n="infoBox.followups"><%= __("infoBox.followups") %></div>
      </div>
      <div class="bg-white rounded shadow-sm p-4 text-center">
          <div class="text-2xl font-bold"><%= altas %></div>
          <div class="text-sm text-gray-600" data-i18n="infoBox.discharges"><%= __("infoBox.discharges") %></div>
      </div>
      <div class="bg-white rounded shadow-sm p-4 text-center">
          <div class="text-2xl font-bold"><%= gestiones %></div>
          <div class="text-sm text-gray-600" data-i18n="infoBox.management"><%= __("infoBox.management") %></div>
      </div>
  </div>

  <!-- Calendario -->
  <section class="bg-white rounded-lg shadow-sm mt-6 md:mt-8 p-4 md:p-6">
    <div class="mb-4 md:mb-6"><h2 class="text-xl md:text-2xl font-semibold text-gray-800" data-i18n="infoBox.boxSchedule"><%= __("infoBox.boxSchedule") %></h2></div>
    
    <!-- Banner instructivo -->
    <div id="instructionBanner" class="mb-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg relative overflow-hidden">
      <div class="flex items-center justify-between p-4 cursor-pointer" id="bannerHeader">
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0"><div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center"><i class="ri-question-line text-primary text-sm"></i></div></div>
          <div>
            <h4 class="text-sm font-medium text-gray-900" data-i18n="infoBox.helpTitle"><%= __("infoBox.helpTitle") %></h4>
            <p class="text-xs text-gray-500" data-i18n="infoBox.helpSubtitle"><%= __("infoBox.helpSubtitle") %></p>
          </div>
        </div>
        <button id="toggleBanner" class="text-gray-400 hover:text-gray-600 transition-all duration-200 transform hover:scale-110">
          <i id="bannerIcon" class="ri-arrow-down-s-line text-lg transition-transform duration-200"></i>
        </button>
      </div>
      <div id="bannerContent" class="px-4 pb-4 max-h-0 overflow-hidden transition-all duration-300">
        <div class="border-t border-purple-200 pt-3">
          <div class="space-y-3">
            <div><h5 class="text-sm font-medium text-gray-900" data-i18n="infoBox.editConsultation"><%= __("infoBox.editConsultation") %></h5><p class="text-sm text-gray-600"><span class="mx-2">•</span><span class="font-medium text-primary" data-i18n="infoBox.clickToEdit"><%= __("infoBox.clickToEdit") %></span></p></div>
          </div>
        </div>
      </div>
      <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-purple-200 to-blue-200 opacity-40"><div class="h-full bg-gradient-to-r from-purple-500 to-blue-500 animate-pulse-slow"></div></div>
    </div>
    
    <div id="calendar" class="w-full min-h-[600px] md:min-h-[700px] overflow-auto"></div>
  </section>

  <!-- toggle box (habilitar/inhabilitar) -->
  <button
    id="toggleMantBtn"
    class="<%= disabled ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700' %> text-white px-6 py-3 rounded-button mt-6 flex items-center gap-2 transition-all duration-200 shadow-md hover:shadow-lg"
    onclick="openMantModal()"
  >
    <% if (disabled) { %>
      <i class="ri-play-circle-line text-lg"></i>
      <span data-i18n="infoBox.enableBox"><%= __("infoBox.enableBox") %></span>
    <% } else { %>
      <i class="ri-stop-circle-line text-lg"></i>
      <span data-i18n="infoBox.disableBox"><%= __("infoBox.disableBox") %></span>
    <% } %>
  </button>

</main>

<!-- Modal Items -->
<div id="itemsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm overflow-auto p-4">
  <div class="items-panel bg-white rounded-2xl p-8 w-full max-w-2xl mx-4 shadow-xl max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-medium" data-i18n="infoBox.editElements"><%= __("infoBox.editElements") %></h3>
      <button id="cerrarItemsModal" class="text-gray-400 hover:text-gray-600">
        <i class="ri-close-line ri-2x"></i>
      </button>
    </div>

    <div id="itemsLoading" class="text-center py-8 text-gray-500" data-i18n="infoBox.loading">
      <%= __("infoBox.loading") %>
    </div>

    <div id="itemsList" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

    <div id="itemsStatus" class="text-sm text-center mb-4 text-green-600"></div>

    <div class="flex justify-between">
      <button id="cancelItemsBtn" type="button" class="px-6 py-2 bg-gray-400 text-white rounded hover:bg-gray-500" data-i18n="infoBox.cancel"><%= __("infoBox.cancel") %></button>
      <button id="saveItemsBtn" type="button" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/90" data-i18n="infoBox.saveChanges"><%= __("infoBox.saveChanges") %></button>
    </div>
  </div>
</div>

<!-- Modal Editar -->
<div id="editEventoModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm hidden overflow-auto p-4">
  <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-4 shadow-xl">
    <h3 class="text-2xl font-medium text-center mb-8" data-i18n="infoBox.editEvent"><%= __("infoBox.editEvent") %></h3>
    <form id="editEventoForm" method="post" action="" class="space-y-6">
      <input type="hidden" id="editEventoId" name="eventoId" value="" />
      <input type="hidden" id="editEstadoId" name="idEstado" value="" />
      <div id="editError" class="hidden mb-4 p-3 rounded bg-red-50 text-red-700 text-sm border border-red-200"></div>
      <div>
        <label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.specialtyLabel"><%= __("agenda.specialtyLabel") %></label>
        <select id="editEspecialidadSelect" class="w-full border rounded p-2" required>
          <option value="" disabled selected data-i18n="agenda.selectSpecialtyPlaceholder"><%= __("agenda.selectSpecialtyPlaceholder") %></option>
          <% (tipos_profesional_normalizados || []).forEach(tipo => { %>
            <option value="<%= tipo.id %>" 
                    data-i18n="<%= tipo.translationKey ? 'specialties.' + tipo.translationKey : '' %>">
              <%= tipo.translationKey ? __('specialties.' + tipo.translationKey) : tipo.nombre %>
            </option>
          <% }) %>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.professional"><%= __("infoBox.professional") %></label>
        <select id="editProfesionalSelect" name="usuario_id" class="w-full border rounded p-2" required>
          <option value="" disabled selected data-i18n="infoBox.selectProfessional"><%= __("infoBox.selectProfessional") %></option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.consultationType"><%= __("infoBox.consultationType") %></label>
        <select id="editTipoConsulta" name="idTipoConsulta" class="w-full border rounded p-2" required>
          <option value="" disabled selected data-i18n="infoBox.selectType"><%= __("infoBox.selectType") %></option>
          <% (tipos_consulta_normalizados || []).forEach(tipo => { %>
            <option value="<%= tipo.id %>">
              <%= tipo.translationKey ? __('consultationTypes.' + tipo.translationKey) : tipo.nombre %>
            </option>
          <% }) %>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.date"><%= __("infoBox.date") %></label>
        <input type="date" id="editFecha" name="fecha" class="w-full border rounded p-2" required />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.startTime"><%= __("infoBox.startTime") %></label>
          <input type="time" id="editHoraInicio" name="horainicio" class="w-full border rounded p-2" required />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.endTime"><%= __("infoBox.endTime") %></label>
          <input type="time" id="editHoraFin" name="horafin" class="w-full border rounded p-2" required />
        </div>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-2" data-i18n="infoBox.detailsObservations"><%= __("infoBox.detailsObservations") %></label>
        <textarea id="editObservaciones" name="observaciones" rows="3" class="w-full border rounded p-2"></textarea>
      </div>
      <div class="flex justify-between gap-3">
        <button id="deleteEventoBtn" type="button" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700" data-i18n="infoBox.delete"><%= __("infoBox.delete") %></button>
        <div class="flex gap-3">
          <button type="button" onclick="editEventoModal.classList.add('hidden')" class="px-6 py-2 bg-gray-400 text-white rounded hover:bg-gray-500" data-i18n="infoBox.cancel"><%= __("infoBox.cancel") %></button>
          <button type="submit" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/90" data-i18n="infoBox.saveChanges"><%= __("infoBox.saveChanges") %></button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Mantenimiento -->
<div id="mantModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm hidden overflow-auto p-4">
  <div class="bg-white rounded-2xl p-8 w-full max-w-md mx-4 shadow-xl">
    <h3 class="text-2xl font-medium text-center mb-6" data-i18n="<%= disabled ? 'infoBox.enableBox' : 'infoBox.disableBox' %>">
      <%= disabled ? __("infoBox.enableBox") : __("infoBox.disableBox") %>
    </h3>
    <p class="text-center text-gray-600 mb-6" data-i18n="<%= disabled ? 'infoBox.confirmEnable' : 'infoBox.confirmDisable' %>">
      <%= disabled ? __("infoBox.confirmEnable") : __("infoBox.confirmDisable") %>
    </p>
    <div class="flex justify-between">
      <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeMantModal()" data-i18n="infoBox.cancel">
        <%= __("infoBox.cancel") %>
      </button>
      <button type="button" class="px-4 py-2 <%= disabled ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700' %> text-white rounded" onclick="toggleMantenimiento()" data-i18n="infoBox.confirm">
        <%= __("infoBox.confirm") %>
      </button>
    </div>
  </div>
</div>

<%- include('footer') %>
<script>
const boxId = '<%= box.idBox || box.id %>';
const eventos = <%- eventos_json %>;
const userLang = '<%= userLang || "es" %>';

window.__i18n = {
  'infoBox.boxElements.mesa': '<%= __("infoBox.boxElements.mesa") %>',
  'infoBox.boxElements.silla': '<%= __("infoBox.boxElements.silla") %>',
  'infoBox.boxElements.balanza': '<%= __("infoBox.boxElements.balanza") %>',
  'infoBox.boxElements.computador': '<%= __("infoBox.boxElements.computador") %>',
  'infoBox.boxElements.escritorio': '<%= __("infoBox.boxElements.escritorio") %>',
  'infoBox.boxElements.camilla': '<%= __("infoBox.boxElements.camilla") %>',
};

// ===== FUNCIONES DE MANTENIMIENTO MODAL =====
// Deben estar en el scope global para ser accesibles desde onclick
function openMantModal() {
  document.getElementById('mantModal').classList.remove('hidden');
}

function closeMantModal() {
  document.getElementById('mantModal').classList.add('hidden');
}

function toggleMantenimiento() {
  console.log('✓ Iniciando toggle mantenimiento para box:', boxId);
  console.log('✓ URL completa:', `/toggle_mantenimiento/${boxId}`);
  
  fetch(`/toggle_mantenimiento/${boxId}`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    credentials: 'same-origin'
  })
  .then(res => {
    console.log('✓ Respuesta recibida - status:', res.status);
    return res.json();
  })
  .then(data => {
    console.log('✓ Datos recibidos:', data);
    if (data.ok) {
      console.log('✅ Toggle exitoso');
      console.log('⏳ Cerrando modal y esperando actualización por WebSocket...');
      closeMantModal();
      // NO recargamos aquí - dejamos que el WebSocket recargue la página cuando reciba el mensaje
      // Esto asegura que DynamoDB ya se haya actualizado antes de recargar
    } else {
      console.error('❌ Error del servidor:', data.error);
      alert('Error al cambiar estado del box: ' + (data.error || 'Error desconocido'));
      closeMantModal();
    }
  })
  .catch(err => {
    console.error('❌ Error toggle mantenimiento:', err);
    alert('Error al cambiar estado del box');
    closeMantModal();
  });
}
// ===== FIN FUNCIONES DE MANTENIMIENTO =====

// ECharts - Gráfico de ocupación
document.addEventListener('DOMContentLoaded', () => {
  const chart = echarts.init(document.getElementById('estadoChart'));
  const pctOcupado = <%= pct_ocupado %>;
  chart.setOption({
    series:[{
      type:'pie',
      radius:['60%','80%'],
      label:{
        show:true,
        position:'center',
        formatter: `${pctOcupado}%`,
        fontSize:24,
        fontWeight:'bold'
      },
      data:[
        { value: pctOcupado, name:'Ocupado', itemStyle:{color:'#4ade80'} },
        { value: <%= pct_libre %>, name:'Libre', itemStyle:{color:'#e2f8e9'} }
      ]
    }]
  });
  window.addEventListener('resize', () => chart.resize());
});
</script>

<script>
const mantModal = document.getElementById('mantModal');
function openMantModal() {
  mantModal.classList.remove('hidden');
}
function closeMantModal() {
  mantModal.classList.add('hidden');
}
mantModal.addEventListener('click', e => {
  if (e.target === mantModal) closeMantModal();
});

function toggleMantenimiento() {
  const boxId = '<%= box.idBox || box.id %>';
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/toggle_mantenimiento/${boxId}`;
  document.body.appendChild(form);
  form.submit();
}
</script>

<!-- Scripts del Modal de Eventos -->
<script>
  const eventoModal = document.getElementById('eventoModal');
  if (eventoModal) {
    eventoModal.addEventListener('click', e => {
      if (e.target === eventoModal) eventoModal.classList.add('hidden');
    });
  }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const eventoModal = document.getElementById('eventoModal');
  const mantModal   = document.getElementById('mantModal');
  
  window.openEventoModal = function()  { if (eventoModal) eventoModal.classList.remove('hidden'); }
  window.closeEventoModal = function() { if (eventoModal) eventoModal.classList.add('hidden'); }
  window.openMantModal = function()    { if (mantModal) mantModal.classList.remove('hidden'); }
  window.closeMantModal = function()   { if (mantModal) mantModal.classList.add('hidden'); }
  
  if (eventoModal) {
    eventoModal.addEventListener('click', e => {
      if (e.target === eventoModal) window.closeEventoModal();
    });
  }
  
  if (mantModal) {
    mantModal.addEventListener('click', e => {
      if (e.target === mantModal) window.closeMantModal();
    });
  }
});
</script>

<!-- Inicialización FullCalendar -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const eventos = <%- eventos_json || '[]' %>;
  
  const texts = {
    today: userLang === 'en' ? 'Today' : 'Hoy',
    month: userLang === 'en' ? 'Month' : 'Mes',
    week: userLang === 'en' ? 'Week' : 'Semana',
    day: userLang === 'en' ? 'Day' : 'Día',
    allDay: userLang === 'en' ? 'all-day' : 'todo el día'
  };
  
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridDay',
    locale: userLang === 'en' ? 'en' : 'es',
    timeZone: 'local',
    height: 'auto',
    contentHeight: 600,
    aspectRatio: 1.2,
    nowIndicator: true,
    
    eventTimeFormat: {
      hour: 'numeric',
      minute: '2-digit',
      meridiem: userLang === 'en' ? 'short' : false,
      hour12: userLang === 'en'
    },
    
    slotLabelFormat: {
      hour: 'numeric',
      minute: '2-digit',
      meridiem: userLang === 'en' ? 'short' : false,
      hour12: userLang === 'en'
    },
    
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    buttonText: {
      today: texts.today,
      month: texts.month,
      week: texts.week,
      day: texts.day
    },
    allDayText: texts.allDay,
    events: eventos,
    slotMinHeight: 30,
    slotDuration: '00:05:00',
    snapDuration: '00:01:00',
    slotLabelInterval: '00:30:00',
    slotMinTime: '08:00:00',
    slotMaxTime: '19:00:00',
    selectable: true,
    selectMirror: false,
    selectOverlap: false,
    unselectAuto: false,
    
    // Deshabilitado: no se pueden crear eventos desde info_box
    dateClick: function(info) {
      console.log('Creación de eventos deshabilitada en info_box');
    },
    
    select: function(selectionInfo) {
      console.log('Creación de eventos deshabilitada en info_box');
      calendar.unselect();
    },
    
    eventClick: function(info) {
      // Solo permitir edición de eventos reales (no placeholders)
      openEditEventoModal(info.event);
    },
    
    eventDidMount: function() {
      setTimeout(markEmptySlots, 100);
    },
    
    viewDidMount: function() {
      setTimeout(markEmptySlots, 100);
    },
    
    datesSet: function() {
      setTimeout(markEmptySlots, 100);
    }
  });
  
  window.__calendar = calendar;
  calendar.render();
  calendarEl.style.visibility = 'visible';
  calendarEl.style.opacity = '1';
  calendarEl.style.minHeight = '700px';
  
  function markEmptySlots() {
    document.querySelectorAll('.fc-timegrid-slot.empty-slot, .fc-timegrid-slot.empty-block').forEach(slot => {
      slot.classList.remove('empty-slot', 'empty-block');
      slot.removeAttribute('data-block-id');
      slot.removeAttribute('data-block-size');
      slot.removeAttribute('data-is-first');
      slot.removeAttribute('data-is-last');
    });
    
    const dayColumns = document.querySelectorAll('.fc-timegrid-col');
    
    dayColumns.forEach((column, columnIndex) => {
      const slots = column.querySelectorAll('.fc-timegrid-slot');
      const emptyBlocks = [];
      let currentBlock = [];
      
      slots.forEach((slot, index) => {
        const hasEvent = slot.querySelector('.fc-timegrid-event-harness, .fc-timegrid-now-indicator-line');
        
        if (!hasEvent) {
          currentBlock.push(slot);
        } else {
          if (currentBlock.length > 0) {
            emptyBlocks.push([...currentBlock]);
            currentBlock = [];
          }
        }
      });
      
      if (currentBlock.length > 0) {
        emptyBlocks.push([...currentBlock]);
      }
      
      emptyBlocks.forEach((block, blockIndex) => {
        const blockId = `block-${columnIndex}-${blockIndex}`;
        const blockSize = block.length;
        
        block.forEach((slot, slotIndex) => {
          slot.classList.add('empty-block');
          slot.setAttribute('data-block-id', blockId);
          slot.setAttribute('data-block-size', blockSize);
          if (slotIndex === 0) slot.setAttribute('data-is-first', 'true');
          if (slotIndex === block.length - 1) slot.setAttribute('data-is-last', 'true');
        });
      });
    });
  }
});
</script>

<!-- Script de Profesionales -->
<script>
  const profesionales = <%- JSON.stringify(profesionales_normalizados || []) %>;
  console.log('PROFESIONALES desde servidor:', profesionales);
  
  const selectProfPlaceholder = userLang === 'en' ? 'Select professional' : '— Selecciona profesional —';
  
  function fillProfesionalSelect(selectEl, especialidadId) {
    if (!selectEl) return;
    selectEl.innerHTML = `<option value="" disabled selected>${selectProfPlaceholder}</option>`;
    profesionales.forEach(function(prof) {
      if (!especialidadId || String(prof.especialidad) === String(especialidadId)) {
        const option = document.createElement('option');
        option.value = prof.id;
        option.textContent = prof.nombre;
        selectEl.appendChild(option);
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const editProfesionalSelect = document.getElementById('editProfesionalSelect');
      fillProfesionalSelect(editProfesionalSelect, null);
    } catch (e) { console.warn('Error rellenando select de profesionales', e); }
  });
</script>

<!-- Script de Editar Evento -->
<script>
const editEventoModal = document.getElementById('editEventoModal');
const editEventoForm = document.getElementById('editEventoForm');
function pad(num) {
  return num.toString().padStart(2, '0');
}
function toLocalTimeString(dateObj) {
  return pad(dateObj.getHours()) + ':' + pad(dateObj.getMinutes());
}
function openEditEventoModal(evento) {
  const err = document.getElementById('editError');
  if (err) {
    err.textContent = '';
    err.classList.add('hidden');
  }
  
  const editEspecialidadSelect = document.getElementById('editEspecialidadSelect');
  const editProfesionalSelect = document.getElementById('editProfesionalSelect');
  
  // Obtener profesional actual para saber su especialidad
  const profesionalActual = profesionales.find(p => p.id == evento.extendedProps.usuario_id);
  
  // Pre-seleccionar especialidad del profesional actual (para que vea sus datos)
  if (profesionalActual && editEspecialidadSelect) {
    editEspecialidadSelect.value = profesionalActual.especialidad;
    editEspecialidadSelect.dispatchEvent(new Event('change'));
    
    // Hacer que parezca deshabilitado visualmente
    editEspecialidadSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
    editEspecialidadSelect.setAttribute('onclick', 'return false;');
    editEspecialidadSelect.setAttribute('onkeydown', 'return false;');
    
    // Seleccionar el profesional actual DESPUÉS de filtrar por especialidad
    setTimeout(() => {
      editProfesionalSelect.value = profesionalActual.id;
    }, 100);
  } else {
    editProfesionalSelect.value = "";
  }
  
  document.getElementById('editEventoId').value = evento.id;
  document.getElementById('editEstadoId').value = evento.extendedProps.idEstado || '2';
  document.getElementById('editHoraInicio').value = toLocalTimeString(evento.start);
  document.getElementById('editHoraFin').value = toLocalTimeString(evento.end);
  document.getElementById('editFecha').value = evento.start.toISOString().slice(0,10);
  
  // Pre-seleccionar tipo de consulta
  const tipoSelect = document.getElementById('editTipoConsulta');
  if (tipoSelect) {
    const tipoId = (evento.extendedProps && evento.extendedProps.tipo_id != null)
      ? String(evento.extendedProps.tipo_id)
      : '';
    
    if (tipoId) {
      tipoSelect.value = tipoId;
    } else {
      tipoSelect.value = '';
    }
  }
  
  document.getElementById('editObservaciones').value = evento.extendedProps.observaciones || '';
  editEventoForm.action = `/editar_evento/${evento.id}`;
  editEventoModal.classList.remove('hidden');
}

function closeEditEventoModal() {
  // Re-habilitar especialidad select y limpiar restricciones
  const editEspecialidadSelect = document.getElementById('editEspecialidadSelect');
  if (editEspecialidadSelect) {
    editEspecialidadSelect.disabled = false;
    editEspecialidadSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
    editEspecialidadSelect.removeAttribute('onclick');
    editEspecialidadSelect.removeAttribute('onkeydown');
  }
  editEventoModal.classList.add('hidden');
}

editEventoModal.addEventListener('click', e => {
  if (e.target === editEventoModal) closeEditEventoModal();
});

document.getElementById('deleteEventoBtn').onclick = async function() {
  const eventoId = document.getElementById('editEventoId').value;
  const boxId = <%= box.idBox || box.idbox %>;
  
  const deleteConfirmMsg = userLang === 'en' 
    ? 'Are you sure you want to delete this event?' 
    : '¿Seguro que quieres eliminar este evento?';
  const deleteErrorMsg = userLang === 'en'
    ? 'Error deleting event'
    : 'Error al eliminar el evento';
  
  if (confirm(deleteConfirmMsg)) {
    try {
      const response = await fetch(`/eliminar_evento/${eventoId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        closeEditEventoModal();
        window.location.href = `/info-box/${boxId}`;
      } else {
        alert(deleteErrorMsg);
      }
    } catch (error) {
      console.error('Error:', error);
      alert(deleteErrorMsg);
    }
  }
};
</script>

<script>
  const editEspecialidadSelect = document.getElementById('editEspecialidadSelect');
  const editProfesionalSelect = document.getElementById('editProfesionalSelect');
  editEspecialidadSelect && editEspecialidadSelect.addEventListener('change', function() {
    fillProfesionalSelect(editProfesionalSelect, this.value);
  });
</script>

<!-- Script de Refresh Calendar -->
<script>
async function refreshCalendarEvents() {
  try {
    const boxId = '<%= box.idBox || box.id %>';
    const url = `/info-box/${boxId}/events`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) return;
    const data = await resp.json();
    if (window.__calendar && Array.isArray(data)) {
      window.__calendar.batchRendering(() => {
        window.__calendar.removeAllEvents();
        data.forEach(ev => window.__calendar.addEvent(ev));
      });
    }
  } catch (_) { }
}
</script>

<!-- Script de Formulario Edit Evento -->
<script>
editEventoForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const errorBox = document.getElementById('editError');
  errorBox.classList.add('hidden');
  errorBox.textContent = '';
  
  const networkErrorMsg = userLang === 'en' 
    ? 'Network error. Please try again.' 
    : 'Error de red. Intenta nuevamente.';
  const saveErrorMsg = userLang === 'en'
    ? 'Could not save.'
    : 'No se pudo guardar.';
  
  const formData = new FormData(editEventoForm);
  const params = new URLSearchParams();
  for (const pair of formData.entries()) params.append(pair[0], pair[1]);
  const url = editEventoForm.action;
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: params.toString()
    });
    const isJson = resp.headers.get('content-type')?.includes('application/json');
    if (isJson) {
      const data = await resp.json();
      if (!data.ok) {
        errorBox.textContent = data.error || saveErrorMsg;
        errorBox.classList.remove('hidden');
        return;
      }
      await refreshCalendarEvents();
      closeEditEventoModal();
      return;
    }
    window.location.reload();
  } catch (err) {
    errorBox.textContent = networkErrorMsg;
    errorBox.classList.remove('hidden');
  }
});
</script>

<!-- Script de Validación de Horarios -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const timeRangeMsg = userLang === 'en' 
    ? 'Time must be between 08:00 and 19:00' 
    : 'La hora debe estar entre 08:00 y 19:00';
  const timeOrderMsg = userLang === 'en'
    ? 'End time must be after start time'
    : 'La hora de fin debe ser posterior a la hora de inicio';
  const alertMsg = userLang === 'en'
    ? 'Please verify that times are between 08:00 and 19:00 and that the end time is after the start time'
    : 'Por favor, verifique que las horas estén entre 08:00 y 19:00 y que la hora de fin sea posterior a la de inicio';
  
  function validateTimeRange(timeInput) {
    const timeValue = timeInput.value;
    if (timeValue) {
      const [hours, minutes] = timeValue.split(':').map(Number);
      const timeInMinutes = hours * 60 + minutes;
      const minTime = 8 * 60;
      const maxTime = 19 * 60;
      
      if (timeInMinutes < minTime || timeInMinutes > maxTime) {
        timeInput.setCustomValidity(timeRangeMsg);
        return false;
      } else {
        timeInput.setCustomValidity('');
        return true;
      }
    }
    return true;
  }
  
  function validateTimeOrder(startInput, endInput) {
    if (startInput.value && endInput.value) {
      const startTime = startInput.value.split(':').map(Number);
      const endTime = endInput.value.split(':').map(Number);
      const startMinutes = startTime[0] * 60 + startTime[1];
      const endMinutes = endTime[0] * 60 + endTime[1];
      
      if (endMinutes <= startMinutes) {
        endInput.setCustomValidity(timeOrderMsg);
        return false;
      } else {
        endInput.setCustomValidity('');
        return true;
      }
    }
    return true;
  }
  
  const timeInputs = document.querySelectorAll('input[type="time"]');
  timeInputs.forEach(input => {
    input.addEventListener('change', function() {
      validateTimeRange(this);
      
      const form = this.closest('form');
      if (form) {
        const startInput = form.querySelector('input[name="horainicio"]');
        const endInput = form.querySelector('input[name="horafin"]');
        if (startInput && endInput) {
          validateTimeOrder(startInput, endInput);
        }
      }
    });
    
    input.addEventListener('blur', function() {
      validateTimeRange(this);
    });
  });
  
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const formTimeInputs = form.querySelectorAll('input[type="time"]');
      const startInput = form.querySelector('input[name="horainicio"]');
      const endInput = form.querySelector('input[name="horafin"]');
      let isValid = true;
      
      formTimeInputs.forEach(input => {
        if (!validateTimeRange(input)) {
          isValid = false;
        }
      });
      
      if (startInput && endInput && !validateTimeOrder(startInput, endInput)) {
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
        alert(alertMsg);
      }
    });
  });
});
</script>

<!-- Scripts de Helper Functions -->
<script>
// Funcionalidad de creación de eventos deshabilitada en info_box
// Solo se permite edición y eliminación de eventos existentes
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const banner = document.getElementById('instructionBanner');
  const toggleBanner = document.getElementById('toggleBanner');
  const bannerHeader = document.getElementById('bannerHeader');
  const bannerContent = document.getElementById('bannerContent');
  const bannerIcon = document.getElementById('bannerIcon');
  
  let isExpanded = false;
  const bannerKey = 'calendarHelp_infoBox_expanded';
  
  const savedState = localStorage.getItem(bannerKey);
  if (savedState === 'true') {
    expandBanner();
  }
  
  if (bannerHeader && toggleBanner) {
    bannerHeader.addEventListener('click', toggleBannerState);
    toggleBanner.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleBannerState();
    });
  }
  
  function toggleBannerState() {
    if (isExpanded) {
      collapseBanner();
    } else {
      expandBanner();
    }
  }
  
  function expandBanner() {
    if (!bannerContent || !bannerIcon) return;
    
    isExpanded = true;
    bannerContent.style.maxHeight = bannerContent.scrollHeight + 'px';
    bannerIcon.style.transform = 'rotate(180deg)';
    localStorage.setItem(bannerKey, 'true');
  }
  
  function collapseBanner() {
    if (!bannerContent || !bannerIcon) return;
    
    isExpanded = false;
    bannerContent.style.maxHeight = '0';
    bannerIcon.style.transform = 'rotate(0deg)';
    localStorage.setItem(bannerKey, 'false');
  }
});
</script>

<script>
// items editor
const itemsModal = document.getElementById('itemsModal');
const editarItemsBtn = document.getElementById('editarItemsBtn');
const cerrarItemsModalBtn = document.getElementById('cerrarItemsModal');
const cancelItemsBtn = document.getElementById('cancelItemsBtn');
const saveItemsBtn = document.getElementById('saveItemsBtn');
const itemsListEl = document.getElementById('itemsList');
const itemsLoadingEl = document.getElementById('itemsLoading');
const itemsStatusEl = document.getElementById('itemsStatus');

let itemsData = [];
const itemsApiUrl = `/info-box/${boxId}/items`;

let itemsCloseTimer = null;

const savingText = userLang === 'en' ? 'Saving...' : 'Guardando...';
const savedText = userLang === 'en' ? 'Saved successfully' : 'Guardado correctamente';
const saveErrorText = userLang === 'en' ? 'Error saving' : 'Error al guardar';
const networkErrorText = userLang === 'en' ? 'Network error' : 'Error de red';
const loadErrorText = userLang === 'en' ? 'Error loading items' : 'Error al cargar items';
const noRecordsText = userLang === 'en' ? 'No records.' : 'Sin registros.';

function openItemsModal(){
  if(itemsCloseTimer){ clearTimeout(itemsCloseTimer); itemsCloseTimer=null; }
  itemsModal.classList.remove('hidden');
  requestAnimationFrame(() => itemsModal.classList.add('fade-in'));
  loadItems();
}

function closeItemsModal(){
  itemsModal.classList.remove('fade-in');
  itemsCloseTimer = setTimeout(() => {
    itemsModal.classList.add('hidden');
  }, 230);
}

editarItemsBtn.addEventListener('click', openItemsModal);
cerrarItemsModalBtn.addEventListener('click', closeItemsModal);
cancelItemsBtn.addEventListener('click', closeItemsModal);
itemsModal.addEventListener('click', e => { if(e.target === itemsModal) closeItemsModal(); });

function renderItemsEditor(){
  itemsListEl.innerHTML = '';
  itemsData.forEach(item => {
    const card = document.createElement('div');
    card.className = 'border rounded-md p-3 flex flex-col gap-2 bg-gray-50/60';
    
    // Determinar el nombre traducido
    let displayName = item.nombre;
    if (item.translationKey) {
      const translatedKey = `infoBox.boxElements.${item.translationKey}`;
      // Si existe la traducción en el objeto window (desde el servidor)
      displayName = window.__i18n && window.__i18n[translatedKey] 
        ? window.__i18n[translatedKey] 
        : item.nombre;
    }
    
    card.innerHTML = `
      <div class="text-sm font-medium text-gray-800 line-clamp-2">${displayName}</div>
      <div class="flex items-center justify-between mt-1">
        <button type="button" class="dec px-2 py-1 rounded bg-white border text-gray-600 hover:bg-gray-100" data-id="${item.id}">-</button>
        <span class="cantidad font-semibold" data-id="${item.id}">${item.cantidad}</span>
        <button type="button" class="inc px-2 py-1 rounded bg-white border text-gray-600 hover:bg-gray-100" data-id="${item.id}">+</button>
      </div>`;
    itemsListEl.appendChild(card);
  });
  itemsListEl.classList.remove('hidden');
}

function loadItems(){
  itemsLoadingEl.classList.remove('hidden');
  itemsListEl.classList.add('hidden');
  fetch(itemsApiUrl, {headers:{'Accept':'application/json'}})
    .then(r => r.json())
    .then(data => {
      itemsData = data.items || [];
      renderItemsEditor();
      itemsLoadingEl.classList.add('hidden');
    })
    .catch(() => {
      itemsLoadingEl.textContent = loadErrorText;
    });
}

itemsListEl.addEventListener('click', e => {
  if(e.target.classList.contains('inc') || e.target.classList.contains('dec')){
    const id = e.target.getAttribute('data-id');
    const item = itemsData.find(i => String(i.id) === String(id));
    if(!item) return;
    if(e.target.classList.contains('inc')) item.cantidad += 1; 
    else item.cantidad = Math.max(0, item.cantidad - 1);
    const span = itemsListEl.querySelector(`span.cantidad[data-id="${id}"]`);
    if(span) span.textContent = item.cantidad;
  }
});

function guardarItems(){
  itemsStatusEl.textContent = savingText;
  fetch(itemsApiUrl, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({items: itemsData.map(i => ({id:i.id, cantidad:i.cantidad}))})
  })
  .then(r => r.json())
  .then(data => {
    if(data.ok){
      itemsStatusEl.textContent = savedText;
      // Actualizar lista en la tarjeta principal CON TRADUCCIONES
      const listaBox = document.getElementById('listaItemsBox');
      listaBox.innerHTML = '';
      const activos = data.items.filter(i => i.cantidad > 0);
      if(activos.length === 0){
        listaBox.innerHTML = `<p class="text-sm text-gray-500">${noRecordsText}</p>`;
      } else {
        activos.forEach(it => {
          const row = document.createElement('div');
          row.className='flex items-center justify-between text-sm border border-gray-100 rounded px-3 py-2';
          
          // Determinar nombre traducido
          let displayName = it.nombre;
          if (it.translationKey) {
            const translatedKey = `infoBox.boxElements.${it.translationKey}`;
            displayName = window.__i18n && window.__i18n[translatedKey] 
              ? window.__i18n[translatedKey] 
              : it.nombre;
          }
          
          row.innerHTML = `<span class='font-medium'>${displayName}</span><span class='text-gray-700'>x ${it.cantidad}</span>`;
          listaBox.appendChild(row);
        });
      }
      setTimeout(() => { closeItemsModal(); itemsStatusEl.textContent=''; }, 700);
    } else {
      itemsStatusEl.textContent = saveErrorText;
    }
  })
  .catch(() => { itemsStatusEl.textContent = networkErrorText; });
}

saveItemsBtn.addEventListener('click', guardarItems);

</script>

<!-- websocket client -->
<script>
(function() {
  const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${wsProto}://${window.location.host}`);
  
  ws.onopen = () => {
    console.log('info_box websocket conectado');
  };
  
  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      console.log('info_box websocket mensaje recibido:', data);
      
      const currentBoxId = '<%= box.idBox || box.idbox %>';
      console.log(`comparando box_id: "${data.box_id}" con currentBoxId: "${currentBoxId}"`);
      
      // si el cambio es de este box, recargar
      if (String(data.box_id) === String(currentBoxId)) {
        console.log('cambio detectado en este box, recargando página en 500ms...');
        setTimeout(() => window.location.reload(), 500);
      } else {
        console.log(`cambio es de otro box (${data.box_id}), no recargando`);
      }
    } catch (err) {
      console.error('error parseando mensaje websocket:', err);
    }
  };
  
  ws.onerror = (err) => {
    console.error('error websocket:', err);
  };
  
  ws.onclose = () => {
    console.log('websocket desconectado, reconectando en 3s...');
    setTimeout(() => window.location.reload(), 3000);
  };
})();
</script>

</body>
</html>