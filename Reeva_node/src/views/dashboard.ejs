<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= pageTitle || 'Dashboard Hospital' %></title>

  <!-- Tailwind + configuración de color primario -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#B4447C'
          }
        }
      }
    }
  </script>

  <!-- Iconos y librerías de gráficos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body class="font-sans min-h-screen flex flex-col">
  <%- include('header', { activePage: 'dashboard' }) %>

  <main class="container mx-auto px-4 py-6 md:py-10 space-y-6 md:space-y-10 max-w-7xl w-full">
    <input type="hidden" id="box-period-value" value="<%= selectedBoxPeriodValue %>">
    <input type="hidden" id="specialty-period-value" value="<%= selectedSpecialtyPeriodValue %>">
    <!-- KPIs principales -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
      <article class="bg-white border rounded-2xl md:rounded-3xl p-6 md:p-10 shadow-sm">
        <div class="flex justify-between items-center gap-4 md:gap-6">
          <div>
            <p class="text-xs md:text-sm text-gray-500">Total Boxes Ocupados</p>
            <p class="text-4xl md:text-7xl lg:text-8xl font-extrabold text-gray-900 leading-none mt-1 md:mt-2 occupied-count"><%= occupiedValue %></p>
          </div>
          <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-full bg-primary/10 text-primary">
            <i class="ri-hospital-line ri-2x md:ri-3x"></i>
          </div>
        </div>
      </article>

      <article class="bg-white border rounded-2xl md:rounded-3xl p-6 md:p-10 shadow-sm">
        <div class="flex justify-between items-center gap-4 md:gap-6">
          <div>
            <p class="text-xs md:text-sm text-gray-500">Boxes Disponibles</p>
            <p class="text-4xl md:text-7xl lg:text-8xl font-extrabold text-gray-900 leading-none mt-1 md:mt-2 available-count"><%= availableValue %></p>
          </div>
          <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-full bg-green-100 text-green-600">
            <i class="ri-checkbox-circle-line ri-2x md:ri-3x"></i>
          </div>
        </div>
      </article>
    </section>

    <!-- Donuts de estado -->
    <section class="bg-white rounded-2xl md:rounded-3xl shadow-sm p-6 md:p-10">
      <h2 class="text-2xl md:text-4xl font-semibold mb-6 md:mb-8">Estado de Boxes</h2>
      <div class="flex flex-wrap justify-center gap-6 md:gap-10">
        <% if (!hasLabelColors) { %>
          <p class="text-gray-500">Sin datos para mostrar.</p>
        <% } else { %>
          <% for (const item of labelColorsView) { %>
            <div class="text-center">
              <div id="donut-<%= item.chartId %>" class="w-32 h-32 md:w-44 md:h-44 lg:w-56 lg:h-56 mx-auto"></div>
              <p class="mt-3 md:mt-4 text-sm md:text-base lg:text-lg font-medium text-gray-700"><%= item.key %></p>
            </div>
          <% } %>
        <% } %>
      </div>
    </section>

    <!-- Modal de reporte -->
    <div id="reportModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-xl mx-4">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800">Configurar Reporte</h3>
            <button id="closeReportModal" class="text-gray-500 hover:text-gray-700">
              <i class="ri-close-line text-xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Formato</label>
              <div class="grid grid-cols-3 gap-3">
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="pdf">
                  <i class="ri-file-pdf-line text-2xl mb-1"></i>
                  <span class="text-sm">PDF</span>
                </button>
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="excel">
                  <i class="ri-file-excel-line text-2xl mb-1"></i>
                  <span class="text-sm">Excel</span>
                </button>
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="csv">
                  <i class="ri-file-text-line text-2xl mb-1"></i>
                  <span class="text-sm">CSV</span>
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Desde</label>
                <input type="date" class="w-full border border-gray-300 rounded-button px-3 py-2 text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Hasta</label>
                <input type="date" class="w-full border border-gray-300 rounded-button px-3 py-2 text-sm">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Especialidades</label>
              <div class="border border-gray-300 rounded-button p-3 max-h-32 overflow-y-auto space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm">Todas las especialidades</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm">Oftalmología</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm">Neurología</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm">Cardiología</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contenido del reporte</label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm">Estadísticas generales</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm">Gráficos de ocupación</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm">Detalle de boxes</span>
                </label>
              </div>
            </div>
          </div>
          <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelReportBtn" class="px-4 py-2 border border-gray-300 rounded-button text-gray-700 hover:bg-gray-50 whitespace-nowrap">Cancelar</button>
            <button id="confirmReportBtn" class="bg-primary text-white px-6 py-2 rounded-button hover:bg-primary/90 whitespace-nowrap flex items-center">
              <i class="ri-download-line mr-2"></i>
              Descargar Reporte
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs secundarios -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <article class="bg-white border rounded-lg p-5 shadow-sm flex flex-col gap-4">
        <div class="flex justify-between items-start gap-4">
          <div class="flex-1 min-w-0">
            <p class="text-xs md:text-sm text-gray-500 mb-1">Especialidad más ocupada</p>
            <% if (hasBestSpecialtyUsage) { %>
              <p class="text-lg md:text-2xl font-semibold leading-tight"><%= bestSpecialtyUsageData.nombre %></p>
              <div class="mt-1 text-xs text-gray-500">
                <%= bestSpecialtyUsageData.conteo ?? 0 %> agendas • <%= bestSpecialtyUsageData.porcentaje %>% del período
              </div>
            <% } else { %>
              <p class="text-lg font-semibold text-gray-400">Sin datos en este período</p>
              <div class="mt-1 text-xs text-gray-400">No hay agendamientos registrados.</div>
            <% } %>
          </div>
          <div class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 flex-shrink-0">
            <i class="ri-eye-line ri-lg"></i>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <% specialtyUsageOptions.forEach((option) => { %>
            <button type="button"
              class="px-3 py-1.5 rounded-full text-sm font-medium border transition-colors <%= option.active ? 'bg-primary text-white border-primary shadow-sm' : 'bg-white border-gray-200 text-gray-600 hover:border-primary hover:text-primary' %>"
              data-specialty-period="<%= option.value %>"
              aria-pressed="<%= option.active %>">
              <%= option.label %>
            </button>
          <% }) %>
        </div>

        <div class="text-xs text-gray-400">
          Período: <%= selectedSpecialtyPeriodDescription %>
        </div>
      </article>

      <article class="bg-white border rounded-lg p-5 shadow-sm flex flex-col gap-4">
        <div class="flex justify-between items-start gap-4">
          <div class="flex-1 min-w-0">
            <p class="text-xs md:text-sm text-gray-500 mb-1">Box más utilizado</p>
            <% if (hasBestBoxUsage) { %>
              <p class="text-lg md:text-2xl font-semibold leading-tight">Box #<%= bestBoxUsageData.numero %></p>
              <div class="mt-1 text-xs text-gray-500"><%= bestBoxUsageData.porcentaje %>% del tiempo ocupado</div>
            <% } else { %>
              <p class="text-lg font-semibold text-gray-400">Sin datos en este período</p>
              <div class="mt-1 text-xs text-gray-400">No hay agendamientos registrados.</div>
            <% } %>
          </div>
          <div class="w-10 h-10 flex items-center justify-center rounded-full bg-amber-100 text-amber-500 flex-shrink-0">
            <i class="ri-star-line ri-lg"></i>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <% boxUsageOptions.forEach((option) => { %>
            <button type="button"
              class="px-3 py-1.5 rounded-full text-sm font-medium border transition-colors <%= option.active ? 'bg-primary text-white border-primary shadow-sm' : 'bg-white border-gray-200 text-gray-600 hover:border-primary hover:text-primary' %>"
              data-box-period="<%= option.value %>"
              aria-pressed="<%= option.active %>">
              <%= option.label %>
            </button>
          <% }) %>
        </div>

        <div class="text-xs text-gray-400">
          Período: <%= selectedBoxPeriodDescription %>
        </div>
      </article>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <article class="bg-white rounded shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-4">Número de Box por especialidad</h2>
        <div id="horizontal-bar-chart" style="height: 240px;"></div>
        <script id="etiquetas-especialidad" type="application/json"><%- JSON.stringify(etiquetasEspecialidadList) %></script>
        <script id="valores-especialidad" type="application/json"><%- JSON.stringify(valoresEspecialidadList) %></script>
      </article>

      <article class="bg-white rounded shadow-sm p-6">
        <form id="form-horas" method="get" action="/dashboard" class="space-y-6">
          <div>
            <label for="prof_code" class="block text-sm font-medium mb-1">Profesional</label>
            <select id="prof_code" name="prof_code" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white">
              <option value="">-- Todos los doctores --</option>
              <% doctoresList.forEach((doc) => { const value = doc.idusuario ?? doc.idUsuario ?? ''; %>
                <option value="<%= value %>" <%= value && value.toString() === profSeleccionado ? 'selected' : '' %>>
                  <%= doc.nombreprofesional || doc.nombre || 'Profesional' %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="box_number" class="block text-sm font-medium mb-1">Box</label>
            <select id="box_number" name="box_number" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white">
              <option value="">-- Seleccione un box --</option>
              <% boxesList.forEach((b) => { const numero = b.numero ?? b.idBox ?? ''; %>
                <option value="<%= numero %>" <%= numero && numero.toString() === boxSeleccionado ? 'selected' : '' %>>
                  Box <%= numero %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="fecha" class="block text-sm font-medium mb-1">Fecha</label>
            <input id="fecha" name="fecha" type="date" value="<%= fechaSeleccionada %>" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white" />
          </div>
          <div class="pt-2 flex justify-end">
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90 transition">Buscar</button>
          </div>
        </form>

        <div class="mt-8">
          <canvas id="bar-chart" height="120"></canvas>
          <div class="mt-4 space-y-1 text-sm text-gray-700">
            <p><strong>Horas agendadas:</strong> <span id="txt-horas-agendadas"><%= horasAgendadasText %></span></p>
            <p><strong>Horas realizadas:</strong> <span id="txt-horas-realizadas"><%= horasRealizadasText %></span></p>
          </div>
        </div>
      </article>
    </section>

    <section class="bg-white rounded shadow-sm p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl font-semibold">Tendencia mensual por especialidad</h2>
          <p class="text-sm text-gray-500">Cantidad de agendas cerradas por mes</p>
        </div>
        <div class="flex items-center gap-3">
          <label for="specialty-trend-select" class="text-sm font-medium text-gray-600">Especialidad</label>
          <select id="specialty-trend-select" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
            <% specialtyTrendOptions.forEach((label) => { %>
              <option value="<%= label %>" <%= label === specialtyTrendDefault ? 'selected' : '' %>><%= label %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="w-full overflow-x-auto">
        <div id="specialty-trend-chart" class="min-w-[320px] h-[18rem] md:h-[20rem]"></div>
      </div>
      <script id="specialty-trend-labels" type="application/json"><%- JSON.stringify(specialtyTrendLabels) %></script>
      <script id="specialty-trend-series" type="application/json"><%- JSON.stringify(specialtyTrendSeries) %></script>
      <script id="specialty-trend-default" type="application/json"><%- JSON.stringify(specialtyTrendDefault) %></script>
    </section>

    <section class="bg-white rounded shadow-sm p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl font-semibold">Agendas finalizadas por día de la semana</h2>
          <p class="text-sm text-gray-500">Últimos 7 días, solo agendas finalizadas</p>
        </div>
        <form id="form-dias" method="get" class="flex flex-col md:flex-row md:items-center md:space-x-3 space-y-3 md:space-y-0">
          <label for="especialidad" class="text-sm font-medium text-gray-600">Especialidad</label>
          <select name="especialidad" id="especialidad" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
            <% const weeklyOptions = Object.keys(weeklySpecialtySeries || {}); %>
            <% if ((weeklySpecialtySeries || {})['Todas']) { %>
              <option value="Todas" <%= (especSeleccionada === 'Todas' || (!especSeleccionada && weeklySpecialtyDefault === 'Todas')) ? 'selected' : '' %>>Todas</option>
            <% } %>
            <% (weeklyOptions.length ? weeklyOptions : especialidades)
              .filter((esp) => esp !== 'Todas')
              .forEach((esp) => { %>
              <option value="<%= esp %>" <%= esp === (especSeleccionada || weeklySpecialtyDefault) ? 'selected' : '' %>><%= esp %></option>
            <% }) %>
          </select>
          <input type="hidden" name="fecha" value="<%= fechaSeleccionada %>">
          <input type="hidden" name="prof_code" value="<%= profSeleccionado %>">
          <input type="hidden" name="box_number" value="<%= boxSeleccionado %>">
          <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-sm font-medium">Filtrar</button>
        </form>
      </div>
      <div class="w-full overflow-x-auto">
        <canvas id="weekly-trend-chart" height="140"></canvas>
      </div>
      <script id="weekly-labels" type="application/json"><%- JSON.stringify(weeklySpecialtyLabels) %></script>
      <script id="weekly-series" type="application/json"><%- JSON.stringify(weeklySpecialtySeries) %></script>
      <script id="weekly-default" type="application/json"><%- JSON.stringify(weeklySpecialtyDefault || especSeleccionada || null) %></script>
    </section>

    <div class="pt-4 flex justify-center">
      <a href="/reporte" class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90 transition inline-flex items-center">
        <i class="ri-file-excel-2-line mr-2"></i>
        Descargar Reporte Excel
      </a>
    </div>
  </main>

  <%- include('footer') %>

  <script id="total-boxes-count" type="application/json"><%- JSON.stringify(totalBoxesData) %></script>
  <script id="estado-percentages" type="application/json"><%- JSON.stringify(estadoPercentagesData) %></script>
  <script id="estado-counts" type="application/json"><%- JSON.stringify(estadoCountsData) %></script>

  <script>
    const estado = JSON.parse(document.getElementById('estado-percentages').textContent || '{}');
    const estadoCounts = JSON.parse(document.getElementById('estado-counts').textContent || '{}');
    const totalBoxes = Number(JSON.parse(document.getElementById('total-boxes-count').textContent || '0')) || 0;
    <% for (const item of labelColorsView) { %>
      (function() {
        const keyName = <%- JSON.stringify(item.key) %>;
        const colorHex = <%- JSON.stringify(item.color) %>;
        const chartEl = document.getElementById('donut-<%= item.chartId %>');
        if (!chartEl) return;
        const chart = echarts.init(chartEl);
        chart.setOption({
          tooltip: {
            trigger: 'item',
            formatter: function(params) {
              const coloredCount = estadoCounts[keyName] || 0;
              const grayCount = Math.max(totalBoxes - coloredCount, 0);
              const isColored = params.dataIndex === 0;
              const label = isColored ? keyName : `No ${keyName.toLowerCase()}`;
              const value = isColored ? coloredCount : grayCount;
              return label + ': ' + value + ' boxes';
            }
          },
          series: [{
            type: 'pie',
            radius: ['65%', '85%'],
            avoidLabelOverlap: false,
            label: {
              show: true,
              position: 'center',
              formatter: (estado[keyName] || 0) + '%',
              fontSize: 22,
              fontWeight: '800',
              color: '#111827'
            },
            data: [
              { value: estado[keyName] || 0, itemStyle: { color: colorHex } },
              { value: 100 - (estado[keyName] || 0), itemStyle: { color: '#f3f4f6' } }
            ]
          }]
        });
        window.addEventListener('resize', () => chart.resize());
      })();
    <% } %>

    const ag = parseFloat('<%= horasAgendadasFloatValue %>') || 0;
    const re = parseFloat('<%= horasRealizadasFloatValue %>') || 0;
    const barCtx = document.getElementById('bar-chart').getContext('2d');
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ['Agendadas', 'Realizadas'],
        datasets: [{
          data: [ag, re],
          backgroundColor: ['#38b2ac', '#4299e1'],
          borderRadius: 4
        }]
      },
      options: {
        animation: false,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: Math.max(ag, re) * 1.1 || 1,
            ticks: {
              callback: (value) => value + 'h'
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => (Number(context.parsed.y).toFixed(2)) + ' horas'
            }
          }
        }
      }
    });

    const etiquetasEsp = JSON.parse(document.getElementById('etiquetas-especialidad').textContent || '[]');
    const valoresEsp = JSON.parse(document.getElementById('valores-especialidad').textContent || '[]');
    const horizontalBar = echarts.init(document.getElementById('horizontal-bar-chart'));
    horizontalBar.setOption({
      animation: false,
      grid: { left: '25%', right: '4%', bottom: '6%', top: '6%' },
      xAxis: {
        type: 'value',
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { show: false },
        splitLine: { show: false }
      },
      yAxis: {
        type: 'category',
        data: etiquetasEsp,
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { color: '#6b7280' }
      },
      series: [{
        name: 'Boxes',
        type: 'bar',
        data: valoresEsp,
        barWidth: '60%',
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: '#20B2AA' },
            { offset: 1, color: '#5fd0cb' }
          ]),
          borderRadius: [0, 4, 4, 0]
        }
      }],
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        backgroundColor: 'rgba(255,255,255,0.9)',
        borderColor: '#e5e7eb',
        textStyle: { color: '#1f2937' }
      }
    });
    window.addEventListener('resize', () => horizontalBar.resize());

    /* Weekly data managed via Chart.js */
    let applyWeeklyData;

    (function() {
      const formHoras = document.getElementById('form-horas');
      const formDias = document.getElementById('form-dias');
      const txtAg = document.getElementById('txt-horas-agendadas');
      const txtRe = document.getElementById('txt-horas-realizadas');
      let weeklyTrendSelectEl = null;
      let weeklyTrendLabels = [];
      let weeklyTrendSeries = {};
      let weeklyLineChart = null;

      applyWeeklyData = function(label) {
        if (!weeklyLineChart || !label) return;
        const dataset = weeklyTrendSeries[label] || Array(weeklyTrendLabels.length).fill(0);
        weeklyLineChart.data.labels = weeklyTrendLabels;
        weeklyLineChart.data.datasets[0].data = dataset;
        weeklyLineChart.data.datasets[0].label = label;
        weeklyLineChart.update('none');
        if (weeklyTrendSelectEl && weeklyTrendSelectEl.value !== label) {
          weeklyTrendSelectEl.value = label;
        }
      }

      function buildParams() {
        const prof = document.getElementById('prof_code')?.value || '';
        const box = document.getElementById('box_number')?.value || '';
        const fecha = document.getElementById('fecha')?.value || '';
        const espec = document.getElementById('especialidad')?.value || 'Todas';
        const boxPeriod = document.getElementById('box-period-value')?.value || '';
        const specialtyPeriod = document.getElementById('specialty-period-value')?.value || '';
        const params = new URLSearchParams();
        if (prof) params.set('prof_code', prof);
        if (box) params.set('box_number', box);
        if (fecha) params.set('fecha', fecha);
        if (espec) params.set('especialidad', espec);
        if (boxPeriod) params.set('box_period', boxPeriod);
        if (specialtyPeriod) params.set('specialty_period', specialtyPeriod);
        return params.toString();
      }

     function updateFromData(data) {
        weeklyTrendSelectEl = weeklyTrendSelectEl || document.getElementById('especialidad');
        if (txtAg) txtAg.textContent = data.horas_agendadas ?? '0';
        if (txtRe) txtRe.textContent = data.horas_realizadas ?? '0';
        const a = parseFloat(data.horas_agendadas_float || 0);
        const r = parseFloat(data.horas_realizadas_float || 0);
        barChart.data.datasets[0].data = [a, r];
        barChart.options.scales.y.suggestedMax = Math.max(a, r) * 1.1 || 1;
        barChart.update('none');

        if (data.weekly_labels && data.weekly_series) {
          weeklyTrendLabels = data.weekly_labels || [];
          weeklyTrendSeries = data.weekly_series || {};
          const defaultLabel =
            data.weekly_default ||
            weeklyTrendSelectEl?.value ||
            Object.keys(weeklyTrendSeries)[0] ||
            null;

          if (weeklyTrendSelectEl) {
            weeklyTrendSelectEl.innerHTML = '';
            const optionLabels = Object.keys(weeklyTrendSeries).sort((a, b) => {
              if (a === 'Todas') return -1;
              if (b === 'Todas') return 1;
              return a.localeCompare(b, 'es', { sensitivity: 'base' });
            });
            optionLabels.forEach((label) => {
              const option = document.createElement('option');
              option.value = label;
              option.textContent = label;
              weeklyTrendSelectEl.appendChild(option);
            });
          }

          if (defaultLabel) {
            applyWeeklyData(defaultLabel);
          } else if (weeklyTrendSelectEl && weeklyTrendSelectEl.value) {
            applyWeeklyData(weeklyTrendSelectEl.value);
          }
        }
      }

      async function fetchAndUpdate(event) {
        if (event) event.preventDefault();
        const query = buildParams();
        const url = `${window.location.pathname}${query ? '?' + query : ''}`;
        window.history.replaceState(null, '', url);
        try {
          const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!response.ok) throw new Error('Error al obtener datos');
          const data = await response.json();
          requestAnimationFrame(() => updateFromData(data));
        } catch (error) {
          console.error(error);
        }
      }

      formHoras?.addEventListener('submit', fetchAndUpdate);
      formDias?.addEventListener('submit', fetchAndUpdate);
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const boxPeriodButtons = document.querySelectorAll('[data-box-period]');
      const boxPeriodValueEl = document.getElementById('box-period-value');
      if (boxPeriodButtons.length) {
        boxPeriodButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const params = new URLSearchParams(window.location.search);
            params.set('box_period', button.dataset.boxPeriod);
            if (boxPeriodValueEl) {
              boxPeriodValueEl.value = button.dataset.boxPeriod;
            }
            window.location.search = params.toString();
          });
        });
      }

      const specialtyPeriodButtons = document.querySelectorAll('[data-specialty-period]');
      const specialtyPeriodValueEl = document.getElementById('specialty-period-value');
      if (specialtyPeriodButtons.length) {
        specialtyPeriodButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const params = new URLSearchParams(window.location.search);
            params.set('specialty_period', button.dataset.specialtyPeriod);
            if (specialtyPeriodValueEl) {
              specialtyPeriodValueEl.value = button.dataset.specialtyPeriod;
            }
            window.location.search = params.toString();
          });
        });
      }

      weeklyTrendSelectEl = document.getElementById('especialidad');
      const weeklyLabelsEl = document.getElementById('weekly-labels');
      const weeklySeriesEl = document.getElementById('weekly-series');
      const weeklyDefaultEl = document.getElementById('weekly-default');
      const weeklyCanvas = document.getElementById('weekly-trend-chart');
      if (weeklyCanvas && weeklyLabelsEl && weeklySeriesEl) {
        weeklyTrendLabels = JSON.parse(weeklyLabelsEl.textContent || '[]');
        weeklyTrendSeries = JSON.parse(weeklySeriesEl.textContent || '{}');
        const weeklyCtx = weeklyCanvas.getContext('2d');
        const gradientWeekly = weeklyCtx.createLinearGradient(0, 0, 0, 220);
        gradientWeekly.addColorStop(0, 'rgba(180, 68, 124, 0.65)');
        gradientWeekly.addColorStop(1, 'rgba(180, 68, 124, 0.12)');

        weeklyLineChart = new Chart(weeklyCtx, {
          type: 'bar',
          data: {
            labels: weeklyTrendLabels,
            datasets: [{
              label: 'Agendas finalizadas',
              data: Array(weeklyTrendLabels.length).fill(0),
              backgroundColor: gradientWeekly,
              borderRadius: 6,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#64748b', maxRotation: 0 },
              },
              y: {
                beginAtZero: true,
                grid: { color: '#f1f5f9' },
                ticks: {
                  color: '#64748b',
                  precision: 0,
                },
                title: {
                  display: true,
                  text: 'Agendas',
                  color: '#475569',
                  font: { size: 12, weight: '600' },
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                displayColors: false,
                padding: 10,
                backgroundColor: '#0f172a',
                callbacks: {
                  title: (items) => items[0]?.label || '',
                  label: (context) => `${context.parsed.y || 0} agendas finalizadas`,
                },
              },
            },
          },
        });

        const initialWeekly = JSON.parse(weeklyDefaultEl?.textContent || 'null')
          || weeklyTrendSelectEl?.value
          || Object.keys(weeklyTrendSeries)[0]
          || null;

        if (weeklyTrendSelectEl && initialWeekly) {
          weeklyTrendSelectEl.value = initialWeekly;
          weeklyTrendSelectEl.addEventListener('change', (event) => {
            applyWeeklyData(event.target.value);
          });
        }

        if (initialWeekly) {
          applyWeeklyData(initialWeekly);
        }
      }

      const specialtyTrendLabelsEl = document.getElementById('specialty-trend-labels');
      const specialtyTrendSeriesEl = document.getElementById('specialty-trend-series');
      const specialtyTrendDefaultEl = document.getElementById('specialty-trend-default');
      const specialtyTrendSelect = document.getElementById('specialty-trend-select');
      const specialtyTrendContainer = document.getElementById('specialty-trend-chart');
      if (specialtyTrendLabelsEl && specialtyTrendSeriesEl && specialtyTrendContainer) {
        const trendLabels = JSON.parse(specialtyTrendLabelsEl.textContent || '[]');
        const trendSeries = JSON.parse(specialtyTrendSeriesEl.textContent || '{}');
        const seriesKeys = Object.keys(trendSeries);
        const resolveLabel = (label) => {
          if (label && trendSeries[label]) return label;
          if (trendSeries['Todas']) return 'Todas';
          return seriesKeys[0] || null;
        };
        const toNumericSeries = (values = []) =>
          trendLabels.map((_, index) => {
            const value = Array.isArray(values) ? values[index] : 0;
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
          });

        let currentSpecialty = resolveLabel(
          JSON.parse(specialtyTrendDefaultEl?.textContent || 'null')
            || specialtyTrendSelect?.value
            || seriesKeys[0]
            || null
        );

        if (specialtyTrendSelect && currentSpecialty) {
          specialtyTrendSelect.value = currentSpecialty;
        }

        const specialtyTrendChart = echarts.init(specialtyTrendContainer);
        const renderSpecialtyTrend = (label) => {
          const selected = resolveLabel(label);
          const data = toNumericSeries(trendSeries[selected]);
          const maxValue = data.reduce((acc, value) => Math.max(acc, value), 0);
          specialtyTrendChart.setOption({
            color: ['#B4447C'],
            grid: { left: '3%', right: '4%', bottom: '5%', containLabel: true },
            tooltip: {
              trigger: 'axis',
              backgroundColor: 'rgba(15, 23, 42, 0.92)',
              borderWidth: 0,
              padding: 12,
              textStyle: { color: '#f8fafc' },
              formatter: (params = []) => {
                const item = params[0];
                if (!item) return '';
                const value = Number(item.value || 0);
                return `${item.axisValue}<br/>${value} agendas`;
              },
            },
            xAxis: {
              type: 'category',
              data: trendLabels,
              boundaryGap: false,
              axisLine: { lineStyle: { color: '#e2e8f0' } },
              axisLabel: { color: '#64748b' },
              axisTick: { alignWithLabel: true },
            },
            yAxis: {
              type: 'value',
              min: 0,
              max: maxValue === 0 ? 1 : undefined,
              axisLine: { show: false },
              axisTick: { show: false },
              axisLabel: { color: '#64748b', precision: 0 },
              splitLine: { lineStyle: { color: '#e2e8f0' } },
            },
            series: [
              {
                name: selected || 'Especialidad',
                type: 'line',
                smooth: true,
                showSymbol: true,
                symbolSize: 7,
                lineStyle: { width: 3, color: '#B4447C' },
                areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(180, 68, 124, 0.35)' },
                    { offset: 1, color: 'rgba(180, 68, 124, 0.05)' },
                  ]),
                },
                data,
              },
            ],
          });
          currentSpecialty = selected;
          if (specialtyTrendSelect && selected) {
            specialtyTrendSelect.value = selected;
          }
        };

        renderSpecialtyTrend(currentSpecialty);
        specialtyTrendSelect?.addEventListener('change', (event) => {
          renderSpecialtyTrend(event.target.value);
        });
        window.addEventListener('resize', () => specialtyTrendChart.resize());
      }

      const reportModal = document.getElementById('reportModal');
      const closeReportModal = document.getElementById('closeReportModal');
      const cancelReportBtn = document.getElementById('cancelReportBtn');
      const confirmReportBtn = document.getElementById('confirmReportBtn');
      const formatBtns = document.querySelectorAll('.format-btn');
      let selectedFormat = null;

      function showModal() {
        reportModal?.classList.remove('hidden');
        reportModal?.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }

      function hideModal() {
        reportModal?.classList.add('hidden');
        reportModal?.classList.remove('flex');
        document.body.style.overflow = '';
      }

      document.getElementById('generateReportBtn')?.addEventListener('click', showModal);
      closeReportModal?.addEventListener('click', hideModal);
      cancelReportBtn?.addEventListener('click', hideModal);

      formatBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          formatBtns.forEach((b) => {
            b.classList.remove('border-primary', 'text-primary');
            b.classList.add('border-gray-300');
          });
          btn.classList.remove('border-gray-300');
          btn.classList.add('border-primary', 'text-primary');
          selectedFormat = btn.dataset.format;
        });
      });

      confirmReportBtn?.addEventListener('click', () => {
        if (!selectedFormat) {
          alert('Selecciona un formato antes de descargar.');
          return;
        }
        hideModal();
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-green-50 text-green-800 px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2';
        notification.innerHTML = '<i class="ri-checkbox-circle-line text-xl"></i><span>El reporte se está generando...</span>';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      });

      reportModal?.addEventListener('click', (event) => {
        if (event.target === reportModal) hideModal();
      });

      const mobileBtn = document.getElementById('mobile-menu-btn');
      const closeBtn = document.querySelector('#mobileMenu button');
      const overlay = document.getElementById('mobileMenuOverlay');

      function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        const overlayEl = document.getElementById('mobileMenuOverlay');
        if (menu && overlayEl) {
          menu.classList.toggle('translate-x-full');
          overlayEl.classList.toggle('hidden');
        }
      }

      mobileBtn?.addEventListener('click', toggleMobileMenu);
      closeBtn?.addEventListener('click', toggleMobileMenu);
      overlay?.addEventListener('click', toggleMobileMenu);

      const perfilBtn = document.getElementById('perfil-btn');
      const perfilMenu = document.getElementById('perfil-menu');
      perfilBtn?.addEventListener('click', (event) => {
        event.preventDefault();
        perfilMenu?.classList.toggle('hidden');
      });

      document.addEventListener('click', (event) => {
        if (perfilBtn && perfilMenu && !perfilBtn.contains(event.target) && !perfilMenu.contains(event.target)) {
          perfilMenu.classList.add('hidden');
        }
      });
    });
  </script>

  <script>
    const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/box/`);

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const newStateText = data.new_state_text;
      if (!newStateText) return;
      if (newStateText === 'Finalizado' || newStateText === 'Paciente Ausente') {
        const ocupadosEl = document.querySelector('.occupied-count');
        const disponiblesEl = document.querySelector('.available-count');
        if (ocupadosEl && disponiblesEl) {
          const ocupados = parseInt(ocupadosEl.textContent, 10) || 0;
          const disponibles = parseInt(disponiblesEl.textContent, 10) || 0;
          if (newStateText === 'Finalizado') {
            ocupadosEl.textContent = Math.max(ocupados - 1, 0);
            disponiblesEl.textContent = disponibles + 1;
          }
          if (newStateText === 'Paciente Ausente') {
            ocupadosEl.textContent = ocupados + 1;
            disponiblesEl.textContent = Math.max(disponibles - 1, 0);
          }
        }
      }
    };

    socket.onclose = function() {
      console.warn('WebSocket cerrado inesperadamente');
    };
  </script>
</body>
</html>
