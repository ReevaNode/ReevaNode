<!DOCTYPE html>
<html lang="<%= userLang %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= pageTitle || __('dashboard.title') %></title>
  <!-- Tailwind + configuración de color primario -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#B4447C'
          }
        }
      }
    }
  </script>
  <style>
    body:not(.translations-ready) [data-box-period],
    body:not(.translations-ready) [data-specialty-period],
    body:not(.translations-ready) #best-box-period,
    body:not(.translations-ready) #best-specialty-period,
    body:not(.translations-ready) #prof_code option[value=""],
    body:not(.translations-ready) #box_number option[value=""],
    body:not(.translations-ready) #weekly-year option[value=""],
    body:not(.translations-ready) #weekly-month option[value=""],
    body:not(.translations-ready) #especialidad option[value="Todas"],
    body:not(.translations-ready) #specialty-trend-select option[value="Todas"],
    body:not(.translations-ready) [id^="donut-"] + p {
      opacity: 0;
    }
    
    body.translations-ready [data-box-period],
    body.translations-ready [data-specialty-period],
    body.translations-ready #best-box-period,
    body.translations-ready #best-specialty-period,
    body.translations-ready #prof_code option[value=""],
    body.translations-ready #box_number option[value=""],
    body.translations-ready #weekly-year option[value=""],
    body.translations-ready #weekly-month option[value=""],
    body.translations-ready #especialidad option[value="Todas"],
    body.translations-ready #specialty-trend-select option[value="Todas"],
    body.translations-ready [id^="donut-"] + p {
      opacity: 1;
      transition: opacity 0.15s ease-in;
    }
  </style>
  <script>
    (function() {
      'use strict';
      
      function getTranslation(key) {
        const lang = localStorage.getItem('reeva-language') || 'es';
        
        const translations = {
          es: {
            'chart.boxes': 'Boxes',
            'chart.schedules': 'agendas',
            'chart.scheduled': 'Agendadas',
            'chart.completed': 'Realizadas',
            'chart.hours': 'horas',
            'weekdays.monday': 'Lunes',
            'weekdays.tuesday': 'Martes',
            'weekdays.wednesday': 'Miércoles',
            'weekdays.thursday': 'Jueves',
            'weekdays.friday': 'Viernes',
            'weekdays.saturday': 'Sábado',
            'weekdays.sunday': 'Domingo',
            'periods.today': 'Hoy',
            'periods.week': 'Semana',
            'periods.month': 'Mes',
            'periods.year': 'Año',
            'dashboard.noDataPeriod': 'Sin datos en este período',
            'dashboard.noSchedules': 'No hay agendamientos registrados.',
            'dashboard.schedulesCount': 'agendas',
            'dashboard.ofPeriod': 'del período',
            'dashboard.timeOccupied': 'del tiempo ocupado',
            'dashboard.period': 'Período',
            'dashboard.all': 'Todos',
            'dashboard.allDoctors': '-- Todos los doctores --',
            'dashboard.selectBox': '-- Seleccione un box --',
            'dashboard.noDataSelectedPeriod': 'Sin datos para el período seleccionado.',
            'dashboard.allSpecialties': 'Todas',
            'dashboard.occupied': 'Ocupado',
            'dashboard.available': 'Disponible',
            'dashboard.disabled': 'Inhabilitado',
            'dashboard.notOccupied': 'No ocupado',
            'dashboard.notAvailable': 'No disponible',
            'dashboard.notDisabled': 'No inhabilitado',
            'months.january': 'Enero',
            'months.february': 'Febrero',
            'months.march': 'Marzo',
            'months.april': 'Abril',
            'months.may': 'Mayo',
            'months.june': 'Junio',
            'months.july': 'Julio',
            'months.august': 'Agosto',
            'months.september': 'Septiembre',
            'months.october': 'Octubre',
            'months.november': 'Noviembre',
            'months.december': 'Diciembre'
          },
          en: {
            'chart.boxes': 'Boxes',
            'chart.schedules': 'schedules',
            'chart.scheduled': 'Scheduled',
            'chart.completed': 'Completed',
            'chart.hours': 'hours',
            'weekdays.monday': 'Monday',
            'weekdays.tuesday': 'Tuesday',
            'weekdays.wednesday': 'Wednesday',
            'weekdays.thursday': 'Thursday',
            'weekdays.friday': 'Friday',
            'weekdays.saturday': 'Saturday',
            'weekdays.sunday': 'Sunday',
            'periods.today': 'Today',
            'periods.week': 'Week',
            'periods.month': 'Month',
            'periods.year': 'Year',
            'dashboard.noDataPeriod': 'No data in this period',
            'dashboard.noSchedules': 'No appointments registered.',
            'dashboard.schedulesCount': 'schedules',
            'dashboard.ofPeriod': 'of the period',
            'dashboard.timeOccupied': 'of time occupied',
            'dashboard.period': 'Period',
            'dashboard.all': 'All',
            'dashboard.allDoctors': '-- All doctors --',
            'dashboard.selectBox': '-- Select a box --',
            'dashboard.noDataSelectedPeriod': 'No data for the selected period.',
            'dashboard.allSpecialties': 'All',
            'dashboard.occupied': 'Occupied',
            'dashboard.available': 'Available',
            'dashboard.disabled': 'Disabled',
            'dashboard.notOccupied': 'Not occupied',
            'dashboard.notAvailable': 'Not available',
            'dashboard.notDisabled': 'Not disabled',
            'months.january': 'January',
            'months.february': 'February',
            'months.march': 'March',
            'months.april': 'April',
            'months.may': 'May',
            'months.june': 'June',
            'months.july': 'July',
            'months.august': 'August',
            'months.september': 'September',
            'months.october': 'October',
            'months.november': 'November',
            'months.december': 'December'
          }
        };
        
        return translations[lang]?.[key] || key;
      }
      
      function getWeekdayLabels() {
        return [
          getTranslation('weekdays.monday'),
          getTranslation('weekdays.tuesday'),
          getTranslation('weekdays.wednesday'),
          getTranslation('weekdays.thursday'),
          getTranslation('weekdays.friday'),
          getTranslation('weekdays.saturday'),
          getTranslation('weekdays.sunday')
        ];
      }
      
      window.dashboardI18n = {
        translate: getTranslation,
        getWeekdayLabels: getWeekdayLabels
      };
    })();
  </script>
  <!-- Iconos y librerías de gráficos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body class="font-sans min-h-screen flex flex-col">
  <%- include('header', { activePage: 'dashboard' }) %>
  <main class="container mx-auto px-4 py-6 md:py-10 space-y-6 md:space-y-10 max-w-7xl w-full">
    <input type="hidden" id="box-period-value" value="<%= selectedBoxPeriodValue %>">
    <input type="hidden" id="specialty-period-value" value="<%= selectedSpecialtyPeriodValue %>">

    <!-- Selector de empresa -->
    <section class="bg-white border rounded-2xl md:rounded-3xl shadow-sm p-4 md:p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Empresa activa</p>
          <h1 class="text-xl md:text-2xl font-semibold text-gray-900">
            <%= selectedEmpresaNombre || 'Sin empresa seleccionada' %>
          </h1>
        </div>
        <% if ((empresasList || []).length > 1) { %>
        <div class="flex items-center gap-2 overflow-x-auto pb-1">
          <% empresasList.forEach(function(emp) { 
               const isActive = String(emp.empresaId) === String(selectedEmpresaId);
          %>
            <a href="/dashboard?empresaId=<%= emp.empresaId %>"
               class="px-4 py-2 rounded-full text-sm font-medium border transition-colors whitespace-nowrap <%= isActive ? 'bg-primary text-white border-primary' : 'bg-white text-gray-700 border-gray-200 hover:border-primary hover:text-primary' %>">
              <%= emp.nombre || emp.empresaId %>
            </a>
          <% }) %>
        </div>
        <% } %>
      </div>
    </section>
    
    <!-- KPIs principales -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
      <article class="bg-white border rounded-2xl md:rounded-3xl p-6 md:p-10 shadow-sm">
        <div class="flex justify-between items-center gap-4 md:gap-6">
          <div>
            <p class="text-xs md:text-sm text-gray-500" data-i18n="dashboard.occupiedBoxes"><%= __('dashboard.occupiedBoxes') %></p>
            <p class="text-4xl md:text-7xl lg:text-8xl font-extrabold text-gray-900 leading-none mt-1 md:mt-2 occupied-count"><%= occupiedValue %></p>
          </div>
          <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-full bg-primary/10 text-primary">
            <i class="ri-hospital-line ri-2x md:ri-3x"></i>
          </div>
        </div>
      </article>
      <article class="bg-white border rounded-2xl md:rounded-3xl p-6 md:p-10 shadow-sm">
        <div class="flex justify-between items-center gap-4 md:gap-6">
          <div>
            <p class="text-xs md:text-sm text-gray-500" data-i18n="dashboard.availableBoxes"><%= __('dashboard.availableBoxes') %></p>
            <p class="text-4xl md:text-7xl lg:text-8xl font-extrabold text-gray-900 leading-none mt-1 md:mt-2 available-count"><%= availableValue %></p>
          </div>
          <div class="w-12 h-12 md:w-16 md:h-16 flex items-center justify-center rounded-full bg-green-100 text-green-600">
            <i class="ri-checkbox-circle-line ri-2x md:ri-3x"></i>
          </div>
        </div>
      </article>
    </section>
    
    <!-- Donuts de estado -->
    <section class="bg-white rounded-2xl md:rounded-3xl shadow-sm p-6 md:p-10">
      <h2 class="text-2xl md:text-4xl font-semibold mb-6 md:mb-8" data-i18n="dashboard.boxStatus"><%= __('dashboard.boxStatus') %></h2>
      <div class="flex flex-wrap justify-center gap-6 md:gap-10">
        <% if (!hasLabelColors) { %>
          <p class="text-gray-500" data-i18n="dashboard.noData"><%= __('dashboard.noData') %></p>
        <% } else { %>
          <% for (const item of labelColorsView) { %>
            <div class="text-center">
              <div id="donut-<%= item.chartId %>" class="w-32 h-32 md:w-44 md:h-44 lg:w-56 lg:h-56 mx-auto"></div>
              <p class="mt-3 md:mt-4 text-sm md:text-base lg:text-lg font-medium text-gray-700"><%= item.key %></p>
            </div>
          <% } %>
        <% } %>
      </div>
    </section>
    
    <!-- Modal de reporte -->
    <div id="reportModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-xl mx-4">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800" data-i18n="dashboard.report.modalTitle"><%= __('dashboard.report.modalTitle') %></h3>
            <button id="closeReportModal" class="text-gray-500 hover:text-gray-700">
              <i class="ri-close-line text-xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="dashboard.report.format"><%= __('dashboard.report.format') %></label>
              <div class="grid grid-cols-3 gap-3">
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="pdf">
                  <i class="ri-file-pdf-line text-2xl mb-1"></i>
                  <span class="text-sm">PDF</span>
                </button>
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="excel">
                  <i class="ri-file-excel-line text-2xl mb-1"></i>
                  <span class="text-sm">Excel</span>
                </button>
                <button class="border border-gray-300 rounded-button p-3 flex flex-col items-center hover:border-primary hover:text-primary format-btn" data-format="csv">
                  <i class="ri-file-text-line text-2xl mb-1"></i>
                  <span class="text-sm">CSV</span>
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1" data-i18n="dashboard.report.dateFrom"><%= __('dashboard.report.dateFrom') %></label>
                <input type="date" class="w-full border border-gray-300 rounded-button px-3 py-2 text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1" data-i18n="dashboard.report.dateTo"><%= __('dashboard.report.dateTo') %></label>
                <input type="date" class="w-full border border-gray-300 rounded-button px-3 py-2 text-sm">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="dashboard.report.specialties"><%= __('dashboard.report.specialties') %></label>
              <div class="border border-gray-300 rounded-button p-3 max-h-32 overflow-y-auto space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm" data-i18n="dashboard.report.allSpecialties"><%= __('dashboard.report.allSpecialties') %></span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm" data-i18n="specialties.ophthalmology"><%= __('specialties.ophthalmology') %></span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm">Neurología</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300">
                  <span class="ml-2 text-sm">Cardiología</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="dashboard.report.reportContent"><%= __('dashboard.report.reportContent') %></label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm" data-i18n="dashboard.report.generalStats"><%= __('dashboard.report.generalStats') %></span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm" data-i18n="dashboard.report.occupancyCharts"><%= __('dashboard.report.occupancyCharts') %></span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="form-checkbox text-primary rounded border-gray-300" checked>
                  <span class="ml-2 text-sm" data-i18n="dashboard.report.boxDetails"><%= __('dashboard.report.boxDetails') %></span>
                </label>
              </div>
            </div>
          </div>
          <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelReportBtn" class="px-4 py-2 border border-gray-300 rounded-button text-gray-700 hover:bg-gray-50 whitespace-nowrap" data-i18n="dashboard.report.cancel"><%= __('dashboard.report.cancel') %></button>
            <button id="confirmReportBtn" class="bg-primary text-white px-6 py-2 rounded-button hover:bg-primary/90 whitespace-nowrap flex items-center">
              <i class="ri-download-line mr-2"></i>
              <span data-i18n="dashboard.report.download"><%= __('dashboard.report.download') %></span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- KPIs secundarios -->
    <% 
      const bestSpecialtyHasData = hasBestSpecialtyUsage;
      const bestSpecialtyNameText = bestSpecialtyHasData ? (bestSpecialtyUsageData.nombre ?? bestSpecialtyUsageData.label ?? 'Especialidad') : __('dashboard.noDataPeriod');
      const bestSpecialtyMetaText = bestSpecialtyHasData
        ? `${bestSpecialtyUsageData.conteo ?? 0} ${__('dashboard.schedulesCount')} • ${bestSpecialtyUsageData.porcentaje ?? 0}% ${__('dashboard.ofPeriod')}`
        : __('dashboard.noSchedules');
      const bestSpecialtyPeriodText = selectedSpecialtyPeriodDescription || __('dashboard.period');
      const bestBoxHasData = hasBestBoxUsage;
      const bestBoxNameText = bestBoxHasData ? `Box #${bestBoxUsageData.numero ?? '—'}` : __('dashboard.noDataPeriod');
      const bestBoxMetaText = bestBoxHasData
        ? `${bestBoxUsageData.porcentaje ?? 0}% ${__('dashboard.timeOccupied')}`
        : __('dashboard.noSchedules');
      const bestBoxPeriodText = selectedBoxPeriodDescription || __('dashboard.period');
    %>
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <article class="bg-white border rounded-lg p-5 shadow-sm flex flex-col gap-4">
        <div class="flex justify-between items-start gap-4">
          <div class="flex-1 min-w-0">
            <p class="text-xs md:text-sm text-gray-500 mb-1" data-i18n="dashboard.mostOccupiedSpecialty"><%= __('dashboard.mostOccupiedSpecialty') %></p>
            <p class="text-lg md:text-2xl font-semibold leading-tight <%= bestSpecialtyHasData ? 'text-gray-900' : 'text-gray-400' %>" id="best-specialty-name"><%= bestSpecialtyNameText %></p>
            <div class="mt-1 text-xs <%= bestSpecialtyHasData ? 'text-gray-500' : 'text-gray-400' %>" id="best-specialty-meta">
              <%= bestSpecialtyMetaText %>
            </div>
          </div>
          <div class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 flex-shrink-0">
            <i class="ri-eye-line ri-lg"></i>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <% specialtyUsageOptions.forEach((option) => { %>
            <button type="button"
              class="px-3 py-1.5 rounded-full text-sm font-medium border transition-colors <%= option.active ? 'bg-primary text-white border-primary shadow-sm' : 'bg-white border-gray-200 text-gray-600 hover:border-primary hover:text-primary' %>"
              data-specialty-period="<%= option.value %>"
              aria-pressed="<%= option.active %>">
              <%= option.label %>
            </button>
          <% }) %>
        </div>
        <div class="text-xs text-gray-400" id="best-specialty-period">
          <span data-i18n="dashboard.period"><%= __('dashboard.period') %></span>: <%= bestSpecialtyPeriodText %>
        </div>
      </article>
      
      <article class="bg-white border rounded-lg p-5 shadow-sm flex flex-col gap-4">
        <div class="flex justify-between items-start gap-4">
          <div class="flex-1 min-w-0">
            <p class="text-xs md:text-sm text-gray-500 mb-1" data-i18n="dashboard.mostUsedBox"><%= __('dashboard.mostUsedBox') %></p>
            <p class="text-lg md:text-2xl font-semibold leading-tight <%= bestBoxHasData ? 'text-gray-900' : 'text-gray-400' %>" id="best-box-name"><%= bestBoxNameText %></p>
            <div class="mt-1 text-xs <%= bestBoxHasData ? 'text-gray-500' : 'text-gray-400' %>" id="best-box-meta"><%= bestBoxMetaText %></div>
          </div>
          <div class="w-10 h-10 flex items-center justify-center rounded-full bg-amber-100 text-amber-500 flex-shrink-0">
            <i class="ri-star-line ri-lg"></i>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <% boxUsageOptions.forEach((option) => { %>
            <button type="button"
              class="px-3 py-1.5 rounded-full text-sm font-medium border transition-colors <%= option.active ? 'bg-primary text-white border-primary shadow-sm' : 'bg-white border-gray-200 text-gray-600 hover:border-primary hover:text-primary' %>"
              data-box-period="<%= option.value %>"
              aria-pressed="<%= option.active %>">
              <%= option.label %>
            </button>
          <% }) %>
        </div>
        <div class="text-xs text-gray-400" id="best-box-period">
          <span data-i18n="dashboard.period"><%= __('dashboard.period') %></span>: <%= bestBoxPeriodText %>
        </div>
      </article>
    </section>
    
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <article class="bg-white rounded shadow-sm p-6">
        <h2 class="text-xl font-semibold mb-4" data-i18n="dashboard.boxesBySpecialty"><%= __('dashboard.boxesBySpecialty') %></h2>
        <div id="horizontal-bar-chart" style="height: 240px;"></div>
        <script id="etiquetas-especialidad" type="application/json"><%- JSON.stringify(etiquetasEspecialidadList) %></script>
        <script id="valores-especialidad" type="application/json"><%- JSON.stringify(valoresEspecialidadList) %></script>
      </article>
      
      <article class="bg-white rounded shadow-sm p-6">
        <form id="form-horas" method="get" action="/dashboard" class="space-y-6">
          <div>
            <label for="prof_code" class="block text-sm font-medium mb-1" data-i18n="dashboard.professional"><%= __('dashboard.professional') %></label>
            <select id="prof_code" name="prof_code" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white">
              <option value="" data-i18n="dashboard.allDoctors"><%= __('dashboard.allDoctors') %></option>
              <% doctoresList.forEach((doc) => { const value = doc.idusuario ?? doc.idUsuario ?? ''; %>
                <option value="<%= value %>" <%= value && value.toString() === profSeleccionado ? 'selected' : '' %>>
                  <%= doc.nombreprofesional || doc.nombre || 'Profesional' %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="box_number" class="block text-sm font-medium mb-1" data-i18n="dashboard.box"><%= __('dashboard.box') %></label>
            <select id="box_number" name="box_number" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white">
              <option value="" data-i18n="dashboard.selectBox"><%= __('dashboard.selectBox') %></option>
              <% boxesList.forEach((b) => { const numero = b.numero ?? b.idBox ?? ''; %>
                <option value="<%= numero %>" <%= numero && numero.toString() === boxSeleccionado ? 'selected' : '' %>>
                  Box <%= numero %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="fecha" class="block text-sm font-medium mb-1" data-i18n="dashboard.date"><%= __('dashboard.date') %></label>
            <input id="fecha" name="fecha" type="date" value="<%= fechaSeleccionada %>" class="w-full border rounded px-3 py-2 focus:border-primary focus:ring-primary bg-white" />
          </div>
          <div class="pt-2 flex justify-end">
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90 transition" data-i18n="dashboard.search"><%= __('dashboard.search') %></button>
          </div>
        </form>
        <div class="mt-8">
          <canvas id="bar-chart" height="120"></canvas>
          <div class="mt-4 space-y-1 text-sm text-gray-700">
            <p><strong data-i18n="dashboard.scheduledHours"><%= __('dashboard.scheduledHours') %></strong> <span id="txt-horas-agendadas"><%= horasAgendadasText %></span></p>
            <p><strong data-i18n="dashboard.completedHours"><%= __('dashboard.completedHours') %></strong> <span id="txt-horas-realizadas"><%= horasRealizadasText %></span></p>
          </div>
        </div>
      </article>
    </section>
    
    <section class="bg-white rounded shadow-sm p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl font-semibold" data-i18n="dashboard.monthlyTrendBySpecialty"><%= __('dashboard.monthlyTrendBySpecialty') %></h2>
          <p class="text-sm text-gray-500" data-i18n="dashboard.closedSchedulesPerMonth"><%= __('dashboard.closedSchedulesPerMonth') %></p>
        </div>
        <div class="flex items-center gap-3">
          <label for="specialty-trend-select" class="text-sm font-medium text-gray-600" data-i18n="dashboard.specialty"><%= __('dashboard.specialty') %></label>
          <select id="specialty-trend-select" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
            <% specialtyTrendOptions.forEach((label) => { %>
              <option value="<%= label %>" <%= label === specialtyTrendDefault ? 'selected' : '' %>><%= label %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="w-full overflow-x-auto">
        <div id="specialty-trend-chart" class="min-w-[320px] h-[18rem] md:h-[20rem]"></div>
      </div>
      <script id="specialty-trend-labels" type="application/json"><%- JSON.stringify(specialtyTrendLabels) %></script>
      <script id="specialty-trend-series" type="application/json"><%- JSON.stringify(specialtyTrendSeries) %></script>
      <script id="specialty-trend-default" type="application/json"><%- JSON.stringify(specialtyTrendDefault) %></script>
    </section>
    
    <section class="bg-white rounded shadow-sm p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl font-semibold" data-i18n="dashboard.completedSchedulesByWeekday"><%= __('dashboard.completedSchedulesByWeekday') %></h2>
          <p class="text-sm text-gray-500" data-i18n="dashboard.last7Days"><%= __('dashboard.last7Days') %></p>
        </div>
        <form id="form-dias" method="get" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center">
          <div class="flex flex-col">
            <label for="especialidad" class="text-sm font-medium text-gray-600 mb-1" data-i18n="dashboard.specialty"><%= __('dashboard.specialty') %></label>
            <select name="especialidad" id="especialidad" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
              <% const weeklyOptionsList = Array.isArray(weeklySpecialtyOptions) && weeklySpecialtyOptions.length ? weeklySpecialtyOptions : Object.keys(weeklySpecialtySeries || {}); %>
              <% weeklyOptionsList.forEach((esp) => { %>
                <option value="<%= esp %>" <%= esp === (especSeleccionada || weeklySpecialtyDefault || 'Todas') ? 'selected' : '' %>><%= esp %></option>
              <% }) %>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="weekly-year" class="text-sm font-medium text-gray-600 mb-1" data-i18n="dashboard.year"><%= __('dashboard.year') %></label>
            <select name="weekly_year" id="weekly-year" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
              <option value="" <%= !weeklySelectedYear ? 'selected' : '' %> data-i18n="dashboard.all"><%= __('dashboard.all') %></option>
              <% (weeklyAvailableYears || []).forEach((year) => { %>
                <option value="<%= year %>" <%= weeklySelectedYear === year ? 'selected' : '' %>><%= year %></option>
              <% }) %>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="weekly-month" class="text-sm font-medium text-gray-600 mb-1" data-i18n="dashboard.month"><%= __('dashboard.month') %></label>
            <select name="weekly_month" id="weekly-month" class="border border-gray-300 rounded px-3 py-2 text-sm focus:border-primary focus:ring-primary bg-white">
              <option value="" <%= !weeklySelectedMonth ? 'selected' : '' %> data-i18n="dashboard.all"><%= __('dashboard.all') %></option>
              <% const monthNames = [null, __('dashboard.months.january'), __('dashboard.months.february'), __('dashboard.months.march'), __('dashboard.months.april'), __('dashboard.months.may'), __('dashboard.months.june'), __('dashboard.months.july'), __('dashboard.months.august'), __('dashboard.months.september'), __('dashboard.months.october'), __('dashboard.months.november'), __('dashboard.months.december')]; %>
              <% (weeklyAvailableMonths || []).forEach((monthNumber) => { %>
                <option value="<%= monthNumber %>" <%= weeklySelectedMonth === monthNumber ? 'selected' : '' %>><%= monthNames[monthNumber] %></option>
              <% }) %>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="weekly-period" class="text-sm font-medium text-gray-600 mb-1" data-i18n="dashboard.period"><%= __('dashboard.period') %></label>
            <div class="border border-gray-200 rounded px-3 py-2 text-sm text-gray-500 bg-gray-50" data-i18n="dashboard.weeklyDistribution"><%= __('dashboard.weeklyDistribution') %></div>
          </div>
          <div class="flex flex-col md:items-end justify-end">
            <input type="hidden" name="fecha" value="<%= fechaSeleccionada %>">
            <input type="hidden" name="prof_code" value="<%= profSeleccionado %>">
            <input type="hidden" name="box_number" value="<%= boxSeleccionado %>">
            <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-sm font-medium w-full md:w-auto" data-i18n="dashboard.filter"><%= __('dashboard.filter') %></button>
          </div>
        </form>
      </div>
      <div class="w-full overflow-x-auto">
        <div id="weekly-trend-chart" class="min-w-[320px] h-[18rem] md:h-[20rem]"></div>
      </div>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
        <div class="p-4 rounded-xl border border-gray-200 bg-gray-50">
          <p class="text-xs uppercase tracking-wide text-gray-500" data-i18n="dashboard.mostActiveDay"><%= __('dashboard.mostActiveDay') %></p>
          <p id="weekly-top-day" class="text-lg font-semibold text-gray-800 mt-1">—</p>
          <p id="weekly-top-day-detail" class="text-xs text-gray-500 mt-1" data-i18n="dashboard.noDataSelectedPeriod"><%= __('dashboard.noDataSelectedPeriod') %></p>
        </div>
        <div class="p-4 rounded-xl border border-gray-200 bg-gray-50">
          <p class="text-xs uppercase tracking-wide text-gray-500" data-i18n="dashboard.concentration"><%= __('dashboard.concentration') %></p>
          <p id="weekly-top-percentage" class="text-lg font-semibold text-gray-800 mt-1">0%</p>
          <p class="text-xs text-gray-500 mt-1" data-i18n="dashboard.schedulesOnMostActiveDay"><%= __('dashboard.schedulesOnMostActiveDay') %></p>
        </div>
        <div class="p-4 rounded-xl border border-gray-200 bg-gray-50">
          <p class="text-xs uppercase tracking-wide text-gray-500" data-i18n="dashboard.totalPeriod"><%= __('dashboard.totalPeriod') %></p>
          <p id="weekly-total-count" class="text-lg font-semibold text-gray-800 mt-1">0</p>
          <p class="text-xs text-gray-500 mt-1" data-i18n="dashboard.completedSchedulesFiltered"><%= __('dashboard.completedSchedulesFiltered') %></p>
        </div>
      </div>
      <script id="weekly-labels" type="application/json"><%- JSON.stringify(weeklySpecialtyLabels) %></script>
      <script id="weekly-series" type="application/json"><%- JSON.stringify(weeklySpecialtySeries) %></script>
      <script id="weekly-default" type="application/json"><%- JSON.stringify(weeklySpecialtyDefault || especSeleccionada || null) %></script>
      <script id="weekly-options" type="application/json"><%- JSON.stringify(weeklySpecialtyOptions) %></script>
      <script id="weekly-summary" type="application/json"><%- JSON.stringify(weeklySummary) %></script>
      <script id="weekly-years" type="application/json"><%- JSON.stringify(weeklyAvailableYears) %></script>
      <script id="weekly-months" type="application/json"><%- JSON.stringify(weeklyAvailableMonths) %></script>
      <script id="weekly-months-map" type="application/json"><%- JSON.stringify(weeklyMonthsByYear) %></script>
      <script id="weekly-all-months" type="application/json"><%- JSON.stringify(weeklyAllMonths) %></script>
      <script id="weekly-selected-year" type="application/json"><%- JSON.stringify(weeklySelectedYear) %></script>
      <script id="weekly-selected-month" type="application/json"><%- JSON.stringify(weeklySelectedMonth) %></script>
    </section>
    
    <div class="pt-4 flex justify-center">
      <a href="/reporte" class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90 transition inline-flex items-center">
        <i class="ri-file-excel-2-line mr-2"></i>
        <span data-i18n="dashboard.downloadExcelReport"><%= __('dashboard.downloadExcelReport') %></span>
      </a>
    </div>
  </main>

  <%- include('footer') %>

  <script id="total-boxes-count" type="application/json"><%- JSON.stringify(totalBoxesData) %></script>
  <script id="estado-percentages" type="application/json"><%- JSON.stringify(estadoPercentagesData) %></script>
  <script id="estado-counts" type="application/json"><%- JSON.stringify(estadoCountsData) %></script>

  <script>
    const estado = JSON.parse(document.getElementById('estado-percentages').textContent || '{}');
    const estadoCounts = JSON.parse(document.getElementById('estado-counts').textContent || '{}');
    const totalBoxes = Number(JSON.parse(document.getElementById('total-boxes-count').textContent || '0')) || 0;
    <% for (const item of labelColorsView) { %>
      (function() {
        const keyName = <%- JSON.stringify(item.key) %>;
        const colorHex = <%- JSON.stringify(item.color) %>;
        const chartEl = document.getElementById('donut-<%= item.chartId %>');
        if (!chartEl) return;
        const chart = echarts.init(chartEl);
        chart.setOption({
            tooltip: {
              trigger: 'item',
              formatter: function(params) {
                const coloredCount = estadoCounts[keyName] || 0;
                const grayCount = Math.max(totalBoxes - coloredCount, 0);
                const isColored = params.dataIndex === 0;
                
                let translatedLabel;
                if (isColored) {
                  
                  if (keyName === 'Ocupado') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.occupied') : 'Ocupado';
                  } else if (keyName === 'Disponible') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.available') : 'Disponible';
                  } else if (keyName === 'Inhabilitado') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.disabled') : 'Inhabilitado';
                  } else {
                    translatedLabel = keyName;
                  }
                } else {
                  
                  if (keyName === 'Ocupado') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.notOccupied') : 'No ocupado';
                  } else if (keyName === 'Disponible') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.notAvailable') : 'No disponible';
                  } else if (keyName === 'Inhabilitado') {
                    translatedLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.notDisabled') : 'No inhabilitado';
                  } else {
                    translatedLabel = `No ${keyName.toLowerCase()}`;
                  }
                }
                
                const value = isColored ? coloredCount : grayCount;
                const boxesText = window.dashboardI18n ? window.dashboardI18n.translate('chart.boxes') : 'boxes';
                return translatedLabel + ': ' + value + ' ' + boxesText;
              }
            },
          series: [{
            type: 'pie',
            radius: ['65%', '85%'],
            avoidLabelOverlap: false,
            label: {
              show: true,
              position: 'center',
              formatter: (estado[keyName] || 0) + '%',
              fontSize: 22,
              fontWeight: '800',
              color: '#111827'
            },
            data: [
              { value: estado[keyName] || 0, itemStyle: { color: colorHex } },
              { value: 100 - (estado[keyName] || 0), itemStyle: { color: '#f3f4f6' } }
            ]
          }]
        });
        window.addEventListener('resize', () => chart.resize());
      })();
    <% } %>

    const ag = parseFloat('<%= horasAgendadasFloatValue %>') || 0;
    const re = parseFloat('<%= horasRealizadasFloatValue %>') || 0;
    const barCtx = document.getElementById('bar-chart').getContext('2d');
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: [
          window.dashboardI18n ? window.dashboardI18n.translate('chart.scheduled') : 'Agendadas',
          window.dashboardI18n ? window.dashboardI18n.translate('chart.completed') : 'Realizadas'
        ],
        datasets: [{
          data: [ag, re],
          backgroundColor: ['#38b2ac', '#4299e1'],
          borderRadius: 4
        }]
      },
      options: {
        animation: false,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: Math.max(ag, re) * 1.1 || 1,
            ticks: {
              callback: (value) => value + 'h'
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const horasText = window.dashboardI18n ? window.dashboardI18n.translate('chart.hours') : 'horas';
                return (Number(context.parsed.y).toFixed(2)) + ' ' + horasText;
              }
            }          
          }
        }
      }
    });
    window.barChart = barChart;

    const etiquetasEsp = JSON.parse(document.getElementById('etiquetas-especialidad').textContent || '[]');
    const valoresEsp = JSON.parse(document.getElementById('valores-especialidad').textContent || '[]');
    const horizontalBar = echarts.init(document.getElementById('horizontal-bar-chart'));
    horizontalBar.setOption({
      animation: false,
      grid: { left: '25%', right: '4%', bottom: '6%', top: '6%' },
      xAxis: {
        type: 'value',
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { show: false },
        splitLine: { show: false }
      },
      yAxis: {
        type: 'category',
        data: etiquetasEsp,
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { color: '#6b7280' }
      },
      series: [{
        name: 'Boxes',
        type: 'bar',
        data: valoresEsp,
        barWidth: '60%',
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
            { offset: 0, color: '#20B2AA' },
            { offset: 1, color: '#5fd0cb' }
          ]),
          borderRadius: [0, 4, 4, 0]
        }
      }],
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        backgroundColor: 'rgba(255,255,255,0.9)',
        borderColor: '#e5e7eb',
        textStyle: { color: '#1f2937' },
        formatter: function(params) {
          if (!params || !params[0]) return '';
          const boxesText = window.dashboardI18n ? window.dashboardI18n.translate('chart.boxes') : 'Boxes';
          return params[0].name + '<br/>' + boxesText + ': ' + params[0].value;
        }
      }
    });
    window.addEventListener('resize', () => horizontalBar.resize());

    const ACTIVE_PERIOD_CLASSES = ['bg-primary', 'text-white', 'border-primary', 'shadow-sm'];
    const INACTIVE_PERIOD_CLASSES = ['bg-white', 'border-gray-200', 'text-gray-600'];
    const bestSpecialtyNameEl = document.getElementById('best-specialty-name');
    const bestSpecialtyMetaEl = document.getElementById('best-specialty-meta');
    const bestSpecialtyPeriodEl = document.getElementById('best-specialty-period');
    const bestBoxNameEl = document.getElementById('best-box-name');
    const bestBoxMetaEl = document.getElementById('best-box-meta');
    const bestBoxPeriodEl = document.getElementById('best-box-period');
    const boxPeriodValueEl = document.getElementById('box-period-value');
    const specialtyPeriodValueEl = document.getElementById('specialty-period-value');
    let boxPeriodButtonsList = [];
    let specialtyPeriodButtonsList = [];
    let fetchAndUpdateRef = null;

    const applyPeriodButtonState = (button, isActive) => {
      if (!button) return;
      ACTIVE_PERIOD_CLASSES.forEach((cls) => button.classList.toggle(cls, isActive));
      INACTIVE_PERIOD_CLASSES.forEach((cls) => button.classList.toggle(cls, !isActive));
      button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    };

    const setPeriodButtonsState = (buttons, activeValue, datasetKey) => {
      if (!Array.isArray(buttons) || !buttons.length) return;
      const normalized = activeValue != null ? String(activeValue) : null;
      buttons.forEach((button) => {
        const value = button?.dataset?.[datasetKey] != null ? String(button.dataset[datasetKey]) : null;
        applyPeriodButtonState(button, normalized != null ? value === normalized : false);
      });
    };

    const updateBestSpecialtyCard = (info = null, periodDescription = '') => {
      const hasData = info && typeof info === 'object';
      const nameText = hasData 
        ? (info.nombre ?? info.label ?? 'Especialidad') 
        : (window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noDataPeriod') : 'Sin datos en este período');
      
      const count = Number(info?.conteo ?? info?.total ?? 0);
      const percentage = Number(info?.porcentaje ?? 0);
      
      const schedulesText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.schedulesCount') : 'agendas';
      const ofPeriodText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.ofPeriod') : 'del período';
      const noSchedulesText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noSchedules') : 'No hay agendamientos registrados.';
      
      const metaText = hasData
        ? `${count} ${schedulesText} • ${percentage}% ${ofPeriodText}`
        : noSchedulesText;

      if (bestSpecialtyNameEl) {
        bestSpecialtyNameEl.textContent = nameText;
        bestSpecialtyNameEl.classList.toggle('text-gray-400', !hasData);
        bestSpecialtyNameEl.classList.toggle('text-gray-900', hasData);
      }
      if (bestSpecialtyMetaEl) {
        bestSpecialtyMetaEl.textContent = metaText;
        bestSpecialtyMetaEl.classList.toggle('text-gray-400', !hasData);
        bestSpecialtyMetaEl.classList.toggle('text-gray-500', hasData);
      }
      if (bestSpecialtyPeriodEl) {
        const periodLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.period') : 'Período';
        const description = periodDescription || 'Sin período seleccionado';
        bestSpecialtyPeriodEl.textContent = `${periodLabel}: ${description}`;
      }
    };

    const updateBestBoxCard = (info = null, periodDescription = '') => {
      const hasData = info && typeof info === 'object';
      const numero = info?.numero ?? info?.boxId ?? null;
      const percentage = Number(info?.porcentaje ?? 0);
      
      const noDataText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noDataPeriod') : 'Sin datos en este período';
      const timeOccupiedText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.timeOccupied') : 'del tiempo ocupado';
      const noSchedulesText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noSchedules') : 'No hay agendamientos registrados.';
      
      const nameText = hasData && numero != null ? `Box #${numero}` : noDataText;
      const metaText = hasData ? `${percentage}% ${timeOccupiedText}` : noSchedulesText;

      if (bestBoxNameEl) {
        bestBoxNameEl.textContent = nameText;
        bestBoxNameEl.classList.toggle('text-gray-400', !hasData);
        bestBoxNameEl.classList.toggle('text-gray-900', hasData);
      }
      if (bestBoxMetaEl) {
        bestBoxMetaEl.textContent = metaText;
        bestBoxMetaEl.classList.toggle('text-gray-400', !hasData);
        bestBoxMetaEl.classList.toggle('text-gray-500', hasData);
      }
      if (bestBoxPeriodEl) {
        const periodLabel = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.period') : 'Período';
        const description = periodDescription || 'Sin período seleccionado';
        bestBoxPeriodEl.textContent = `${periodLabel}: ${description}`;
      }
    };

    /* Weekly data managed via ECharts */
    let applyWeeklyData;
    let weeklyTrendLabels = [];
    let weeklyTrendSeries = {};
    let weeklySummary = {};
    let weeklyMonthsByYear = {};
    let weeklyAllMonths = [];
    let weeklyTrendSelectEl = null;
    let weeklyYearSelectEl = null;
    let weeklyMonthSelectEl = null;
    let weeklyChartInstance = null;
    const WEEK_MONTH_NAMES = [
      null,
      'Enero',
      'Febrero',
      'Marzo',
      'Abril',
      'Mayo',
      'Junio',
      'Julio',
      'Agosto',
      'Septiembre',
      'Octubre',
      'Noviembre',
      'Diciembre',
    ];

const populateYearOptions = (selectEl, years, selectedYear) => {
  if (!selectEl) return;
  selectEl.innerHTML = '';
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.all') : 'Todos';
  if (!selectedYear) defaultOption.selected = true;
  selectEl.appendChild(defaultOption);
  (Array.isArray(years) ? years : []).forEach((year) => {
    const option = document.createElement('option');
    option.value = String(year);
    option.textContent = String(year);
    if (selectedYear && Number(selectedYear) === Number(year)) {
      option.selected = true;
    }
    selectEl.appendChild(option);
  });
};

    const resolveWeeklySpecialtyLabel = (label) => {
      if (label && weeklyTrendSeries[label]) return label;
      if (weeklyTrendSeries['Todas']) return 'Todas';
      const keys = Object.keys(weeklyTrendSeries);
      return keys.length ? keys[0] : null;
    };

    const populateMonthOptions = (selectEl, months, selectedMonth) => {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.all') : 'Todos';
      if (!selectedMonth) defaultOption.selected = true;
      selectEl.appendChild(defaultOption);
      
      const monthTranslations = [
        null,
        'months.january',
        'months.february',
        'months.march',
        'months.april',
        'months.may',
        'months.june',
        'months.july',
        'months.august',
        'months.september',
        'months.october',
        'months.november',
        'months.december'
      ];
      
      (Array.isArray(months) ? months : []).forEach((monthNumber) => {
        const option = document.createElement('option');
        option.value = String(monthNumber);
        // Traducir nombres de meses
        const translationKey = monthTranslations[monthNumber];
        option.textContent = window.dashboardI18n && translationKey 
          ? window.dashboardI18n.translate(translationKey)
          : (WEEK_MONTH_NAMES[monthNumber] || `Mes ${monthNumber}`);
        if (selectedMonth && Number(selectedMonth) === Number(monthNumber)) {
          option.selected = true;
        }
        selectEl.appendChild(option);
      });
    };

    (function() {
      const formHoras = document.getElementById('form-horas');
      const formDias = document.getElementById('form-dias');
      const txtAg = document.getElementById('txt-horas-agendadas');
      const txtRe = document.getElementById('txt-horas-realizadas');
      const weeklyTopDayEl = document.getElementById('weekly-top-day');
      const weeklyTopDayDetailEl = document.getElementById('weekly-top-day-detail');
      const weeklyTopPercentageEl = document.getElementById('weekly-top-percentage');
      const weeklyTotalCountEl = document.getElementById('weekly-total-count');

      const ensureWeeklyChart = () => {
        if (!weeklyChartInstance) {
          const container = document.getElementById('weekly-trend-chart');
          if (container) {
            weeklyChartInstance = echarts.init(container);
            window.weeklyChartInstance = weeklyChartInstance;
          }
        }
        return weeklyChartInstance;
      };

      const renderWeeklyChart = (label) => {
        const chart = ensureWeeklyChart();
        if (!chart) return null;
        const selected = resolveWeeklySpecialtyLabel(label);
        const data = Array.isArray(weeklyTrendSeries[selected])
          ? weeklyTrendSeries[selected]
          : [];
        const maxValue = data.reduce((acc, value) => Math.max(acc, value), 0);
        chart.setOption({
          color: ['#B4447C'],
          grid: { left: '3%', right: '4%', bottom: '5%', containLabel: true },
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            borderWidth: 0,
            padding: 12,
            textStyle: { color: '#f8fafc' },
            formatter: (params = []) => {
              const item = params[0];
              if (!item) return '';
              const value = Number(item.value || 0);
              const schedulesText = window.dashboardI18n ? window.dashboardI18n.translate('chart.schedules') : 'agendas';
              return `${item.axisValueLabel}<br/>${value} ${schedulesText}`;
            },          
          },
          xAxis: {
            type: 'category',
            data: window.dashboardI18n ? window.dashboardI18n.getWeekdayLabels() : weeklyTrendLabels,
            axisTick: { alignWithLabel: true },
            axisLabel: { color: '#64748b' },
            axisLine: { lineStyle: { color: '#e2e8f0' } },
          },
          yAxis: {
            type: 'value',
            min: 0,
            max: maxValue === 0 ? 1 : undefined,
            axisLine: { show: false },
            axisTick: { show: false },
            axisLabel: { color: '#64748b', precision: 0 },
            splitLine: { lineStyle: { color: '#e2e8f0' } },
          },
          series: [
            {
              type: 'bar',
              data,
              barWidth: '55%',
              itemStyle: {
                borderRadius: [8, 8, 4, 4],
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                  { offset: 0, color: 'rgba(180, 68, 124, 0.85)' },
                  { offset: 1, color: 'rgba(180, 68, 124, 0.25)' },
                ]),
              },
              emphasis: {
                itemStyle: {
                  color: '#B4447C',
                },
              },
            },
          ],
        });
        window.addEventListener('resize', () => chart.resize());
        return selected;
      };

      const updateWeeklySummary = (label) => {
        const info = weeklySummary[label] || {};
        const noDataText = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noDataSelectedPeriod') : 'Sin datos';
        
        if (weeklyTopDayEl) {
          weeklyTopDayEl.textContent = info.topDayLabel || noDataText;
        }
        if (weeklyTopDayDetailEl) {
          if (info.topDayLabel) {
            const count = info.topDayCount || 0;
            const schedulesText = count === 1 
              ? (window.dashboardI18n ? window.dashboardI18n.translate('chart.schedules').slice(0, -1) : 'agenda')
              : (window.dashboardI18n ? window.dashboardI18n.translate('chart.schedules') : 'agendas');
            weeklyTopDayDetailEl.textContent = `${count} ${schedulesText} registradas en ${info.topDayLabel}.`;
          } else {
            weeklyTopDayDetailEl.textContent = window.dashboardI18n ? window.dashboardI18n.translate('dashboard.noDataSelectedPeriod') : 'Sin datos para el período seleccionado.';
          }
        }
        if (weeklyTopPercentageEl) {
          weeklyTopPercentageEl.textContent = `${info.topDayPercentage || 0}%`;
        }
        if (weeklyTotalCountEl) {
          weeklyTotalCountEl.textContent = info.total || 0;
        }
      };

      applyWeeklyData = function(label) {
        const selected = renderWeeklyChart(label);
        updateWeeklySummary(selected || label);
        if (weeklyTrendSelectEl && selected) {
          weeklyTrendSelectEl.value = selected;
        }
      };

      window.applyWeeklyData = applyWeeklyData;

      function buildParams() {
        const prof = document.getElementById('prof_code')?.value || '';
        const box = document.getElementById('box_number')?.value || '';
        const fecha = document.getElementById('fecha')?.value || '';
        const espec = document.getElementById('especialidad')?.value || 'Todas';
        const boxPeriod = document.getElementById('box-period-value')?.value || '';
        const specialtyPeriod = document.getElementById('specialty-period-value')?.value || '';
        const weeklyYear = document.getElementById('weekly-year')?.value || '';
        const weeklyMonth = document.getElementById('weekly-month')?.value || '';
        const params = new URLSearchParams();
        if (prof) params.set('prof_code', prof);
        if (box) params.set('box_number', box);
        if (fecha) params.set('fecha', fecha);
        if (espec) params.set('especialidad', espec);
        if (boxPeriod) params.set('box_period', boxPeriod);
        if (specialtyPeriod) params.set('specialty_period', specialtyPeriod);
        if (weeklyYear) params.set('weekly_year', weeklyYear);
        if (weeklyMonth) params.set('weekly_month', weeklyMonth);
        return params.toString();
      }

      function updateFromData(data) {
        weeklyTrendSelectEl = weeklyTrendSelectEl || document.getElementById('especialidad');
        weeklyYearSelectEl = weeklyYearSelectEl || document.getElementById('weekly-year');
        weeklyMonthSelectEl = weeklyMonthSelectEl || document.getElementById('weekly-month');
        if (txtAg) txtAg.textContent = data.horas_agendadas ?? '0';
        if (txtRe) txtRe.textContent = data.horas_realizadas ?? '0';
        const a = parseFloat(data.horas_agendadas_float || 0);
        const r = parseFloat(data.horas_realizadas_float || 0);
        barChart.data.datasets[0].data = [a, r];
        barChart.options.scales.y.suggestedMax = Math.max(a, r) * 1.1 || 1;
        barChart.update('none');

        if (data.weekly_labels && data.weekly_series) {
          weeklyTrendLabels = data.weekly_labels || [];
          weeklyTrendSeries = data.weekly_series || {};
          weeklySummary = data.weekly_summary || weeklySummary;
          weeklyMonthsByYear = data.weekly_months_map || weeklyMonthsByYear;
          weeklyAllMonths = data.weekly_all_months || weeklyAllMonths;

          const availableOptions = Array.isArray(data.weekly_options)
            ? data.weekly_options
            : Object.keys(weeklyTrendSeries);
          if (weeklyTrendSelectEl) {
            weeklyTrendSelectEl.innerHTML = '';
            availableOptions.forEach((label) => {
              const option = document.createElement('option');
              option.value = label;
              option.textContent = label;
              weeklyTrendSelectEl.appendChild(option);
            });
            weeklyTrendSelectEl.onchange = (event) => {
              applyWeeklyData(event.target.value);
            };
          }

          populateYearOptions(
            weeklyYearSelectEl,
            data.weekly_years || [],
            data.weekly_selected_year ?? ''
          );

          const monthsForYear =
            (data.weekly_selected_year && data.weekly_months_map?.[data.weekly_selected_year]) ||
            data.weekly_months ||
            weeklyAllMonths;

          populateMonthOptions(
            weeklyMonthSelectEl,
            monthsForYear,
            data.weekly_selected_month ?? ''
          );

          if (window.dashboardI18n && window.dashboardI18n.translateSelects) {
            window.dashboardI18n.translateSelects();
          }

          const defaultLabel =
            data.weekly_default ||
            weeklyTrendSelectEl?.value ||
            resolveWeeklySpecialtyLabel('Todas');

          applyWeeklyData(defaultLabel);
        }

        if (Object.prototype.hasOwnProperty.call(data, 'best_specialty_usage') || Object.prototype.hasOwnProperty.call(data, 'best_specialty_period_description')) {
          const specialtyValue = Object.prototype.hasOwnProperty.call(data, 'best_specialty_period_value')
            ? (data.best_specialty_period_value ?? '')
            : specialtyPeriodValueEl?.value ?? '';
          if (specialtyPeriodValueEl) {
            specialtyPeriodValueEl.value = specialtyValue;
          }
          if (!specialtyPeriodButtonsList.length) {
            specialtyPeriodButtonsList = Array.from(document.querySelectorAll('[data-specialty-period]'));
          }
          setPeriodButtonsState(specialtyPeriodButtonsList, specialtyValue, 'specialtyPeriod');
          updateBestSpecialtyCard(
            data.best_specialty_usage,
            data.best_specialty_period_description
          );
        }

        if (Object.prototype.hasOwnProperty.call(data, 'best_box_usage') || Object.prototype.hasOwnProperty.call(data, 'best_box_period_description')) {
          const boxValue = Object.prototype.hasOwnProperty.call(data, 'best_box_period_value')
            ? (data.best_box_period_value ?? '')
            : boxPeriodValueEl?.value ?? '';
          if (boxPeriodValueEl) {
            boxPeriodValueEl.value = boxValue;
          }
          if (!boxPeriodButtonsList.length) {
            boxPeriodButtonsList = Array.from(document.querySelectorAll('[data-box-period]'));
          }
          setPeriodButtonsState(boxPeriodButtonsList, boxValue, 'boxPeriod');
          updateBestBoxCard(
            data.best_box_usage,
            data.best_box_period_description
          );
        }

        if (Array.isArray(data.specialty_usage_options)) {
          if (!specialtyPeriodButtonsList.length) {
            specialtyPeriodButtonsList = Array.from(document.querySelectorAll('[data-specialty-period]'));
          }
          specialtyPeriodButtonsList.forEach((button) => {
            const value = button?.dataset?.specialtyPeriod;
            const option = data.specialty_usage_options.find((item) => String(item.value) === String(value));
            if (option && option.label) {
              button.textContent = option.label;
            }
          });
        }

        if (Array.isArray(data.box_usage_options)) {
          if (!boxPeriodButtonsList.length) {
            boxPeriodButtonsList = Array.from(document.querySelectorAll('[data-box-period]'));
          }
          boxPeriodButtonsList.forEach((button) => {
            const value = button?.dataset?.boxPeriod;
            const option = data.box_usage_options.find((item) => String(item.value) === String(value));
            if (option && option.label) {
              button.textContent = option.label;
            }
          });
        }
      }

      async function fetchAndUpdate(event) {
        if (event) event.preventDefault();
        const query = buildParams();
        const url = `${window.location.pathname}${query ? '?' + query : ''}`;
        window.history.replaceState(null, '', url);
        try {
          const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!response.ok) throw new Error('Error al obtener datos');
          const data = await response.json();
          requestAnimationFrame(() => updateFromData(data));
        } catch (error) {
          console.error(error);
        }
      }

      fetchAndUpdateRef = fetchAndUpdate;

      formHoras?.addEventListener('submit', fetchAndUpdate);
      formDias?.addEventListener('submit', fetchAndUpdate);

      weeklyYearSelectEl = document.getElementById('weekly-year');
      weeklyMonthSelectEl = document.getElementById('weekly-month');
      weeklyYearSelectEl?.addEventListener('change', (event) => {
        const selected = event.target.value;
        const months =
          selected && weeklyMonthsByYear[selected]
            ? weeklyMonthsByYear[selected]
            : weeklyAllMonths;
        populateMonthOptions(weeklyMonthSelectEl, months, '');
      });
    })();

    document.addEventListener('DOMContentLoaded', function () {
      boxPeriodButtonsList = Array.from(document.querySelectorAll('[data-box-period]'));
      specialtyPeriodButtonsList = Array.from(document.querySelectorAll('[data-specialty-period]'));

      if (boxPeriodButtonsList.length) {
        boxPeriodButtonsList.forEach((button) => {
          button.addEventListener('click', () => {
            const value = button.dataset.boxPeriod ?? '';
            if (boxPeriodValueEl) {
              boxPeriodValueEl.value = value;
            }
            setPeriodButtonsState(boxPeriodButtonsList, value, 'boxPeriod');
            fetchAndUpdateRef?.();
          });
        });
        setPeriodButtonsState(boxPeriodButtonsList, boxPeriodValueEl?.value ?? null, 'boxPeriod');
      }

      if (specialtyPeriodButtonsList.length) {
        specialtyPeriodButtonsList.forEach((button) => {
          button.addEventListener('click', () => {
            const value = button.dataset.specialtyPeriod ?? '';
            if (specialtyPeriodValueEl) {
              specialtyPeriodValueEl.value = value;
            }
            setPeriodButtonsState(specialtyPeriodButtonsList, value, 'specialtyPeriod');
            fetchAndUpdateRef?.();
          });
        });
        setPeriodButtonsState(specialtyPeriodButtonsList, specialtyPeriodValueEl?.value ?? null, 'specialtyPeriod');
      }

      weeklyTrendSelectEl = document.getElementById('especialidad');
      const weeklyLabelsEl = document.getElementById('weekly-labels');
      const weeklySeriesEl = document.getElementById('weekly-series');
      const weeklyDefaultEl = document.getElementById('weekly-default');
      const weeklyOptionsEl = document.getElementById('weekly-options');
      const weeklySummaryEl = document.getElementById('weekly-summary');
      const weeklyYearsEl = document.getElementById('weekly-years');
      const weeklyMonthsEl = document.getElementById('weekly-months');
      const weeklyMonthsMapEl = document.getElementById('weekly-months-map');
      const weeklyAllMonthsEl = document.getElementById('weekly-all-months');
      const weeklySelectedYearEl = document.getElementById('weekly-selected-year');
      const weeklySelectedMonthEl = document.getElementById('weekly-selected-month');

      weeklyTrendLabels = JSON.parse(weeklyLabelsEl?.textContent || '[]');
      weeklyTrendSeries = JSON.parse(weeklySeriesEl?.textContent || '{}');
      weeklySummary = JSON.parse(weeklySummaryEl?.textContent || '{}');
      weeklyMonthsByYear = JSON.parse(weeklyMonthsMapEl?.textContent || '{}');
      weeklyAllMonths = JSON.parse(weeklyAllMonthsEl?.textContent || '[]');

      const weeklyOptions = JSON.parse(weeklyOptionsEl?.textContent || '[]');
      if (weeklyTrendSelectEl && weeklyOptions.length) {
        weeklyTrendSelectEl.innerHTML = '';
        weeklyOptions.forEach((label) => {
          const option = document.createElement('option');
          option.value = label;
          option.textContent = label;
          weeklyTrendSelectEl.appendChild(option);
        });
        weeklyTrendSelectEl.onchange = (event) => {
          applyWeeklyData(event.target.value);
        };
      }

      weeklyYearSelectEl = document.getElementById('weekly-year');
      weeklyMonthSelectEl = document.getElementById('weekly-month');
      const initialYear = JSON.parse(weeklySelectedYearEl?.textContent || 'null');
      const initialMonth = JSON.parse(weeklySelectedMonthEl?.textContent || 'null');
      const initialYears = JSON.parse(weeklyYearsEl?.textContent || '[]');
      const initialMonths = JSON.parse(weeklyMonthsEl?.textContent || '[]');

      populateYearOptions(weeklyYearSelectEl, initialYears, initialYear);
      populateMonthOptions(
        weeklyMonthSelectEl,
        initialYear && weeklyMonthsByYear[initialYear] ? weeklyMonthsByYear[initialYear] : initialMonths,
        initialMonth
      );

      const initialWeekly = JSON.parse(weeklyDefaultEl?.textContent || 'null')
        || weeklyTrendSelectEl?.value
        || resolveWeeklySpecialtyLabel('Todas');

      if (initialWeekly) {
        applyWeeklyData(initialWeekly);
      }

      const specialtyTrendLabelsEl = document.getElementById('specialty-trend-labels');
      const specialtyTrendSeriesEl = document.getElementById('specialty-trend-series');
      const specialtyTrendDefaultEl = document.getElementById('specialty-trend-default');
      const specialtyTrendSelect = document.getElementById('specialty-trend-select');
      const specialtyTrendContainer = document.getElementById('specialty-trend-chart');
      if (specialtyTrendLabelsEl && specialtyTrendSeriesEl && specialtyTrendContainer) {
        const trendLabels = JSON.parse(specialtyTrendLabelsEl.textContent || '[]');
        const trendSeries = JSON.parse(specialtyTrendSeriesEl.textContent || '{}');
        const seriesKeys = Object.keys(trendSeries);
        const resolveLabel = (label) => {
          if (label && trendSeries[label]) return label;
          if (trendSeries['Todas']) return 'Todas';
          return seriesKeys[0] || null;
        };
        const toNumericSeries = (values = []) =>
          trendLabels.map((_, index) => {
            const value = Array.isArray(values) ? values[index] : 0;
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
          });

        let currentSpecialty = resolveLabel(
          JSON.parse(specialtyTrendDefaultEl?.textContent || 'null')
            || specialtyTrendSelect?.value
            || seriesKeys[0]
            || null
        );

        if (specialtyTrendSelect && currentSpecialty) {
          specialtyTrendSelect.value = currentSpecialty;
        }

        const specialtyTrendChart = echarts.init(specialtyTrendContainer);
        const renderSpecialtyTrend = (label) => {
          const selected = resolveLabel(label);
          const data = toNumericSeries(trendSeries[selected]);
          const maxValue = data.reduce((acc, value) => Math.max(acc, value), 0);
          specialtyTrendChart.setOption({
            color: ['#B4447C'],
            grid: { left: '3%', right: '4%', bottom: '5%', containLabel: true },
            tooltip: {
              trigger: 'axis',
              backgroundColor: 'rgba(15, 23, 42, 0.92)',
              borderWidth: 0,
              padding: 12,
              textStyle: { color: '#f8fafc' },
              formatter: (params = []) => {
                const item = params[0];
                if (!item) return '';
                const value = Number(item.value || 0);
                const schedulesText = window.dashboardI18n ? window.dashboardI18n.translate('chart.schedules') : 'agendas';
                return `${item.axisValue}<br/>${value} ${schedulesText}`;
              },
            },
            xAxis: {
              type: 'category',
              data: trendLabels,
              boundaryGap: false,
              axisLine: { lineStyle: { color: '#e2e8f0' } },
              axisLabel: { color: '#64748b' },
              axisTick: { alignWithLabel: true },
            },
            yAxis: {
              type: 'value',
              min: 0,
              max: maxValue === 0 ? 1 : undefined,
              axisLine: { show: false },
              axisTick: { show: false },
              axisLabel: { color: '#64748b', precision: 0 },
              splitLine: { lineStyle: { color: '#e2e8f0' } },
            },
            series: [
              {
                name: selected || 'Especialidad',
                type: 'line',
                smooth: true,
                showSymbol: true,
                symbolSize: 7,
                lineStyle: { width: 3, color: '#B4447C' },
                areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(180, 68, 124, 0.35)' },
                    { offset: 1, color: 'rgba(180, 68, 124, 0.05)' },
                  ]),
                },
                data,
              },
            ],
          });
          currentSpecialty = selected;
          if (specialtyTrendSelect && selected) {
            specialtyTrendSelect.value = selected;
          }
        };

        renderSpecialtyTrend(currentSpecialty);
        specialtyTrendSelect?.addEventListener('change', (event) => {
          renderSpecialtyTrend(event.target.value);
        });
        window.addEventListener('resize', () => specialtyTrendChart.resize());
      }

      const reportModal = document.getElementById('reportModal');
      const closeReportModal = document.getElementById('closeReportModal');
      const cancelReportBtn = document.getElementById('cancelReportBtn');
      const confirmReportBtn = document.getElementById('confirmReportBtn');
      const formatBtns = document.querySelectorAll('.format-btn');
      let selectedFormat = null;

      function showModal() {
        reportModal?.classList.remove('hidden');
        reportModal?.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }

      function hideModal() {
        reportModal?.classList.add('hidden');
        reportModal?.classList.remove('flex');
        document.body.style.overflow = '';
      }

      document.getElementById('generateReportBtn')?.addEventListener('click', showModal);
      closeReportModal?.addEventListener('click', hideModal);
      cancelReportBtn?.addEventListener('click', hideModal);

      formatBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          formatBtns.forEach((b) => {
            b.classList.remove('border-primary', 'text-primary');
            b.classList.add('border-gray-300');
          });
          btn.classList.remove('border-gray-300');
          btn.classList.add('border-primary', 'text-primary');
          selectedFormat = btn.dataset.format;
        });
      });

      confirmReportBtn?.addEventListener('click', () => {
        if (!selectedFormat) {
          alert('Selecciona un formato antes de descargar.');
          return;
        }
        hideModal();
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-green-50 text-green-800 px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2';
        notification.innerHTML = '<i class="ri-checkbox-circle-line text-xl"></i><span>El reporte se está generando...</span>';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      });

      reportModal?.addEventListener('click', (event) => {
        if (event.target === reportModal) hideModal();
      });

      const mobileBtn = document.getElementById('mobileMenuBtn');
      const closeBtn = document.querySelector('#mobileMenu button');
      const overlay = document.getElementById('mobileMenuOverlay');

      function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        const overlayEl = document.getElementById('mobileMenuOverlay');
        if (menu && overlayEl) {
          menu.classList.toggle('translate-x-full');
          overlayEl.classList.toggle('hidden');
        }
      }

      mobileBtn?.addEventListener('click', toggleMobileMenu);
      closeBtn?.addEventListener('click', toggleMobileMenu);
      overlay?.addEventListener('click', toggleMobileMenu);

      const perfilBtn = document.getElementById('perfil-btn');
      const perfilMenu = document.getElementById('perfil-menu');
      perfilBtn?.addEventListener('click', (event) => {
        event.preventDefault();
        perfilMenu?.classList.toggle('hidden');
      });

      document.addEventListener('click', (event) => {
        if (perfilBtn && perfilMenu && !perfilBtn.contains(event.target) && !perfilMenu.contains(event.target)) {
          perfilMenu.classList.add('hidden');
        }
      });

      if (typeof window.reevaSetLanguage === 'function') {
        const currentLanguage = (window.reevaGetLanguage && window.reevaGetLanguage()) || 'es';
        window.reevaSetLanguage(currentLanguage);
      }

      window.reevaInitPersonalization?.();
      window.reevaInitLanguage?.();

      document.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-personalizacion-trigger]');
        if (trigger) {
          event.preventDefault();
          window.reevaInitPersonalization?.();
          window.reevaOpenPersonalizationPanel?.();
        }
      });
    });
  </script>
  <script>
    const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/box/`);

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const newStateText = data.new_state_text;
      if (!newStateText) return;
      if (newStateText === 'Finalizado' || newStateText === 'Paciente Ausente') {
        const ocupadosEl = document.querySelector('.occupied-count');
        const disponiblesEl = document.querySelector('.available-count');
        if (ocupadosEl && disponiblesEl) {
          const ocupados = parseInt(ocupadosEl.textContent, 10) || 0;
          const disponibles = parseInt(disponiblesEl.textContent, 10) || 0;
          if (newStateText === 'Finalizado') {
            ocupadosEl.textContent = Math.max(ocupados - 1, 0);
            disponiblesEl.textContent = disponibles + 1;
          }
          if (newStateText === 'Paciente Ausente') {
            ocupadosEl.textContent = ocupados + 1;
            disponiblesEl.textContent = Math.max(disponibles - 1, 0);
          }
        }
      }
    };

    socket.onclose = function() {
      console.warn('WebSocket cerrado inesperadamente');
    };
  </script>
  <script>
  (function() {
    'use strict';
    
    function getTranslation(key) {
      const lang = localStorage.getItem('reeva-language') || 'es';
      
      const translations = {
        es: {
          'chart.boxes': 'Boxes',
          'chart.schedules': 'agendas',
          'chart.scheduled': 'Agendadas',
          'chart.completed': 'Realizadas',
          'chart.hours': 'horas',
          'weekdays.monday': 'Lunes',
          'weekdays.tuesday': 'Martes',
          'weekdays.wednesday': 'Miércoles',
          'weekdays.thursday': 'Jueves',
          'weekdays.friday': 'Viernes',
          'weekdays.saturday': 'Sábado',
          'weekdays.sunday': 'Domingo',
          'periods.today': 'Hoy',
          'periods.week': 'Semana',
          'periods.month': 'Mes',
          'periods.year': 'Año',
          'dashboard.noDataPeriod': 'Sin datos en este período',
          'dashboard.noSchedules': 'No hay agendamientos registrados.',
          'dashboard.schedulesCount': 'agendas',
          'dashboard.ofPeriod': 'del período',
          'dashboard.timeOccupied': 'del tiempo ocupado',
          'dashboard.period': 'Período',
          'dashboard.all': 'Todos',
          'dashboard.allDoctors': '-- Todos los doctores --',
          'dashboard.selectBox': '-- Seleccione un box --',
          'dashboard.noDataSelectedPeriod': 'Sin datos para el período seleccionado.',
          'dashboard.allSpecialties': 'Todas',
          'dashboard.occupied': 'Ocupado',
          'dashboard.available': 'Disponible',
          'dashboard.disabled': 'Inhabilitado',
          'dashboard.notOccupied': 'No ocupado',
          'dashboard.notAvailable': 'No disponible',
          'dashboard.notDisabled': 'No inhabilitado',
          'months.january': 'Enero',
          'months.february': 'Febrero',
          'months.march': 'Marzo',
          'months.april': 'Abril',
          'months.may': 'Mayo',
          'months.june': 'Junio',
          'months.july': 'Julio',
          'months.august': 'Agosto',
          'months.september': 'Septiembre',
          'months.october': 'Octubre',
          'months.november': 'Noviembre',
          'months.december': 'Diciembre'
        },
        en: {
          'chart.boxes': 'Boxes',
          'chart.schedules': 'schedules',
          'chart.scheduled': 'Scheduled',
          'chart.completed': 'Completed',
          'chart.hours': 'hours',
          'weekdays.monday': 'Monday',
          'weekdays.tuesday': 'Tuesday',
          'weekdays.wednesday': 'Wednesday',
          'weekdays.thursday': 'Thursday',
          'weekdays.friday': 'Friday',
          'weekdays.saturday': 'Saturday',
          'weekdays.sunday': 'Sunday',
          'periods.today': 'Today',
          'periods.week': 'Week',
          'periods.month': 'Month',
          'periods.year': 'Year',
          'dashboard.noDataPeriod': 'No data in this period',
          'dashboard.noSchedules': 'No appointments registered.',
          'dashboard.schedulesCount': 'schedules',
          'dashboard.ofPeriod': 'of the period',
          'dashboard.timeOccupied': 'of time occupied',
          'dashboard.period': 'Period',
          'dashboard.all': 'All',
          'dashboard.allDoctors': '-- All doctors --',
          'dashboard.selectBox': '-- Select a box --',
          'dashboard.noDataSelectedPeriod': 'No data for the selected period.',
          'dashboard.allSpecialties': 'All',
          'dashboard.occupied': 'Occupied',
          'dashboard.available': 'Available',
          'dashboard.disabled': 'Disabled',
          'dashboard.notOccupied': 'Not occupied',
          'dashboard.notAvailable': 'Not available',
          'dashboard.notDisabled': 'Not disabled',
          'months.january': 'January',
          'months.february': 'February',
          'months.march': 'March',
          'months.april': 'April',
          'months.may': 'May',
          'months.june': 'June',
          'months.july': 'July',
          'months.august': 'August',
          'months.september': 'September',
          'months.october': 'October',
          'months.november': 'November',
          'months.december': 'December'
        }
      };
      
      return translations[lang]?.[key] || key;
    }
    
    function getWeekdayLabels() {
      return [
        getTranslation('weekdays.monday'),
        getTranslation('weekdays.tuesday'),
        getTranslation('weekdays.wednesday'),
        getTranslation('weekdays.thursday'),
        getTranslation('weekdays.friday'),
        getTranslation('weekdays.saturday'),
        getTranslation('weekdays.sunday')
      ];
    }
    
    function updatePeriodButtons() {
      const periodTranslations = {
        'day': getTranslation('periods.today'),
        'week': getTranslation('periods.week'),
        'month': getTranslation('periods.month'),
        'year': getTranslation('periods.year')
      };
      
      document.querySelectorAll('[data-box-period]').forEach(button => {
        const period = button.getAttribute('data-box-period');
        if (periodTranslations[period]) {
          button.textContent = periodTranslations[period];
        }
      });
      
      document.querySelectorAll('[data-specialty-period]').forEach(button => {
        const period = button.getAttribute('data-specialty-period');
        if (periodTranslations[period]) {
          button.textContent = periodTranslations[period];
        }
      });
    }
    
    function updatePeriodDescriptions() {
      const lang = localStorage.getItem('reeva-language') || 'es';
      
      const periodDescriptions = {
        es: {
          'day': 'Últimas 24 horas',
          'week': 'Últimos 7 días',
          'month': 'Últimos 30 días',
          'year': 'Últimos 12 meses'
        },
        en: {
          'day': 'Last 24 hours',
          'week': 'Last 7 days',
          'month': 'Last 30 days',
          'year': 'Last 12 months'
        }
      };
      
      const boxPeriodEl = document.getElementById('best-box-period');
      if (boxPeriodEl) {
        const boxPeriodValue = document.getElementById('box-period-value')?.value || 'week';
        const periodLabel = getTranslation('dashboard.period');
        const description = periodDescriptions[lang][boxPeriodValue] || '';
        boxPeriodEl.textContent = `${periodLabel}: ${description}`;
      }
      
      const specialtyPeriodEl = document.getElementById('best-specialty-period');
      if (specialtyPeriodEl) {
        const specialtyPeriodValue = document.getElementById('specialty-period-value')?.value || 'week';
        const periodLabel = getTranslation('dashboard.period');
        const description = periodDescriptions[lang][specialtyPeriodValue] || '';
        specialtyPeriodEl.textContent = `${periodLabel}: ${description}`;
      }
    }
    
    function translateSelects() {
      const yearSelect = document.getElementById('weekly-year');
      if (yearSelect) {
        const firstOption = yearSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = getTranslation('dashboard.all');
        }
      }
      
      const monthSelect = document.getElementById('weekly-month');
      if (monthSelect) {
        const firstOption = monthSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = getTranslation('dashboard.all');
        }
      }
      
      const profSelect = document.getElementById('prof_code');
      if (profSelect) {
        const firstOption = profSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = getTranslation('dashboard.allDoctors');
        }
      }
      
      const boxSelect = document.getElementById('box_number');
      if (boxSelect) {
        const firstOption = boxSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = getTranslation('dashboard.selectBox');
        }
      }
    }

    function updateBarChartLabels() {
      if (window.barChart) {
        window.barChart.data.labels = [
          getTranslation('chart.scheduled'),
          getTranslation('chart.completed')
        ];
        window.barChart.update('none');
      }
    }

    function updateWeeklyChartLabels() {
      if (window.applyWeeklyData) {
        const currentSpecialty = document.getElementById('especialidad')?.value || 'Todas';
        window.applyWeeklyData(currentSpecialty);
      }
    }

    function updateDonutLabels() {
      const donutLabels = document.querySelectorAll('[id^="donut-"] + p');
      const labelMap = {
        'Ocupado': 'dashboard.occupied',
        'Disponible': 'dashboard.available',
        'Inhabilitado': 'dashboard.disabled',
        'Occupied': 'dashboard.occupied',
        'Available': 'dashboard.available',
        'Disabled': 'dashboard.disabled'
      };
      
      donutLabels.forEach(label => {
        const currentText = label.textContent.trim();
        const translationKey = labelMap[currentText];
        if (translationKey) {
          label.textContent = getTranslation(translationKey);
        }
      });
    }

    function updateSpecialtySelectors() {
      const specialtyTrendSelect = document.getElementById('specialty-trend-select');
      if (specialtyTrendSelect) {
        Array.from(specialtyTrendSelect.options).forEach(option => {
          if (option.value === 'Todas' || option.value === 'All') {
            option.textContent = getTranslation('dashboard.allSpecialties');
          }
        });
      }

      const weeklySpecialtySelect = document.getElementById('especialidad');
      if (weeklySpecialtySelect) {
        Array.from(weeklySpecialtySelect.options).forEach(option => {
          if (option.value === 'Todas' || option.value === 'All') {
            option.textContent = getTranslation('dashboard.allSpecialties');
          }
        });
      }
    }
    
    window.dashboardI18n = {
      translate: getTranslation,
      getWeekdayLabels: getWeekdayLabels,
      updatePeriodButtons: updatePeriodButtons,
      updatePeriodDescriptions: updatePeriodDescriptions,
      translateSelects: translateSelects,
      updateBarChartLabels: updateBarChartLabels,
      updateWeeklyChartLabels: updateWeeklyChartLabels,
      updateDonutLabels: updateDonutLabels,
      updateSpecialtySelectors: updateSpecialtySelectors
    };

    updatePeriodButtons();
    updatePeriodDescriptions();
    translateSelects();
    updateBarChartLabels();
    updateDonutLabels();
    updateSpecialtySelectors();

    document.body.classList.add('translations-ready');

    document.addEventListener('reeva:language-change', function() {
      updatePeriodButtons();
      updatePeriodDescriptions();
      translateSelects();
      updateBarChartLabels();
      updateWeeklyChartLabels();
      updateDonutLabels();
      updateSpecialtySelectors();
    });
  })();
  </script>
</body>
</html>
