<!DOCTYPE html>
<html lang="<%= userLang || 'es' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="agenda.title"><%= __("agenda.title") %></title>
  
  <%
    // FunciÃ³n para singularizar palabras
    const singularizar = (palabra) => {
      if (!palabra || typeof palabra !== 'string') return palabra;
      if (palabra.length > 4 && palabra.toLowerCase().endsWith('es')) {
        const ultimaLetraAntes = palabra.charAt(palabra.length - 3).toLowerCase();
        const vocales = ['a', 'e', 'i', 'o', 'u'];
        if (!vocales.includes(ultimaLetraAntes)) {
          return palabra.slice(0, -2);
        }
      }
      if (palabra.toLowerCase().endsWith('s') && !palabra.toLowerCase().endsWith('es')) {
        return palabra.slice(0, -1);
      }
      return palabra;
    };
  %>
  
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#9c4d9e',
            secondary: '#57b5e7'
          },
          borderRadius: {
            'button': '8px'
          },
          fontFamily: {
            'sans': ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/agenda.css" />
</head>
<body class="font-sans">
  <%- include('header') %>
  <main class="container mx-auto px-4 py-6">
    <% if (messages && messages.length > 0) { %>
      <div class="mb-4">
        <% messages.forEach(message => { %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-2"><%= message %></div>
        <% }) %>
      </div>
    <% } %>
    
    <!-- Seleccion de mesa -->
    <div class="flex flex-col sm:flex-row gap-4 mb-8 sm:items-end sm:justify-between items-start">
      <div class="max-w-xs">
        <label for="box_number" class="block text-sm font-medium mb-2 text-gray-700">
          <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'Mesa' %>
        </label>
        <select id="box_number" name="box_number"
                class="border-2 border-gray-300 rounded-lg px-4 py-2 pr-10 focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 bg-white font-medium text-gray-800 cursor-pointer transition-all duration-200 hover:border-gray-400">
          <option value="">
            Selecciona <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa' %>
          </option>
          <% mesas.forEach(m => { %>
            <option value="<%= m.id %>" 
                    <%= (mesa && String(m.id) === String(mesa.id)) ? 'selected' : '' %>>
              <%= m.nombre %> - <%= m.pasilloNombre %>
            </option>
          <% }) %>
        </select>
      </div>
      
      <!-- Boton habilitar/inhabilitar que baja en mÃ³viles pequeÃ±os pero mantiene su tamaÃ±o -->
      <% if (mesa) { %>
        <button id="toggleMantBtn"
          class="<% if (disabled) { %>bg-green-600 hover:bg-green-700<% } else { %>bg-red-600 hover:bg-red-700<% } %> text-white px-6 py-3 rounded-button flex items-center gap-2 transition-all duration-200 shadow-md hover:shadow-lg"
          onclick="openMantModal()">
          <% if (disabled) { %>
            <i class="ri-play-circle-line text-lg"></i>
            <span>Habilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa' %></span>
          <% } else { %>
            <i class="ri-stop-circle-line text-lg"></i>
            <span>Inhabilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa' %></span>
          <% } %>
        </button>
      <% } %>
    </div>
    
    <!-- Modal Agregar Evento -->
    <div id="eventoModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm hidden overflow-auto p-4">
      <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-4 shadow-xl">
        <h3 class="text-2xl font-medium text-center mb-8">Agregar Evento</h3>
        <div id="timeRangeInfo" class="hidden mb-4 p-3 rounded bg-blue-50 text-blue-700 text-sm border border-blue-200">
          <i class="ri-information-line"></i>
          <span data-i18n="agenda.loadingTimeInfo"><%= __("agenda.loadingTimeInfo") %></span>
        </div>
        <form id="eventoForm" method="post" action="/add_evento/<%= mesa.id %>" class="space-y-6">
          <div id="addError" class="hidden mb-4 p-3 rounded bg-red-50 text-red-700 text-sm border border-red-200"></div>
          <div>
            <label class="block text-sm text-gray-600 mb-2"><%= singularizar(parametrizacionLabels?.nivel2Plural) || 'Mesa' %></label>
            <input type="text" name="mesa_id" class="w-full border rounded p-2 bg-gray-100" readonly value="<%= mesa.nombre %>"/>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-2"><%= singularizar(parametrizacionLabels?.nivel1Plural) || 'Sala' %></label>
            <input type="text" class="w-full border rounded p-2 bg-gray-100" readonly value="<%= mesa.pasilloNombre %>"/>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-2"><%= parametrizacionLabels?.nivel2Singular || 'Ocupante' %></label>
            <select id="profesionalSelect" name="usuario_id" class="w-full border rounded p-2" required>
              <option value="" disabled selected>Selecciona <%= parametrizacionLabels?.nivel2Singular || 'ocupante' %></option>
              <% (ocupantes_normalizados || []).forEach(ocupante => { %>
                <option value="<%= ocupante.id %>"><%= ocupante.nombre %></option>
              <% }) %>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.startTimeLabel"><%= __("agenda.startTimeLabel") %></label>
              <input type="time" name="horainicio" min="08:00" max="19:00" class="w-full border rounded p-2" required />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.endTimeLabel"><%= __("agenda.endTimeLabel") %></label>
              <input type="time" name="horafin" min="08:00" max="19:00" class="w-full border rounded p-2" required />
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.dateLabel"><%= __("agenda.dateLabel") %></label>
            <input type="date" name="fecha" value="<%= fechaSeleccionada %>" class="w-full border rounded p-2" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.notesLabel"><%= __("agenda.notesLabel") %></label>
            <textarea name="observaciones" rows="4" class="w-full border rounded p-2"></textarea>
          </div>
          <div class="flex justify-between">
            <button type="button" onclick="cancelEventoCreation()" class="px-6 py-2 bg-gray-400 text-white rounded hover:bg-gray-500" data-i18n="agenda.cancelBtn"><%= __("agenda.cancelBtn") %></button>
            <button type="submit" id="addEventoBtn" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/90" data-i18n="agenda.addBtn"><%= __("agenda.addBtn") %></button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Modal Inhabilitar/Habilitar -->
    <div id="mantModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm hidden overflow-auto p-4">
      <div class="bg-white rounded-2xl p-8 w-full max-w-md mx-4 shadow-xl">
        <h3 class="text-2xl font-medium text-center mb-6">
          <% if (disabled) { %>
            <span>Habilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa' %></span>
          <% } else { %>
            <span>Inhabilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa' %></span>
          <% } %>
        </h3>
        <p class="text-center text-gray-600 mb-6">
          <% 
            const nivel2Name = singularizar(parametrizacionLabels?.nivel2Plural) || 'mesa';
            const esFemenino = nivel2Name.toLowerCase().endsWith('a');
            const articulo = esFemenino ? 'esta' : 'este';
          %>
          <% if (disabled) { %>
            <span>Â¿EstÃ¡ seguro que desea habilitar <%= articulo %> <%= nivel2Name %>?</span>
          <% } else { %>
            <span>Â¿EstÃ¡ seguro que desea inhabilitar <%= articulo %> <%= nivel2Name %>?</span>
          <% } %>
        </p>
        <form id="mantForm" class="space-y-4">
          <div id="mantError" class="hidden mb-4 p-3 rounded bg-red-50 text-red-700 text-sm border border-red-200"></div>
          <div class="flex justify-between">
            <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeMantModal()" data-i18n="agenda.cancelBtn"><%= __("agenda.cancelBtn") %></button>
            <button type="submit" id="mantSubmitBtn" class="px-6 py-2 <%= disabled ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700' %> text-white rounded">
              <span data-i18n="<%= disabled ? 'agenda.confirmEnable' : 'agenda.confirmDisable' %>">
                <%= disabled ? __("agenda.confirmEnable") : __("agenda.confirmDisable") %>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Modal Editar -->
    <div id="editEventoModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-500 bg-opacity-70 backdrop-blur-sm hidden overflow-auto p-4">
      <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-4 shadow-xl relative">
        <button type="button" onclick="document.getElementById('editEventoModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-light leading-none"><i class="ri-close-line"></i></button>
        <h3 class="text-2xl font-medium text-center mb-8" data-i18n="agenda.editEventTitle"><%= __("agenda.editEventTitle") %></h3>
        <form id="editEventoForm" method="post" action="">
          <input type="hidden" name="evento_id" id="editEventoId" />
          <div id="editError" class="hidden mb-6 p-3 rounded bg-red-50 text-red-700 text-sm border border-red-200"></div>
          <div class="mb-6">
            <label class="block text-sm text-gray-600 mb-2"><%= parametrizacionLabels?.nivel3Plural || 'Profesionales' %></label>
            <select id="editProfesionalSelect" name="usuario_id" class="w-full border rounded p-2" required>
              <option value="" disabled selected>Selecciona <%= singularizar(parametrizacionLabels?.nivel3Plural) || 'profesional' %></option>
              <% (ocupantes_normalizados || []).forEach(ocupante => { %>
                <option value="<%= ocupante.id %>"><%= ocupante.nombre %></option>
              <% }) %>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div><label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.startTimeLabel"><%= __("agenda.startTimeLabel") %></label><input type="time" name="horainicio" id="editHoraInicio" class="w-full border rounded p-2" required /></div>
            <div><label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.endTimeLabel"><%= __("agenda.endTimeLabel") %></label><input type="time" name="horafin" id="editHoraFin" class="w-full border rounded p-2" required /></div>
          </div>
          <div class="mb-6"><label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.dateLabel"><%= __("agenda.dateLabel") %></label><input type="date" name="fecha" id="editFecha" class="w-full border rounded p-2" required /></div>
          <div class="mb-6"><label class="block text-sm text-gray-600 mb-2" data-i18n="agenda.notesLabel"><%= __("agenda.notesLabel") %></label><textarea name="observaciones" id="editObservaciones" rows="4" class="w-full border rounded p-2"></textarea></div>
          <div class="flex justify-between gap-3">
            <button type="button" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700" id="deleteEventoBtn" data-i18n="agenda.deleteBtn"><%= __("agenda.deleteBtn") %></button>
            <button type="submit" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/90" data-i18n="agenda.saveChanges"><%= __("agenda.saveChanges") %></button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Calendario -->
    <section class="bg-white rounded-lg shadow-sm mt-6 md:mt-8 p-4 md:p-6">
      <div class="mb-4 md:mb-6"><h2 class="text-xl md:text-2xl font-semibold text-gray-800" data-i18n="agenda.mainTitle"><%= __("agenda.mainTitle") %></h2></div>
      
      <!-- Banner instructivo -->
      <div id="instructionBanner" class="mb-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg relative overflow-hidden">
        <div class="flex items-center justify-between p-4 cursor-pointer" id="bannerHeader">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0"><div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center"><i class="ri-question-line text-primary text-sm"></i></div></div>
            <div>
              <h4 class="text-sm font-medium text-gray-900" data-i18n="agenda.helpTitle"><%= __("agenda.helpTitle") %></h4>
              <p class="text-xs text-gray-500" data-i18n="agenda.helpSubtitle"><%= __("agenda.helpSubtitle") %></p>
            </div>
          </div>
          <button id="toggleBanner" class="text-gray-400 hover:text-gray-600 transition-all duration-200 transform hover:scale-110">
            <i id="bannerIcon" class="ri-arrow-down-s-line text-lg transition-transform duration-200"></i>
          </button>
        </div>
        <div id="bannerContent" class="px-4 pb-4 max-h-0 overflow-hidden transition-all duration-300">
          <div class="border-t border-purple-200 pt-3">
            <div class="space-y-3">
              <div><h5 class="text-sm font-medium text-gray-900" data-i18n="agenda.createConsultation"><%= __("agenda.createConsultation") %></h5><p class="text-sm text-gray-600"><span class="mx-2">â€¢</span><span class="font-medium text-primary" data-i18n="agenda.clickToCreate"><%= __("agenda.clickToCreate") %></span></p></div>
              <div><h5 class="text-sm font-medium text-gray-900" data-i18n="agenda.editConsultation"><%= __("agenda.editConsultation") %></h5><p class="text-sm text-gray-600"><span class="mx-2">â€¢</span><span class="font-medium text-primary" data-i18n="agenda.clickToEdit"><%= __("agenda.clickToEdit") %></span></p></div>
            </div>
          </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-purple-200 to-blue-200 opacity-40"><div class="h-full bg-gradient-to-r from-purple-500 to-blue-500 animate-pulse-slow"></div></div>
      </div>
      
      <div id="calendar" class="w-full min-h-[600px] md:min-h-[700px] overflow-auto"></div>
    </section>
  </main>
  
  <%- include('footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const chartEl = document.getElementById('estadoChart');
  if (chartEl && typeof echarts !== 'undefined') {
    const chart = echarts.init(chartEl);
    chart.setOption({
      animation: false,
      series: [{
        type: 'pie',
        radius: ['60%', '80%'],
        label: { show: true, position: 'center', formatter: '{c}%', fontSize: 24, fontWeight: 'bold' },
        data: [
          { value: <%= pct_ocupado || 0 %>, name: 'Ocupado', itemStyle: { color: '#4ade80' } },
          { value: <%= pct_libre || 0 %>,   name: 'Libre',   itemStyle: { color: '#e2f8e9' } }
        ]
      }]
    });
    window.addEventListener('resize', () => chart.resize());
  }
});
</script>

<script>
  const modal = document.getElementById('eventoModal');
  modal.addEventListener('click', e => {
    if (e.target === modal) modal.classList.add('hidden');
  });
</script>

<script>
  const mantModal = document.getElementById('mantModal');
  function openMantModal() { mantModal.classList.remove('hidden'); }
  function closeMantModal() { mantModal.classList.add('hidden'); }
  mantModal.addEventListener('click', e => {
    if (e.target === mantModal) closeMantModal();
  });
</script>

<script>
// Cambiar automÃ¡ticamente la mesa cuando se selecciona en el dropdown
document.addEventListener('DOMContentLoaded', function() {
  const boxNumberSelect = document.getElementById('box_number');
  if (boxNumberSelect) {
    boxNumberSelect.addEventListener('change', function(e) {
      const mesaId = this.value;
      if (mesaId) {
        // Navegar a la nueva mesa
        window.location.href = `/agenda?box_number=${encodeURIComponent(mesaId)}`;
      }
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const eventoModal = document.getElementById('eventoModal');
  const mantModal   = document.getElementById('mantModal');
  
  window.openEventoModal = function()  { if (eventoModal) eventoModal.classList.remove('hidden'); }
  window.closeEventoModal = function() { if (eventoModal) eventoModal.classList.add('hidden'); }
  window.openMantModal = function()    { if (mantModal) mantModal.classList.remove('hidden'); }
  window.closeMantModal = function()   { if (mantModal) mantModal.classList.add('hidden'); }
  
  if (eventoModal) {
    eventoModal.addEventListener('click', e => {
      if (e.target === eventoModal) window.closeEventoModal();
    });
  }
  
  if (mantModal) {
    mantModal.addEventListener('click', e => {
      if (e.target === mantModal) window.closeMantModal();
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejador del formulario de mantenimiento (Habilitar/Inhabilitar)
  const mantForm = document.getElementById('mantForm');
  if (mantForm) {
    mantForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const mesaId = '<%= mesa.id %>';
      const mantSubmitBtn = document.getElementById('mantSubmitBtn');
      const mantError = document.getElementById('mantError');
      const toggleMantBtn = document.getElementById('toggleMantBtn');
      
      // Limpiar errores previos
      if (mantError) {
        mantError.classList.add('hidden');
        mantError.textContent = '';
      }
      
      try {
        mantSubmitBtn.disabled = true;
        
        const response = await fetch(`/toggle_mantenimiento/${mesaId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.ok) {
          throw new Error(data.error || 'Error al actualizar el estado');
        }
        
        // Cerrar el modal
        window.closeMantModal();
        
        // Actualizar el botÃ³n dinÃ¡micamente
        if (toggleMantBtn) {
          const isNowDisabled = data.nuevo_estado === 4;
          
          // Limpiar clases anteriores completamente
          toggleMantBtn.className = 'text-white px-6 py-3 rounded-button mt-6 flex items-center gap-2 transition-all duration-200 shadow-md hover:shadow-lg';
          
          // Agregar las nuevas clases segÃºn el estado
          if (isNowDisabled) {
            // Estado: Inhabilitado -> mostrar "Habilitar" (verde)
            toggleMantBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            toggleMantBtn.innerHTML = '<i class="ri-play-circle-line text-lg"></i><span>Habilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || "mesa" %></span>';
          } else {
            // Estado: Habilitado -> mostrar "Inhabilitar" (rojo)
            toggleMantBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            toggleMantBtn.innerHTML = '<i class="ri-stop-circle-line text-lg"></i><span>Inhabilitar <%= singularizar(parametrizacionLabels?.nivel2Plural) || "mesa" %></span>';
          }
        }
        
        console.log('âœ… Estado actualizado correctamente');
        
      } catch (error) {
        console.error('Error:', error);
        if (mantError) {
          mantError.classList.remove('hidden');
          mantError.textContent = error.message || 'Error al actualizar el estado';
        }
      } finally {
        mantSubmitBtn.disabled = false;
      }
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const eventos = <%- eventos_json || '[]' %>;
  const userLang = '<%= userLang || "es" %>';
  const fechaSeleccionada = '<%= fechaSeleccionada %>';
  
  // Textos traducidos
  const texts = {
    today: userLang === 'en' ? 'Today' : 'Hoy',
    month: userLang === 'en' ? 'Month' : 'Mes',
    week: userLang === 'en' ? 'Week' : 'Semana',
    day: userLang === 'en' ? 'Day' : 'DÃ­a',
    allDay: userLang === 'en' ? 'all-day' : 'todo el dÃ­a'
  };
  
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridDay',
    initialDate: fechaSeleccionada || new Date(),
    locale: userLang === 'en' ? 'en' : 'es',
    timeZone: 'local',
    height: 'auto',
    contentHeight: 600,
    aspectRatio: 1.2,
    nowIndicator: true,
    
    // Formato de hora para eventos
    eventTimeFormat: {
      hour: 'numeric',
      minute: '2-digit',
      meridiem: userLang === 'en' ? 'short' : false,
      hour12: userLang === 'en'
    },
    
    // Formato de hora para las etiquetas del eje (8:00, 9:00, etc.)
    slotLabelFormat: {
      hour: 'numeric',
      minute: '2-digit',
      meridiem: userLang === 'en' ? 'short' : false,
      hour12: userLang === 'en'
    },
    
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    buttonText: {
      today: texts.today,
      month: texts.month,
      week: texts.week,
      day: texts.day
    },
    allDayText: texts.allDay,
    events: eventos,
    slotMinHeight: 30,
    slotDuration: '00:05:00',
    snapDuration: '00:01:00',
    slotLabelInterval: '00:30:00',
    slotMinTime: '08:00:00',
    slotMaxTime: '19:00:00',
    selectable: true,
    selectMirror: false,
    selectOverlap: false,
    unselectAuto: false,
    
    dateClick: function(info) {
      console.log('=== CLICK EN CALENDARIO ===');
      console.log('Fecha click:', info.date);
      
      const bloqueCompleto = detectarBloqueLibreCompleto(info.date);
      console.log('Bloque detectado:', bloqueCompleto);
      
      if (bloqueCompleto) {
        console.log('DuraciÃ³n del bloque:', (new Date(bloqueCompleto.end) - new Date(bloqueCompleto.start)) / 60000, 'minutos');
        
        const bloqueKey = `${bloqueCompleto.start}_${bloqueCompleto.end}`;
        const currentBloqueKey = currentBloqueInfo ? `${currentBloqueInfo.start}_${currentBloqueInfo.end}` : null;
        
        if (!currentPlaceholder || bloqueKey !== currentBloqueKey) {
          createCustomPlaceholder(bloqueCompleto, info.date);
        }
        
        openEventoModalWithTime(bloqueCompleto.start, bloqueCompleto.end);
        updateTimeRestrictions(bloqueCompleto);
      }
    },
    
    select: function(selectionInfo) {
      openEventoModalWithTime(selectionInfo.start, selectionInfo.end);
      calendar.unselect();
    },
    
    eventClick: function(info) {
      if (info.event.classNames.includes('custom-placeholder')) {
        const originalBlock = info.event.extendedProps.originalBlock;
        if (originalBlock) {
          openEventoModalWithTime(originalBlock.start, originalBlock.end);
          updateTimeRestrictions(originalBlock);
        }
        return;
      }
      
      openEditEventoModal(info.event);
    },
    
    eventDidMount: function() {
      setTimeout(markEmptySlots, 100);
    },
    
    viewDidMount: function() {
      setTimeout(markEmptySlots, 100);
    },
    
    datesSet: function() {
      setTimeout(markEmptySlots, 100);
    }
  });
  
  window.__calendar = calendar;
  calendar.render();
  calendarEl.style.visibility = 'visible';
  calendarEl.style.opacity = '1';
  calendarEl.style.minHeight = '700px';
  
  function markEmptySlots() {
    document.querySelectorAll('.fc-timegrid-slot.empty-slot, .fc-timegrid-slot.empty-block').forEach(slot => {
      slot.classList.remove('empty-slot', 'empty-block');
      slot.removeAttribute('data-block-id');
      slot.removeAttribute('data-block-size');
      slot.removeAttribute('data-is-first');
      slot.removeAttribute('data-is-last');
    });
    
    const dayColumns = document.querySelectorAll('.fc-timegrid-col');
    
    dayColumns.forEach((column, columnIndex) => {
      const slots = column.querySelectorAll('.fc-timegrid-slot');
      const emptyBlocks = [];
      let currentBlock = [];
      
      slots.forEach((slot, index) => {
        const hasEvent = slot.querySelector('.fc-event, .fc-event-main');
        if (!hasEvent) {
          slot.classList.add('empty-slot');
          currentBlock.push(slot);
        } else {
          if (currentBlock.length > 0) {
            emptyBlocks.push([...currentBlock]);
            currentBlock = [];
          }
        }
      });
      
      if (currentBlock.length > 0) {
        emptyBlocks.push(currentBlock);
      }
      
      emptyBlocks.forEach((block, blockIndex) => {
        block.forEach((slot, slotIndex) => {
          slot.classList.add('empty-block');
          slot.setAttribute('data-block-id', `${columnIndex}-${blockIndex}`);
          slot.setAttribute('data-block-size', block.length);
          slot.setAttribute('data-is-first', slotIndex === 0 ? 'true' : 'false');
          slot.setAttribute('data-is-last', slotIndex === block.length - 1 ? 'true' : 'false');
        });
      });
    });
  }
});
</script>

<script>
  const ocupantes = <%- JSON.stringify(ocupantes_normalizados || []) %>;
  const userLang = '<%= userLang || "es" %>';
  console.log('OCUPANTES desde servidor:', ocupantes);
  const profesionalSelect = document.getElementById('profesionalSelect');
  
  const selectProfPlaceholder = userLang === 'en' ? 'Select professional' : 'â€” Selecciona ocupante â€”';
  
  function fillProfesionalSelect(selectEl) {
    if (!selectEl) return;
    selectEl.innerHTML = `<option value="" disabled selected>${selectProfPlaceholder}</option>`;
    ocupantes.forEach(function(ocupante) {
      const opt = document.createElement('option');
      opt.value = ocupante.id;
      opt.textContent = ocupante.nombre || ('Ocupante ' + ocupante.id);
      selectEl.appendChild(opt);
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    try {
      fillProfesionalSelect(profesionalSelect);
      fillProfesionalSelect(editProfesionalSelect);
    } catch (e) { console.warn('Error rellenando selects de ocupantes', e); }
  });
</script>

<script>
const editEventoModal = document.getElementById('editEventoModal');
const editEventoForm = document.getElementById('editEventoForm');
const editProfesionalSelect = document.getElementById('editProfesionalSelect');
function pad(num) {
  return num.toString().padStart(2, '0');
}
function toLocalTimeString(dateObj) {
  return pad(dateObj.getHours()) + ':' + pad(dateObj.getMinutes());
}
function openEditEventoModal(evento) {
  const err = document.getElementById('editError');
  if (err) {
    err.textContent = '';
    err.classList.add('hidden');
  }
  
  const ocupanteActual = ocupantes.find(o => o.id == evento.extendedProps.usuario_id);
  
  if (ocupanteActual) {
    editProfesionalSelect.value = ocupanteActual.id;
  } else {
    editProfesionalSelect.value = "";
  }
  
  document.getElementById('editEventoId').value = evento.id;
  document.getElementById('editHoraInicio').value = toLocalTimeString(evento.start);
  document.getElementById('editHoraFin').value = toLocalTimeString(evento.end);
  document.getElementById('editFecha').value = evento.start.toISOString().slice(0,10);
  
  document.getElementById('editObservaciones').value = evento.extendedProps.observaciones || '';
  editEventoForm.action = `/editar_evento/${evento.id}`;
  editEventoModal.classList.remove('hidden');
}

editEventoModal.addEventListener('click', e => {
  if (e.target === editEventoModal) editEventoModal.classList.add('hidden');
});

document.getElementById('deleteEventoBtn').onclick = async function() {
  const eventoId = document.getElementById('editEventoId').value;
  const confirmMsg = userLang === 'en' 
    ? 'Are you sure you want to delete this event?' 
    : 'Â¿Seguro que quieres eliminar este evento?';
  if (confirm(confirmMsg)) {
    try {
      const resp = await fetch(`/eliminar_evento/${eventoId}`, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (resp.ok) {
        editEventoModal.classList.add('hidden');
        await refreshCalendarEvents();
      } else {
        const errorMsg = userLang === 'en' ? 'Error deleting event' : 'Error al eliminar el evento';
        alert(errorMsg);
      }
    } catch (error) {
      console.error('Error eliminando evento:', error);
      const errorMsg = userLang === 'en' ? 'Error deleting event' : 'Error al eliminar el evento';
      alert(errorMsg);
    }
  }
};
</script>

<script>
  // Los ocupantes se cargan directamente sin filtro de especialidad
</script>

<script>
async function refreshCalendarEvents() {
  try {
    const sel = document.getElementById('box_number');
    const boxId = sel && sel.value ? sel.value : '';
    const url = boxId ? `/agenda/events?box_number=${encodeURIComponent(boxId)}` : `/agenda/events`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) return;
    const data = await resp.json();
    if (window.__calendar && Array.isArray(data)) {
      window.__calendar.batchRendering(() => {
        window.__calendar.removeAllEvents();
        data.forEach(ev => window.__calendar.addEvent(ev));
      });
    }
  } catch (_) { }
}
</script>

<script>
const eventoForm = document.getElementById('eventoForm');
if (eventoForm) {
  eventoForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const errorBox = document.getElementById('addError');
    if (errorBox) { errorBox.classList.add('hidden'); errorBox.textContent = ''; }
    const addBtn = document.getElementById('addEventoBtn');
    const prevLabel = addBtn ? addBtn.textContent : '';
    const addingText = userLang === 'en' ? 'Addingâ€¦' : 'Agregandoâ€¦';
    if (addBtn) { addBtn.disabled = true; addBtn.textContent = addingText; }
    const formData = new FormData(eventoForm);
    const params = new URLSearchParams();
    for (const pair of formData.entries()) params.append(pair[0], pair[1]);
    const url = eventoForm.action;
    try {
      const resp = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() });
      const isJson = resp.headers.get('content-type')?.includes('application/json');
      if (isJson) {
        const data = await resp.json();
        if (data.ok) {
          await refreshCalendarEvents();
          if (addBtn) { addBtn.disabled = false; addBtn.textContent = prevLabel; }
          eventoModal.classList.add('hidden');
          eventoForm.reset();
          return;
        } else {
          const errorMsg = data.error || (userLang === 'en' ? 'Error creating event.' : 'Error al crear el evento.');
          if (errorBox) { errorBox.textContent = errorMsg; errorBox.classList.remove('hidden'); }
        }
      } else {
        window.location.reload();
      }
    } catch (err) {
      const networkError = userLang === 'en' ? 'Network error. Please try again.' : 'Error de red. Intenta nuevamente.';
      if (errorBox) { errorBox.textContent = networkError; errorBox.classList.remove('hidden'); }
    } finally {
      if (addBtn) { addBtn.disabled = false; addBtn.textContent = prevLabel; }
    }
  });
}
</script>

<script>
editEventoForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const errorBox = document.getElementById('editError');
  errorBox.classList.add('hidden');
  errorBox.textContent = '';
  const formData = new FormData(editEventoForm);
  const params = new URLSearchParams();
  for (const pair of formData.entries()) params.append(pair[0], pair[1]);
  const url = editEventoForm.action;
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: params.toString()
    });
    const isJson = resp.headers.get('content-type')?.includes('application/json');
    if (isJson) {
      const data = await resp.json();
      if (!data.ok) {
        const errorMsg = data.error || (userLang === 'en' ? 'Could not save.' : 'No se pudo guardar.');
        errorBox.textContent = errorMsg;
        errorBox.classList.remove('hidden');
        return;
      }
      await refreshCalendarEvents();
      editEventoModal.classList.add('hidden');
      return;
    }
    window.location.reload();
  } catch (err) {
    const networkError = userLang === 'en' ? 'Network error. Please try again.' : 'Error de red. Intenta nuevamente.';
    errorBox.textContent = networkError;
    errorBox.classList.remove('hidden');
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const timeErrorMsg = userLang === 'en' 
    ? 'Time must be between 08:00 and 19:00' 
    : 'La hora debe estar entre 08:00 y 19:00';
  const orderErrorMsg = userLang === 'en'
    ? 'End time must be after start time'
    : 'La hora de fin debe ser posterior a la hora de inicio';
  const alertMsg = userLang === 'en'
    ? 'Please verify that times are between 08:00 and 19:00 and that the end time is after the start time'
    : 'Por favor, verifique que las horas estÃ©n entre 08:00 y 19:00 y que la hora de fin sea posterior a la de inicio';
  
  function validateTimeRange(timeInput) {
    const timeValue = timeInput.value;
    if (timeValue) {
      const [hours, minutes] = timeValue.split(':').map(Number);
      const timeInMinutes = hours * 60 + minutes;
      const minTime = 8 * 60;
      const maxTime = 19 * 60;
      
      if (timeInMinutes < minTime || timeInMinutes > maxTime) {
        timeInput.setCustomValidity(timeErrorMsg);
        return false;
      } else {
        timeInput.setCustomValidity('');
        return true;
      }
    }
    return true;
  }
  
  function validateTimeOrder(startInput, endInput) {
    if (startInput.value && endInput.value) {
      const startTime = startInput.value.split(':').map(Number);
      const endTime = endInput.value.split(':').map(Number);
      const startMinutes = startTime[0] * 60 + startTime[1];
      const endMinutes = endTime[0] * 60 + endTime[1];
      
      if (endMinutes <= startMinutes) {
        endInput.setCustomValidity(orderErrorMsg);
        return false;
      } else {
        endInput.setCustomValidity('');
        return true;
      }
    }
    return true;
  }
  
  const timeInputs = document.querySelectorAll('input[type="time"]');
  timeInputs.forEach(input => {
    input.addEventListener('change', function() {
      validateTimeRange(this);
      
      const form = this.closest('form');
      if (form) {
        const startInput = form.querySelector('input[name="horainicio"]');
        const endInput = form.querySelector('input[name="horafin"]');
        if (startInput && endInput) {
          validateTimeOrder(startInput, endInput);
        }
      }
    });
    
    input.addEventListener('blur', function() {
      validateTimeRange(this);
    });
  });
  
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const formTimeInputs = form.querySelectorAll('input[type="time"]');
      const startInput = form.querySelector('input[name="horainicio"]');
      const endInput = form.querySelector('input[name="horafin"]');
      let isValid = true;
      
      formTimeInputs.forEach(input => {
        if (!validateTimeRange(input)) {
          isValid = false;
        }
      });
      
      if (startInput && endInput && !validateTimeOrder(startInput, endInput)) {
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
        alert(alertMsg);
      }
    });
  });
});

function showSelectedBlock(fechaStart, fechaEnd) {
  document.querySelectorAll('.fc-timegrid-slot.block-selected').forEach(slot => {
    slot.classList.remove('block-selected');
  });
  
  const slots = document.querySelectorAll('.fc-timegrid-body .fc-timegrid-slot');
  slots.forEach(slot => {
    const slotTime = getSlotTime(slot);
    if (slotTime && slotTime >= fechaStart && slotTime < fechaEnd) {
      slot.classList.add('block-selected');
    }
  });
  
  setTimeout(() => {
    document.querySelectorAll('.fc-timegrid-slot.block-selected').forEach(slot => {
      slot.classList.remove('block-selected');
    });
  }, 3000);
}

function getSlotTime(slot) {
  const timeText = slot.closest('.fc-timegrid-col')?.querySelector('.fc-timegrid-axis-cushion')?.textContent;
  if (!timeText) return null;
  
  const today = new Date();
  const [hours, minutes] = timeText.split(':').map(Number);
  return new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours || 0, minutes || 0);
}

function detectarBloqueLibreCompleto(fechaClick) {
  if (!window.__calendar) return null;
  
  const fechaClickDate = new Date(fechaClick);
  const diaClick = fechaClickDate.toDateString();
  
  const eventosDelDia = window.__calendar.getEvents().filter(evento => {
    return evento.start && evento.start.toDateString() === diaClick;
  });
  
  eventosDelDia.sort((a, b) => a.start.getTime() - b.start.getTime());
  
  const inicioJornada = new Date(fechaClickDate);
  inicioJornada.setHours(8, 0, 0, 0);
  
  const finJornada = new Date(fechaClickDate);
  finJornada.setHours(19, 0, 0, 0);
  
  const bloquesOcupados = eventosDelDia.map(evento => ({
    start: new Date(evento.start),
    end: new Date(evento.end)
  }));
  
  let inicioBloque = inicioJornada;
  
  for (let i = 0; i < bloquesOcupados.length; i++) {
    const bloqueActual = bloquesOcupados[i];
    
    if (fechaClick >= inicioBloque && fechaClick < bloqueActual.start) {
      return {
        start: inicioBloque,
        end: bloqueActual.start
      };
    }
    
    inicioBloque = bloqueActual.end;
  }
  
  if (fechaClick >= inicioBloque && fechaClick <= finJornada) {
    return {
      start: inicioBloque,
      end: finJornada
    };
  }
  
  if (bloquesOcupados.length === 0) {
    return {
      start: inicioJornada,
      end: finJornada
    };
  }
  
  return null;
}

let currentPlaceholder = null;
let lastSelectedStartTime = null;
let lastSelectedEndTime = null;
let currentBloqueInfo = null;

function formatDuration(start, end) {
  const duration = (new Date(end) - new Date(start)) / 60000;
  const hours = Math.floor(duration / 60);
  const minutes = duration % 60;
  
  const availableText = userLang === 'en' ? 'available' : 'disponible';
  
  if (hours > 0) {
    return minutes > 0 ? `${hours}h ${minutes}m ${availableText}` : `${hours}h ${availableText}`;
  } else {
    return `${minutes}m ${availableText}`;
  }
}

function createCustomPlaceholder(bloqueInfo, fechaClick) {
  if (!bloqueInfo) return;
  
  removeCustomPlaceholder();
  
  const calendar = window.__calendar;
  const newEventText = userLang === 'en' ? 'New event' : 'Nuevo evento';
  
  currentPlaceholder = {
    id: 'placeholder-' + Date.now(),
    title: `ðŸ“… ${newEventText} (${formatDuration(bloqueInfo.start, bloqueInfo.end)})`,
    start: new Date(bloqueInfo.start),
    end: new Date(bloqueInfo.end),
    backgroundColor: '#3b82f6',
    borderColor: '#1d4ed8',
    textColor: '#ffffff',
    classNames: ['custom-placeholder'],
    editable: false,
    display: 'auto',
    overlap: true,
    constraint: false,
    extendedProps: {
      isPlaceholder: true,
      originalBlock: bloqueInfo
    }
  };
  
  calendar.addEvent(currentPlaceholder);
  
  setTimeout(() => {
    const eventElement = calendar.getEventById(currentPlaceholder.id);
    if (eventElement) {
      eventElement.setStart(new Date(bloqueInfo.start));
      eventElement.setEnd(new Date(bloqueInfo.end));
      calendar.render();
    }
  }, 50);
  
  console.log('Placeholder creado ocupando todo el bloque:', {
    start: bloqueInfo.start,
    end: bloqueInfo.end,
    duration: (new Date(bloqueInfo.end) - new Date(bloqueInfo.start)) / 60000 + ' minutos'
  });
}

function removeCustomPlaceholder() {
  if (currentPlaceholder && window.__calendar) {
    const event = window.__calendar.getEventById(currentPlaceholder.id);
    if (event) {
      event.remove();
      console.log('Placeholder removido:', currentPlaceholder.id);
    }
    currentPlaceholder = null;
  }
}

function updatePlaceholderDuration(startTime, duration) {
  if (!currentPlaceholder) {
    console.log('No hay placeholder actual para actualizar');
    return;
  }
  
  const calendarInstance = window.__calendar;
  const eventInstance = calendarInstance.getEventById(currentPlaceholder.id);
  
  if (eventInstance && startTime && duration > 0) {
    const startDate = new Date(startTime);
    const endDate = new Date(startDate.getTime() + (duration * 60000));
    
    console.log('Actualizando placeholder:', {
      startTime: startDate.toISOString(),
      endTime: endDate.toISOString(),
      duration: duration + ' minutos'
    });
    
    eventInstance.remove();
    
    const hours = Math.floor(duration / 60);
    const minutes = duration % 60;
    let durationText = '';
    if (hours > 0) {
      durationText = `${hours}h`;
      if (minutes > 0) durationText += ` ${minutes}m`;
    } else {
      durationText = `${minutes}m`;
    }
    
    const selectedText = userLang === 'en' ? 'selected' : 'seleccionado';
    const newEventText = userLang === 'en' ? 'New event' : 'Nuevo evento';
    const newTitle = `ðŸ“… ${newEventText} (${durationText} ${selectedText})`;
    
    currentPlaceholder = {
      id: 'placeholder-' + Date.now(),
      title: newTitle,
      start: startDate,
      end: endDate,
      backgroundColor: '#3b82f6',
      borderColor: '#1d4ed8',
      textColor: '#ffffff',
      classNames: ['custom-placeholder'],
      editable: false,
      display: 'auto',
      overlap: true,
      constraint: false,
      extendedProps: {
        isPlaceholder: true,
        originalBlock: currentPlaceholder.extendedProps.originalBlock
      }
    };
    
    calendarInstance.addEvent(currentPlaceholder);
    
    setTimeout(() => {
      calendarInstance.render();
    }, 10);
    
    console.log('Placeholder recreado exitosamente con nuevo tamaÃ±o');
  } else {
    console.log('Error: no se pudo actualizar placeholder', {
      eventInstance: !!eventInstance,
      startTime: startTime,
      duration: duration
    });
  }
}

function updateTimeRestrictions(bloqueInfo) {
  const startTimeInput = document.querySelector('input[name="horainicio"]');
  const endTimeInput = document.querySelector('input[name="horafin"]');
  
  if (!startTimeInput || !endTimeInput || !bloqueInfo) return;
  
  currentBloqueInfo = bloqueInfo;
  
  const formatTimeForInput = (date) => {
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  };
  
  const minTime = formatTimeForInput(new Date(bloqueInfo.start));
  const maxTime = formatTimeForInput(new Date(bloqueInfo.end));
  
  startTimeInput.min = minTime;
  startTimeInput.max = maxTime;
  endTimeInput.min = minTime;
  endTimeInput.max = maxTime;
  
  const specificStartTime = formatTimeForInput(new Date(bloqueInfo.start));
  const specificEndTime = formatTimeForInput(new Date(bloqueInfo.end));
  
  let useStartTime = specificStartTime;
  let useEndTime = specificEndTime;
  let valuesRestored = false;
  
  if (lastSelectedStartTime && lastSelectedEndTime && 
      lastSelectedStartTime >= minTime && lastSelectedStartTime <= maxTime &&
      lastSelectedEndTime >= minTime && lastSelectedEndTime <= maxTime) {
    useStartTime = lastSelectedStartTime;
    useEndTime = lastSelectedEndTime;
    valuesRestored = true;
    console.log('Restaurando valores guardados:', useStartTime, '-', useEndTime);
  }
  
  if (!startTimeInput.value || valuesRestored) startTimeInput.value = useStartTime;
  if (!endTimeInput.value || valuesRestored) endTimeInput.value = useEndTime;
  
  lastSelectedStartTime = startTimeInput.value;
  lastSelectedEndTime = endTimeInput.value;
  
  const currentStartTime = startTimeInput.value;
  const currentEndTime = endTimeInput.value;
  
  if (currentStartTime && currentEndTime) {
    const [startHours, startMinutes] = currentStartTime.split(':').map(Number);
    const [endHours, endMinutes] = currentEndTime.split(':').map(Number);
    
    const selectedDate = new Date(bloqueInfo.start);
    selectedDate.setHours(0, 0, 0, 0);
    
    const actualStartDate = new Date(selectedDate);
    actualStartDate.setHours(startHours, startMinutes);
    
    const actualEndDate = new Date(selectedDate);
    actualEndDate.setHours(endHours, endMinutes);
    
    const currentDuration = (actualEndDate - actualStartDate) / 60000;
    if (currentDuration > 0) {
      setTimeout(() => {
        updatePlaceholderDuration(actualStartDate, currentDuration);
        console.log('Placeholder ajustado a valores del formulario:', currentStartTime, '-', currentEndTime);
      }, 50);
    }
  }
  
  const existingStartHandler = startTimeInput._changeHandler;
  const existingEndHandler = endTimeInput._changeHandler;
  
  if (existingStartHandler) {
    startTimeInput.removeEventListener('change', existingStartHandler);
  }
  if (existingEndHandler) {
    endTimeInput.removeEventListener('change', existingEndHandler);
  }
  
  const startTimeHandler = function() {
    const selectedTime = this.value;
    const endTime = endTimeInput.value;
    
    lastSelectedStartTime = selectedTime;
    lastSelectedEndTime = endTime;
    
    if (selectedTime && endTime) {
      const [startHours, startMinutes] = selectedTime.split(':').map(Number);
      const [endHours, endMinutes] = endTime.split(':').map(Number);
      
      const selectedDate = new Date(bloqueInfo.start);
      selectedDate.setHours(0, 0, 0, 0);
      
      const startDate = new Date(selectedDate);
      startDate.setHours(startHours, startMinutes);
      
      const endDate = new Date(selectedDate);
      endDate.setHours(endHours, endMinutes);
      
      const duration = (endDate - startDate) / 60000;
      
      if (duration > 0) {
        updatePlaceholderDuration(startDate, duration);
        console.log('Placeholder actualizado por cambio manual de hora inicio:', duration, 'minutos');
      }
    }
  };
  
  const endTimeHandler = function() {
    const startTime = startTimeInput.value;
    const selectedEndTime = this.value;
    
    lastSelectedStartTime = startTime;
    lastSelectedEndTime = selectedEndTime;
    
    if (startTime && selectedEndTime) {
      const [startHours, startMinutes] = startTime.split(':').map(Number);
      const [endHours, endMinutes] = selectedEndTime.split(':').map(Number);
      
      const selectedDate = new Date(bloqueInfo.start);
      selectedDate.setHours(0, 0, 0, 0);
      
      const startDate = new Date(selectedDate);
      startDate.setHours(startHours, startMinutes);
      
      const endDate = new Date(selectedDate);
      endDate.setHours(endHours, endMinutes);
      
      const duration = (endDate - startDate) / 60000;
      
      if (duration > 0) {
        updatePlaceholderDuration(startDate, duration);
        console.log('Placeholder actualizado por cambio manual de hora fin:', duration, 'minutos');
      }
    }
  };
  
  startTimeInput.addEventListener('change', startTimeHandler);
  endTimeInput.addEventListener('change', endTimeHandler);
  
  startTimeInput._changeHandler = startTimeHandler;
  endTimeInput._changeHandler = endTimeHandler;
  
  console.log('Restricciones de tiempo establecidas:', {
    min: minTime,
    max: maxTime
  });
}

function openEventoModalWithTime(fechaStart, fechaEnd) {
  console.log('=== openEventoModalWithTime LLAMADA ===', fechaStart, fechaEnd);
  
  const err = document.getElementById('addError');
  if (err) {
    err.textContent = '';
    err.classList.add('hidden');
  }
  
  const tiempoStart = formatTimeForInput(fechaStart);
  const tiempoEnd = formatTimeForInput(fechaEnd);
  const dateStr = formatDateForInput(fechaStart);
  
  setSelectedTimeRango(fechaStart, fechaEnd);
  showSelectedBlock(fechaStart, fechaEnd);
  
  const duracionMinutos = (fechaEnd.getTime() - fechaStart.getTime()) / (1000 * 60);
  const horas = Math.floor(duracionMinutos / 60);
  const minutos = duracionMinutos % 60;
  
  let duracionTexto = '';
  if (horas > 0 && minutos > 0) {
    duracionTexto = `${horas}h ${minutos}min`;
  } else if (horas > 0) {
    duracionTexto = `${horas}h`;
  } else {
    duracionTexto = `${minutos}min`;
  }
  
  console.log('Valores calculados:', {
    tiempoStart,
    tiempoEnd,
    duracionTexto,
    duracionMinutos
  });
  
  const horaInicioInput = document.querySelector('input[name="horainicio"]');
  const horaFinInput = document.querySelector('input[name="horafin"]');
  horaInicioInput.value = tiempoStart;
  horaFinInput.value = tiempoEnd;
  document.querySelector('input[name="fecha"]').value = dateStr;
  
  const infoDiv = document.getElementById('timeRangeInfo');
  if (infoDiv) {
    const infoSpan = infoDiv.querySelector('span');
    if (infoSpan) {
      const availableText = userLang === 'en' ? 'free' : 'libres';
      const selectText = userLang === 'en' ? 'Select the specific range you need.' : 'Selecciona el rango especÃ­fico que necesites.';
      const scheduleText = userLang === 'en' ? 'Available schedule' : 'Horario disponible';
      const mensaje = `${scheduleText}: ${tiempoStart} - ${tiempoEnd} (${duracionTexto} ${availableText}). ${selectText}`;
      infoSpan.textContent = mensaje;
      console.log('Mensaje actualizado:', mensaje);
    } else {
      console.log('ERROR: No se encontrÃ³ el span dentro de timeRangeInfo');
    }
    infoDiv.classList.remove('hidden');
  } else {
    console.log('ERROR: No se encontrÃ³ el div timeRangeInfo');
  }
  
  openEventoModal();
}

function formatTimeForInput(fecha) {
  const horas = fecha.getHours().toString().padStart(2, '0');
  const minutos = fecha.getMinutes().toString().padStart(2, '0');
  return `${horas}:${minutos}`;
}

function formatDateForInput(fecha){
  const aÃ±o = fecha.getFullYear();
  const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
  const dia = fecha.getDate().toString().padStart(2, '0');
  return `${aÃ±o}-${mes}-${dia}`;
}

let selectedTimeRango = null;

function setSelectedTimeRango(start, end){
  selectedTimeRango = {
    start: formatTimeForInput(start),
    end: formatTimeForInput(end)
  };
}

function cancelEventoCreation() {
  closeEventoModal();
  removeCustomPlaceholder();
  lastSelectedStartTime = null;
  lastSelectedEndTime = null;
  currentBloqueInfo = null;
  console.log('CreaciÃ³n de evento cancelada - placeholder removido y valores limpiados');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const banner = document.getElementById('instructionBanner');
  const toggleBanner = document.getElementById('toggleBanner');
  const bannerHeader = document.getElementById('bannerHeader');
  const bannerContent = document.getElementById('bannerContent');
  const bannerIcon = document.getElementById('bannerIcon');
  
  let isExpanded = false;
  const bannerKey = 'calendarHelp_agenda_expanded';
  
  const savedState = localStorage.getItem(bannerKey);
  if (savedState === 'true') {
    expandBanner();
  }
  
  if (bannerHeader && toggleBanner) {
    bannerHeader.addEventListener('click', toggleBannerState);
    toggleBanner.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleBannerState();
    });
  }
  
  function toggleBannerState() {
    if (isExpanded) {
      collapseBanner();
    } else {
      expandBanner();
    }
  }
  
  function expandBanner() {
    if (!bannerContent || !bannerIcon) return;
    
    isExpanded = true;
    bannerContent.style.maxHeight = bannerContent.scrollHeight + 'px';
    bannerIcon.style.transform = 'rotate(180deg)';
    localStorage.setItem(bannerKey, 'true');
  }
  
  function collapseBanner() {
    if (!bannerContent || !bannerIcon) return;
    
    isExpanded = false;
    bannerContent.style.maxHeight = '0';
    bannerIcon.style.transform = 'rotate(0deg)';
    localStorage.setItem(bannerKey, 'false');
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const userLang = '<%= userLang || "es" %>';
  const boxSelect = document.getElementById('box_number');
  
  if (!boxSelect) {
    return;
  }
  
  const specialtyTranslations = {
    'en': {
      'CirugÃ­a': 'Surgery',
      'DermatologÃ­a': 'Dermatology',
      'GinecologÃ­a': 'Gynecology',
      'OdontologÃ­a': 'Dentistry',
      'OftalmologÃ­a': 'Ophthalmology',
      'PediatrÃ­a': 'Pediatrics',
      'General': 'General',
      'MÃ©dico General': 'General Practitioner',
      'Cirujano': 'Surgeon',
      'GinecÃ³logo': 'Gynecologist',
      'OdontÃ³logo': 'Dentist',
      'OftalmÃ³logo': 'Ophthalmologist',
      'DermatÃ³logo': 'Dermatologist',
      'Pediatra': 'Pediatrician'
    },
    'es': {
      'Surgery': 'CirugÃ­a',
      'Dermatology': 'DermatologÃ­a',
      'Gynecology': 'GinecologÃ­a',
      'Dentistry': 'OdontologÃ­a',
      'Ophthalmology': 'OftalmologÃ­a',
      'Pediatrics': 'PediatrÃ­a',
      'General': 'General',
      'General Practitioner': 'MÃ©dico General',
      'Surgeon': 'Cirujano',
      'Gynecologist': 'GinecÃ³logo',
      'Dentist': 'OdontÃ³logo',
      'Ophthalmologist': 'OftalmÃ³logo',
      'Dermatologist': 'DermatÃ³logo',
      'Pediatrician': 'Pediatra'
    }
  };
  
  function translateSpecialty(specialtyName) {
    if (!specialtyName) return '';
    
    if (userLang === 'es') {
      return specialtyTranslations.es[specialtyName] || specialtyName;
    }
    
    if (userLang === 'en') {
      return specialtyTranslations.en[specialtyName] || specialtyName;
    }
    
    return specialtyName;
  }
  
  let translatedCount = 0;
  Array.from(boxSelect.options).forEach((option, index) => {
    if (index === 0 || !option.value) {
      return;
    }
    
    const currentText = option.textContent.trim();
    console.log(`Procesando opciÃ³n ${index}:`, currentText);
    
    const match = currentText.match(/^Box\s+(\d+)\s*-\s*(.+)$/i);
    
    if (match) {
      const boxNumber = match[1];
      const originalSpecialty = match[2].trim();
      const translatedSpecialty = translateSpecialty(originalSpecialty);

      option.textContent = `Box ${boxNumber} - ${translatedSpecialty}`;
  
      translatedCount++;
    }
  });    
});
</script>

<!-- websocket client -->
<script>
(function() {
  const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${wsProto}://${window.location.host}`);
  
  ws.onopen = () => {
    console.log('âœ“ agenda websocket conectado');
  };
  
  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      console.log('âœ“ agenda websocket mensaje recibido:', data);
      console.log(`âœ“ cambio en box ${data.box_id}: ${data.new_state_text} (action: ${data.action})`);
      
      // recargar si hay cambios (el usuario verÃ¡ los cambios en el calendario)
      console.log('âœ“ recargando calendario en 500ms...');
      const fecha = fechaSeleccionada || '';
      const fechaParam = fecha ? `?fecha=${encodeURIComponent(fecha)}` : '';
      setTimeout(() => window.location.href = `/agenda${fechaParam}`, 500);
    } catch (err) {
      console.error('âŒ error parseando mensaje websocket:', err);
    }
  };
  
  ws.onerror = (err) => {
    console.error('âŒ error websocket:', err);
  };
  
  ws.onclose = () => {
    console.log('âš  websocket desconectado, reconectando en 3s...');
    setTimeout(() => window.location.reload(), 3000);
  };
})();
</script>

</body>
</html>