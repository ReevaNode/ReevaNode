<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/login.css" /> 
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <img src="/images/reeva.png" alt="Hospital" class="logo-hospital" />
      <h1>Bienvenido a Reeva</h1>
      <p>Configura tu empresa a tu manera: personaliza nombres, espacios y mucho más.</p>
    </div>

    <div class="right-panel">
      <div class="login-box">
        <img src="/images/reeva.png" alt="Reeva" class="logo-reeva" />
        <div class="login-header">
          <span>Iniciar sesión</span>
        </div>

        <!-- FORMULARIO -->
        <form id="loginForm">
          <% if (error && error.length > 0) { %>
            <p style="color:red;"><%= error[0] %></p>
          <% } %>
          <div class="input_box">
            <input type="text" id="username" name="username" class="input-field" required />
            <label for="username" class="label">Email</label>
            <i class="bx bx-user icon"></i>
          </div>

          <div class="input_box">
            <input type="password" id="password" name="password" class="input-field" required />
            <label for="password" class="label">Contraseña</label>
            <i class="bx bx-hide password-toggle" id="togglePassword"></i>
          </div>

          <div class="remember-forgot">
            <div class="checkbox-container">
              <input type="checkbox" id="remember" name="remember" />
              <label for="remember">Recuérdame</label>
            </div>
            <div class="forgot-password">
              <a href="#">¿Olvidaste tu contraseña?</a>
            </div>
          </div>

          <button type="submit" class="input-submit" id="loginBtn">
            Iniciar sesión
          </button>
        </form>

        <!-- MENSAJE DE ERROR -->
        <p id="errorMsg" style="color: red; display: none; margin-top: 1rem;"></p>
      </div>
    </div>
  </div>

  <script>
    // Mostrar/Ocultar contraseña
    const toggleIcon = document.getElementById("togglePassword");
    const passwordInput = document.getElementById("password");
    toggleIcon.onclick = () => {
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        toggleIcon.classList.replace("bx-hide", "bx-show");
      } else {
        passwordInput.type = "password";
        toggleIcon.classList.replace("bx-show", "bx-hide");
      }
    };

    // Manejo del login con spinner
    const form = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");
    const btn = document.getElementById("loginBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Mostrar estado de carga en el botón
      btn.disabled = true;
      btn.classList.add("loading");
      btn.innerHTML = "Iniciando... <span class='spinner'></span>";

      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();

        if (data.ok) {
          localStorage.setItem("idToken", data.idToken);
          localStorage.setItem("accessToken", data.accessToken);
          localStorage.setItem("refreshToken", data.refreshToken);

          // Obtener conteo de empresas para decidir a dónde redirigir
          try {
            const empresasRes = await fetch("/api/empresas/count", {
              method: "GET",
              headers: { "Content-Type": "application/json" }
            });
            const empresasData = await empresasRes.json();

            if (empresasData.success && empresasData.count >= 2) {
              // Si tiene 2+ empresas, ir a seleccionar-empresa
              window.location.href = "/seleccionar-empresa";
            } else {
              // Si tiene 0 o 1 empresa, ir a bienvenida
              window.location.href = "/bienvenida";
            }
          } catch (err) {
            console.error("Error al obtener empresas:", err);
            // Por seguridad, si falla, ir a bienvenida
            window.location.href = "/bienvenida";
          }
        } else {
          errorMsg.textContent = data.error || "Error al iniciar sesión";
          errorMsg.style.display = "block";

          // Restaurar botón
          btn.disabled = false;
          btn.classList.remove("loading");
          btn.textContent = "Iniciar sesión";
        }
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Error de conexión con el servidor";
        errorMsg.style.display = "block";

        // Restaurar botón
        btn.disabled = false;
        btn.classList.remove("loading");
        btn.textContent = "Iniciar sesión";
      }
    });
  </script>

  <script>
    // Bloquear retroceso del navegador en login
    (function() {
      let historyPushed = false;
      
      // Empujar estado al historial para detectar retroceso
      if (!historyPushed) {
        window.history.pushState({ type: 'login' }, null, window.location.href);
        historyPushed = true;
      }
      
      // Escuchar evento de retroceso
      window.addEventListener('popstate', function(e) {
        // Si intenta retroceder desde login, volver a empujar estado para quedarse en la página
        window.history.pushState({ type: 'login' }, null, window.location.href);
      });

      // Verificar si hay sesión activa al cargar (evitar acceso directo a /login si ya está autenticado)
      document.addEventListener('DOMContentLoaded', function() {
        fetch('/auth/check-session', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
          if (data.authenticated && data.user) {
            // Si ya está autenticado, redirigir según cantidad de empresas
            if (data.countEmpresas >= 2) {
              window.location.href = '/seleccionar-empresa';
            } else {
              window.location.href = '/bienvenida';
            }
          }
        })
        .catch(err => console.error('Error verificando sesión:', err));
      });
    })();
  </script>
</body>
</html>
