service: reeva-dynamo

frameworkVersion: '3.40.0'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, env:STAGE, 'dev'}
  # usando LABROLE para AWS Academy (ya tiene todos los permisos)
  role: ${env:LABROLE}
  environment:
    AGENDA_TABLE: agenda
    BOX_TABLE: box
    ESTADO_BOX_TABLE: estadobox
    ITEMS_TABLE: items
    PERSONALIZACION_TABLE: personalizacion
    REGISTRO_AGENDA_TABLE: registroagenda
    TIPO_BOX_TABLE: tipobox
    TIPO_CONSULTA_TABLE: tipoconsulta
    TIPO_ESTADO_TABLE: tipoestado
    TIPO_ITEM_TABLE: tipoitem
    TIPO_PROFESIONAL_TABLE: tipoprofesional
    TIPO_USUARIO_TABLE: tipousuario
    USUARIO_TABLE: usuario

package:
  patterns:
    - '!README.md'
    - '!node_modules/.bin/**'
    - '!package-lock.json'

functions:
  # ===== Poblar catálogos =====
  seedTipoProfesional:
    handler: src/tipos/profesionales.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_PROFESIONAL_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-profesional

  seedTipoUsuario:
    handler: src/tipos/usuarios.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_USUARIO_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-usuario

  seedTipoConsulta:
    handler: src/tipos/consultas.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_CONSULTA_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-consulta

  seedTipoEstado:
    handler: src/tipos/estados.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_ESTADO_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-estado

  seedTipoBox:
    handler: src/tipos/box.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_BOX_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-box

  seedPersonalizacion:
    handler: src/personalizacion/seed.seed
    environment:
      TABLE_NAME: ${self:provider.environment.PERSONALIZACION_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/personalizacion

  seedEstadoBox:
    handler: src/estadobox/seed.seed
    environment:
      TABLE_NAME: ${self:provider.environment.ESTADO_BOX_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/estado-box

  seedTipoItem:
    handler: src/tipoitem/seed.seed
    environment:
      TABLE_NAME: ${self:provider.environment.TIPO_ITEM_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/tipo-item

  # ===== Poblar entidades principales =====
  seedUsuarios:
    handler: src/usuarios/seed.handler
    environment:
      TABLE_NAME: ${self:provider.environment.USUARIO_TABLE}
      PERSONALIZACION_TABLE: ${self:provider.environment.PERSONALIZACION_TABLE}
      TIPO_USUARIO_TABLE: ${self:provider.environment.TIPO_USUARIO_TABLE}
      TIPO_PROFESIONAL_TABLE: ${self:provider.environment.TIPO_PROFESIONAL_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/usuarios

  seedAgenda:
    handler: src/agenda/seed.handler
    environment:
      TABLE_NAME: ${self:provider.environment.AGENDA_TABLE}
      REGISTRO_AGENDA_TABLE: ${self:provider.environment.REGISTRO_AGENDA_TABLE}
      BOX_TABLE: ${self:provider.environment.BOX_TABLE}
      USUARIO_TABLE: ${self:provider.environment.USUARIO_TABLE}
      TIPO_CONSULTA_TABLE: ${self:provider.environment.TIPO_CONSULTA_TABLE}
      TIPO_ESTADO_TABLE: ${self:provider.environment.TIPO_ESTADO_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/agenda

  seedAgenda2025:
    handler: src/agenda/seed2025.handler
    environment:
      TABLE_NAME: ${self:provider.environment.AGENDA_TABLE}
      BOX_TABLE: ${self:provider.environment.BOX_TABLE}
      USUARIO_TABLE: ${self:provider.environment.USUARIO_TABLE}
      TIPO_CONSULTA_TABLE: ${self:provider.environment.TIPO_CONSULTA_TABLE}
      TIPO_ESTADO_TABLE: ${self:provider.environment.TIPO_ESTADO_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/agenda-2025

  seedBox:
    handler: src/box/seed.seed
    environment:
      TABLE_NAME: ${self:provider.environment.BOX_TABLE}
      ESTADO_BOX_TABLE: ${self:provider.environment.ESTADO_BOX_TABLE}
      TIPO_BOX_TABLE: ${self:provider.environment.TIPO_BOX_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/box

  seedItems:
    handler: src/items/seed.seed
    environment:
      TABLE_NAME: ${self:provider.environment.ITEMS_TABLE}
      BOX_TABLE: ${self:provider.environment.BOX_TABLE}
      TIPO_ITEM_TABLE: ${self:provider.environment.TIPO_ITEM_TABLE}
    events:
      - httpApi:
          method: POST
          path: /seed/items

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  dotenv:
    path: ../.env

resources:
  Resources:
    # Catálogo tables
    TipoProfesionalTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipoprofesional
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoProfesional
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoProfesional
            KeyType: HASH

    TipoUsuarioTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipousuario
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoUsuario
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoUsuario
            KeyType: HASH

    TipoConsultaTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipoconsulta
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoConsulta
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoConsulta
            KeyType: HASH

    TipoEstadoTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipoestado
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoEstado
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoEstado
            KeyType: HASH

    TipoBoxTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipobox
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoBox
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoBox
            KeyType: HASH

    TipoItemTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: tipoitem
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idTipoItem
            AttributeType: S
        KeySchema:
          - AttributeName: idTipoItem
            KeyType: HASH

    PersonalizacionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: personalizacion
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idPersonalizacion
            AttributeType: S
        KeySchema:
          - AttributeName: idPersonalizacion
            KeyType: HASH

    EstadoBoxTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: estadobox
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idEstadoBox
            AttributeType: S
        KeySchema:
          - AttributeName: idEstadoBox
            KeyType: HASH

    # Main entity tables
    UsuarioTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: usuario
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idUsuario
            AttributeType: S
        KeySchema:
          - AttributeName: idUsuario
            KeyType: HASH

    BoxTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: box
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idBox
            AttributeType: S
        KeySchema:
          - AttributeName: idBox
            KeyType: HASH

    ItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: items
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idItem
            AttributeType: S
        KeySchema:
          - AttributeName: idItem
            KeyType: HASH

    AgendaTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: agenda
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idAgenda
            AttributeType: S
          - AttributeName: horainicio
            AttributeType: S
          - AttributeName: idUsuario
            AttributeType: S
        KeySchema:
          - AttributeName: idAgenda
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: HoraInicioIndex
            KeySchema:
              - AttributeName: horainicio
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: UsuarioIndex
            KeySchema:
              - AttributeName: idUsuario
                KeyType: HASH
              - AttributeName: horainicio
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    RegistroAgendaTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: registroagenda
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: idRegistroAgenda
            AttributeType: S
        KeySchema:
          - AttributeName: idRegistroAgenda
            KeyType: HASH
