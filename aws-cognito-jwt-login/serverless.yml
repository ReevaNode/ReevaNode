service: aws-cognito-jwt-login
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  # === IAM ROLE STATEMENTS ===
  # Define permisos específicos para los Lambdas (Least Privilege)
  # role: ${env:LABROLE}
  iamRoleStatements:
    # COGNITO: Permisos para autenticación y gestión de usuarios
    - Effect: Allow
      Action:
        - cognito-idp:AdminGetUser              # Obtener info de usuario
        - cognito-idp:AdminSetUserAttributes    # Actualizar atributos
        - cognito-idp:ListUsers                 # Listar usuarios (admin)
        - cognito-idp:AdminUpdateUserAttributes # Actualizar atributos como admin
        - cognito-idp:SignUp                    # NUEVO: Permitir registro (signup)
        - cognito-idp:AdminConfirmSignUp        # NUEVO: Confirmar usuario automáticamente
      Resource: !GetAtt CognitoUserPool.Arn
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem      
        - dynamodb:PutItem      
        - dynamodb:UpdateItem   
        - dynamodb:Query        
        - dynamodb:Scan         
      Resource: 
        - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/users"                 
        - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/parameters-new"         
  environment:
    USER_POOL_ID: { Ref: CognitoUserPool }         
    USER_POOL_CLIENT_ID: { Ref: CognitoUserPoolClient }  
    
    USER_TABLE: users                             
    PARAMETERS_TABLE: parameters-new                
  logs:
    httpApi: true
  
  # === HTTP API: Configuración de API Gateway ===
  httpApi:
    # CORS: Cross-Origin Resource Sharing
    # SEGURIDAD: En PRODUCCIÓN cambiar '*' por dominios específicos
    # Ej: allowedOrigins: ['https://miapp.com', 'https://www.miapp.com']
    cors:
      allowedOrigins:
        - '*'                    # TODO: Cambiar a dominios específicos en prod
      allowedHeaders:
        - Content-Type           
        - Authorization          
        - X-Amz-Date             
        - X-Api-Key              
        - X-Amz-Security-Token   
      allowedMethods:
        - GET                    
        - POST                   
        - PUT                   
        - DELETE                 
        - OPTIONS                
      allowCredentials: false    
      maxAge: 3600              
    
    authorizers:
      cognitoJwt:
        type: jwt                
        identitySource: $request.header.Authorization  
        issuerUrl:
          !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}"
        audience:
          - !Ref CognitoUserPoolClient

functions:
  login:
    handler: src/handlers/login.login
    events:
      - httpApi:
          method: POST
          path: /auth/login

  signup:
    handler: src/handlers/signup.signup
    events:
      - httpApi:
          method: POST
          path: /auth/signup

  refresh:
    handler: src/handlers/refresh.refresh
    events:
      - httpApi:
          method: POST
          path: /auth/refresh

  me:
    handler: src/handlers/me.me
    events:
      - httpApi:
          method: GET
          path: /me
          authorizer:
            name: cognitoJwt      
  
  getAuthInfo:
    handler: src/handlers/permission.getAuthInfo
    events:
      - httpApi:
          method: GET
          path: /auth/info
          authorizer:
            name: cognitoJwt

  getPermissions:
    handler: src/handlers/permission.getPermissions
    events:
      - httpApi:
          method: GET
          path: /auth/permissions

  getRoles:
    handler: src/handlers/permission.getRoles
    events:
      - httpApi:
          method: GET
          path: /auth/roles

  assignRole:
    handler: src/handlers/permission.assignRole
    events:
      - httpApi:
          method: POST
          path: /admin/assign-role
          authorizer:
            name: cognitoJwt

  removeRole:
    handler: src/handlers/permission.removeRole
    events:
      - httpApi:
          method: POST
          path: /admin/remove-role
          authorizer:
            name: cognitoJwt

  listUsers:
    handler: src/handlers/permission.listUsers
    events:
      - httpApi:
          method: GET
          path: /admin/users
          authorizer:
            name: cognitoJwt
  
  getPersonalization:
    handler: src/handlers/personalization.getPersonalization
    events:
      - httpApi:
          method: GET
          path: /personalization
          authorizer:
            name: cognitoJwt

  updatePersonalization:
    handler: src/handlers/personalization.updatePersonalization
    events:
      - httpApi:
          method: PUT
          path: /personalization
          authorizer:
            name: cognitoJwt

  deletePersonalization:
    handler: src/handlers/personalization.deletePersonalization
    events:
      - httpApi:
          method: DELETE
          path: /personalization
          authorizer:
            name: cognitoJwt

  # === PARAMETRIZACIÓN DE EMPRESAS ===
  guardarParametrizacion:
    handler: src/handlers/parametrizacion.guardarParametrizacion
    events:
      - httpApi:
          method: POST
          path: /parametrizacion/guardar
          authorizer:
            name: cognitoJwt

  obtenerParametrizacion:
    handler: src/handlers/parametrizacion.obtenerParametrizacion
    events:
      - httpApi:
          method: GET
          path: /parametrizacion/{empresaId}/{grupoId}
          authorizer:
            name: cognitoJwt

  actualizarParametrizacion:
    handler: src/handlers/parametrizacion.actualizarParametrizacion
    events:
      - httpApi:
          method: PUT
          path: /parametrizacion/{empresaId}/{grupoId}
          authorizer:
            name: cognitoJwt

  listarEmpresas:
    handler: src/handlers/parametrizacion.listarEmpresas
    events:
      - httpApi:
          method: GET
          path: /parametrizacion/empresas
          authorizer:
            name: cognitoJwt

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  dotenv:
    path: ./.env

package:
  individually: true
  patterns:
    - '!**/*.md'
    - '!**/*.test.*'
    - '!node_modules/**'
    - '!.git/**'

resources:
  Resources:
    # === COGNITO USER POOL ===
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-pool
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        VerificationMessageTemplate:
          DefaultEmailOption: CONFIRM_WITH_CODE
          EmailMessage: 'Tu código de verificación es {####}'
          EmailSubject: 'Código de verificación'

    # === COGNITO USER POOL CLIENT ===
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${sls:stage}-app
        GenerateSecret: false
        UserPoolId: { Ref: CognitoUserPool }
        PreventUserExistenceErrors: ENABLED
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        AccessTokenValidity: 5    
        IdTokenValidity: 5          
        RefreshTokenValidity: 30  
        TokenValidityUnits:
          AccessToken: minutes
          IdToken: minutes
          RefreshToken: days
        ReadAttributes:
          - email
          - email_verified
        WriteAttributes:
          - email

  # === OUTPUTS ===
  Outputs:
    UserPoolId:
      Description: 'Cognito User Pool ID'
      Value: { Ref: CognitoUserPool }
      Export:
        Name: ${self:service}-${sls:stage}-UserPoolId

    UserPoolClientId:
      Description: 'Cognito User Pool Client ID'
      Value: { Ref: CognitoUserPoolClient }
      Export:
        Name: ${self:service}-${sls:stage}-UserPoolClientId

    ApiEndpoint:
      Description: 'API Gateway Endpoint URL'
      Value:
        Fn::Sub: 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
      Export:
        Name: ${self:service}-${sls:stage}-ApiEndpoint
